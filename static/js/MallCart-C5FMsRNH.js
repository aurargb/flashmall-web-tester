import{_ as z,y as q,w as K,E as B,F as p,G as u,H as i,O as y,Q as f,I as P,J as G,N as S,aH as de,Z as U,$ as X,x as A,B as D,K as J,X as R,P as d,a1 as te,R as Be,bf as Se,l as _e,be as oe,bM as Ae,r as j,z as De,D as Me,bj as $e,T as se,n as Ee}from"./vendor-BlU_hoYl.js";import{_ as Fe}from"./mall-C69gPh5W.js";import{O as Le}from"./OrderGoods-BQbKo4MD.js";import{_ as Ne}from"./MCOIN-BOqZVkND.js";import{c as ne,d as H,a7 as Re,e as qe,r as Oe,bC as Ve,s as ae,q as le,bD as ce,bE as je,bF as He}from"./index-Wb-6_0W_.js";import{D as Pe}from"./DividingLine-BGr5Dv2u.js";import{_ as Ge}from"./RecommendationFeed-59_tDTRQ.js";import{c as Je}from"./goods-WNmbNX2m.js";import{P as $}from"./flashSale-DDyqLyYN.js";import{S as re}from"./shop-CeqcS6K2.js";import"./BoutiqueLable-negN2DKs.js";import"./ShopMaskTips-CxJi-SfW.js";import"./GoodsList-ClcIQmXw.js";import"./buy-cart-DX6aL7m1.js";import"./goods-BVwS8oFG.js";import"./GoodsPrice-CFQUMmEr.js";import"./mall-BWu47CdE.js";import"./WaterFull-Ce1Oez92.js";/* empty css                                                              */import"./useShowActiveInfo-DEBRJRuQ.js";import"./festivalActivities-DDLUvtJV.js";const ze=s=>(U("data-v-27a50109"),s=s(),X(),s),Ke=ze(()=>i("img",{src:Fe,class:"w-4 mr-1"},null,-1)),Ue={class:"text-base font-semibold"},Xe=q({props:{cartInfo:null,isManage:{type:Boolean}},emits:["changeNumber","handelDel","handleTo","handleRemove"],setup(s,{emit:m}){const k=s,{t:n}=K(),M=(h,c)=>{de.confirm({message:n("cart.remove"),confirmButtonText:n("common.confirm"),confirmButtonColor:"#FF507A",cancelButtonText:n("common.cancel")}).then(()=>{m("handelDel",k.cartInfo,h,c)}).catch(()=>{})},C=(h,c)=>{m("handelDel",k.cartInfo,h,c),m("handleRemove",k.cartInfo,h,c)};return(h,c)=>{const l=B("van-icon"),v=B("van-checkbox"),x=B("van-button"),T=B("VanSwipeCell");return u(),p("div",null,[i("div",{class:"flex-start mt-2.5",onClick:c[0]||(c[0]=g=>m("handleTo",`/category?deliveryType=1&shopId=${s.cartInfo.storeId}`))},[Ke,i("div",Ue,f(s.cartInfo.storeName||"-"),1),y(l,{name:"arrow",class:"ml-2"})]),(u(!0),p(P,null,G(s.cartInfo.goods,(g,E)=>(u(),p("div",{class:"bg-white mt-2.5 rounded-xl p-2.5",key:g.id},[y(T,null,{right:S(()=>[y(x,{square:"",class:"right-btn",color:"#FEA021",text:h.$t("cart.removeTo"),onClick:w=>C(g,E)},null,8,["text","onClick"]),y(x,{square:"",class:"right-btn",color:"#FF507A",text:h.$t("shop.delete"),onClick:w=>M(g,E)},null,8,["text","onClick"])]),default:S(()=>[y(v,{disabled:g.disabled&&!s.isManage,name:g,class:"min-w-min mr-0"},{default:S(()=>[y(Le,{goods:g,payType:g.payType,card:g,number:g.number||1,shopType:g.shopType,class:"w-full flex-1 mb-2.5 last:mb-0 pl-0",onChangeNumber:w=>m("changeNumber",g,w),onHandleTo:c[1]||(c[1]=w=>m("handleTo",w))},null,8,["goods","payType","card","number","shopType","onChangeNumber"])]),_:2},1032,["disabled","name"])]),_:2},1024)]))),128))])}}}),Qe=z(Xe,[["__scopeId","data-v-27a50109"]]),ie=s=>(U("data-v-0c6757c2"),s=s(),X(),s),Ye={class:"w-full h-14 flex items-center justify-between pb-0.5 px-2 bg-white rounded-full sm:w-[355px] shadow-2 pointer-events-auto"},Ze={class:"opacity-70"},We={key:0,class:"ml-2 text-sm text-default"},et=ie(()=>i("span",{class:"opacity-70"},[i("span",{class:"mr-1 text-lg"},"≈")],-1)),tt={class:"text-base font-semibold text-primary"},ot={key:1,class:"flex items-center justify-between flex-1 text-default dropdown-class"},st={key:0,class:"flex items-center justify-between flex-1 px-2.5"},nt={class:"text-sm text-default"},at={class:"text-xs font-normal"},lt={class:"text-xs font-normal text-center"},ct={class:"text-right"},rt={class:"flex items-center justify-end flex-1 w-full text-base font-semibold text-right"},dt=ie(()=>i("img",{class:"w-4 h-4 mr-1",src:Ne},null,-1)),it={class:"text-base"},ut={key:0,class:"text-[#A45E00] text-xs"},ht={key:0},mt=q({props:{voucherBalance:null,goodsChecked:null,loading:{type:Boolean},isCheckAll:{type:Boolean},totalAmount:null,isManage:{type:Boolean},isCollect:{type:Boolean}},emits:["totalCheck","handleCartBuy","handleDelMult","typeChange"],setup(s,{emit:m}){const k=s,{t:n}=K(),M=A(()=>k.goodsChecked.reduce((c,l)=>new D(c).plus(l.number),0)),C=A(()=>Math.min(k.voucherBalance,k.goodsChecked.reduce((c,l)=>l.goodsType>0?new D(c).plus(new D(l.number).multipliedBy(l.price).multipliedBy(l!=null&&l.goodsType?l==null?void 0:l.balanceDiscountRatio:(l==null?void 0:l.discountRatio)||0).div(100).multipliedBy(.5)):new D(c).plus(0),0)));function h(){de.confirm({messageAlign:"center",message:n("cart.delConfirm",{num:k.goodsChecked.length}),confirmButtonText:n("shop.delete"),confirmButtonColor:"#FF507A",cancelButtonText:n("cart.thinkAgain"),cancelButtonColor:"#2E2008"}).then(()=>{m("handleDelMult")}).catch(()=>{})}return(c,l)=>{const v=B("VanRadio"),x=B("VanButton");return u(),p("div",{class:Be(["fixed bottom-0 w-full px-2.5 safe-bottom sm:bottom-[0%] lg:bottom-[0%] z-20 cartbarBody pointer-events-none",s.isCollect?"":"safe-bottom-page"])},[i("div",Ye,[s.isManage||s.isCollect?(u(),p("div",{key:0,class:"flex items-center justify-between text-default",onClick:l[0]||(l[0]=T=>m("totalCheck"))},[y(v,{checked:s.isCheckAll,"checked-color":"#FEA021"},{default:S(()=>[i("span",Ze,f(c.$t("common.check all")),1)]),_:1},8,["checked"]),s.goodsChecked&&s.goodsChecked.length&&!s.isManage?(u(),p("div",We,[et,i("span",tt,f(d(ne)(d(H)(s.totalAmount||0)))+"Mcoin",1)])):R("",!0)])):(u(),p("div",ot,[y(v,{checked:s.isCheckAll,"checked-color":"#FEA021",onClick:l[1]||(l[1]=T=>m("totalCheck"))},null,8,["checked"]),s.goodsChecked&&s.goodsChecked.length&&!s.isManage?(u(),p("div",st,[i("div",nt,[i("div",at,f(c.$t("cart.hasChecked",{num:d(M)||0})),1),i("div",lt,f(c.$t("cart.count")),1)]),i("div",ct,[i("div",rt,[dt,i("span",it,f(d(ne)(d(H)(s.totalAmount||0))),1)]),d(C)?(u(),p("div",ut,f(c.$t("cart.VoucherAmount"))+f(d(H)(d(C))),1)):R("",!0)])])):R("",!0)])),s.isManage?(u(),J(x,{key:2,class:"btn-red btn-shadow px-8 h-[40px] text-white",loading:s.loading,disabled:!s.goodsChecked.length,onClick:h},{default:S(()=>[te(f(c.$t("shop.delete")),1)]),_:1},8,["loading","disabled"])):(u(),J(x,{key:3,class:"btn-orange btn-shadow px-8 h-[40px] text-white",loading:s.loading,disabled:!s.goodsChecked.length,onClick:l[2]||(l[2]=T=>m("handleCartBuy"))},{default:S(()=>[te(f(c.$t("cart.settle"))+" ",1),s.goodsChecked&&s.goodsChecked.length&&s.isCollect?(u(),p("span",ht,"("+f(s.goodsChecked.length||0)+")",1)):R("",!0)]),_:1},8,["loading","disabled"]))])],2)}}}),gt=z(mt,[["__scopeId","data-v-0c6757c2"]]),ft=s=>(U("data-v-6686f02e"),s=s(),X(),s),pt={class:"p-2.5"},Ct={class:"text-xl font-semibold flex-center-bw"},kt=ft(()=>i("div",{class:"safe-bottom-page"},null,-1)),yt=q({name:"MallCart"});function bt(s){const{t:m}=K(),k=Re(),n=Se({originList:[],oldList:[],list:[],goodsChecked:[],goodsType:0}),M=_e(),{loadingToggle:C}=Oe(),[h,c]=oe(!1),{orderGoodsStore:l}=qe();Ae("cart_number",1);const v="mall_cart_scroll_position",x=5*60*1e3,T=()=>{const o={position:document.querySelector("#fm-page").scrollTop,timestamp:Date.now()};sessionStorage.setItem(v,JSON.stringify(o))},g=()=>{const t=sessionStorage.getItem(v);if(t){const{position:o,timestamp:e}=JSON.parse(t);Date.now()-e<x?Ee(()=>{const a=document.querySelector("#fm-page");a&&setTimeout(()=>{a.scrollTo({top:o,behavior:"smooth"}),console.log("恢复滚动位置:",o,a.scrollTop)},100)}):sessionStorage.removeItem(v)}},E=()=>{h.value&&(n.goodsChecked=n.goodsChecked.filter(t=>!t.disabled)),c(!h.value)},w=t=>{console.log(t),l.setGoodsCheckedCache(t.map(o=>o.goodsId))},Q=t=>{M.push(t)},O=j(null),Y=A(()=>n.list.reduce((t,o)=>t+o.stores.reduce((e,a)=>e+a.goods.length,0),0)),Z=A(()=>n.list.reduce((t,o)=>t+o.stores.reduce((e,a)=>e+a.goods.filter(r=>!r.disabled).length,0),0)),W=A(()=>h.value?Y.value===n.goodsChecked.length:Z.value===n.goodsChecked.length&&Z.value!==0),ue=A(()=>n.goodsChecked.reduce((t,o)=>+new D(t).plus(+new D(o.payType===$.STORE_CARD?o.cardPrice:o.price).times(o.number)),0)),he=async(t,o)=>{if(t.stock<o&&+t.goodsTypes!=2)return t.number=t.stock,se(m("order.Insufficient stock"));C(!0);const e=await je({goodsId:t.goodsId,number:o});C(!1),e.success&&(t.number=o)},me=()=>{W.value?ge():F()},F=()=>{O.value.toggleAll({checked:!0,skipDisabled:!0})},ge=()=>{O.value.toggleAll({skipDisabled:!0})},fe=async(t,o,e)=>{if(C(!0),!!(await ce(o.goodsId)).success){t.goods.splice(e,1),k.getCartCount();for(let r=0;r<n.list.length;r++)n.list[r].stores=n.list[r].stores.filter(b=>b.goods&&b.goods.length>0);n.list=n.list.filter(r=>r.stores&&r.stores.length>0),n.goodsChecked=n.goodsChecked.filter(r=>r.id!==o.id),C(!1)}},pe=async(t,o)=>{C(!0);const e=await Je({goodsIds:[o.goodsId],type:1,collectType:1});C(!1),e.success},Ce=j(null),ee=j(0),ke=async()=>{const{balanceOf:t}=ae(le.MCOIN),o=await t();Ce.value=+o,ee.value=+await ae(le.FMCP).balanceOf()},ye=t=>JSON.parse(JSON.stringify(t)),V=async()=>{C(!0);const t=await Ve();C(!1),!(!t.success||!t.data)&&(n.originList=t.data||[],L(n.originList),g())},L=t=>{const o=be(ye(t));n.list=o.map(e=>({goodsBoutiqueFlag:e[0].goodsType!==re.SD,stores:ve(e)}))},be=t=>{let o={};for(;t.length;){let e=t.shift();const a=e.goodsType?"true":"false";o[a]=o[a]||[],o[a].push(e)}return Object.keys(o).map(e=>o[e])},ve=t=>t.reduce((o,e)=>{const a=e.id,r=e.status!==1||!+e.stock&&e.goodsTypes!=2||+e.shopStatus==4||+e.shopStatus==0||+e.shopStatus==3;e.disabled=r,e.id=e.goodsId,e.icons=e.icon,r?n.goodsChecked=n.goodsChecked.filter(_=>_.id!==e.id):l.goodsCheckedCache.findIndex(_=>_===e.goodsId)!==-1&&n.goodsChecked.push(e);const b=o.findIndex(_=>_.storeId===e.storeId);return b!==-1?o[b].goods.push(e):o.push({id:a,storeId:e.storeId,storeName:e.storeName,goods:[e]}),o},[]),[xe,N]=oe(!1),Te=(...t)=>{let o=0;return t.forEach(e=>{e===!0&&o++}),o},we=async()=>{let t=n.goodsChecked.some(I=>I.goodsType!==re.SD),o=n.goodsChecked.some(I=>I.payType===$.MC),e=n.goodsChecked.some(I=>I.payType===$.STORE_CARD);const a=Te(t,o,e);if(a>2||a===2&&e)return se(m("cart.tips"));N(!0);let r=[];n.goodsChecked.forEach(I=>{r.push(I.id)});const b=await He(r.join(","));if(N(!1),!b.success)return;k.getCartCount(),Q(a===2||t||a===1&&o?"/submitOrderBoutiqueCart":"/submitOrderCart")},Ie=async()=>{N(!0);let t=[];n.goodsChecked.forEach(e=>{t.push(e.id)});const o=await ce(t.join(","));n.goodsChecked=[],N(!1),o.success&&(V(),k.getCartCount())};return De(()=>n.goodsType,async t=>{if(+t==0)L(n.originList),F();else if(+t==2){const o=n.originList.filter(e=>(e==null?void 0:e.goodsBoutiqueFlag)&&(e==null?void 0:e.payType)!==$.STORE_CARD);await L(o),F()}else if(+t==1){const o=n.originList.filter(e=>!(e!=null&&e.goodsBoutiqueFlag)||(e==null?void 0:e.payType)===$.STORE_CARD);await L(o),F()}},{deep:!0}),Me(()=>{V(),ke(),document.querySelector("#fm-page").addEventListener("scroll",T)}),$e(()=>{document.querySelector("#fm-page").removeEventListener("scroll",T)}),(t,o)=>{const e=B("van-checkbox-group");return u(),p("div",null,[i("div",pt,[y(e,{modelValue:d(n).goodsChecked,"onUpdate:modelValue":o[0]||(o[0]=a=>d(n).goodsChecked=a),onChange:w,ref:(a,r)=>{r.checkboxGroup=a,O.value=a},"checked-color":"#FEA021"},{default:S(()=>[i("div",Ct,[i("span",null,f(t.$t("cart.cart"))+"("+f(d(Y))+")",1),i("div",{class:"text-sm font-normal text-primary",onClick:E},f(d(h)?t.$t("common.quteManage"):t.$t("common.manage")),1)]),(u(!0),p(P,null,G(d(n).list,a=>(u(),p("div",{class:"cart-list",key:a.goodsBoutiqueFlag},[y(Pe,{goodsBoutiqueFlag:a.goodsBoutiqueFlag},null,8,["goodsBoutiqueFlag"]),(u(!0),p(P,null,G(a.stores,(r,b)=>(u(),J(Qe,{isManage:d(h),key:b,cartInfo:r,onChangeNumber:he,onHandelDel:fe,onHandleRemove:pe,onHandleTo:Q},null,8,["isManage","cartInfo"]))),128))]))),128))]),_:1},8,["modelValue"])]),y(Ge,{onSuccessAdd:V,"title-text":d(m)("common.recommend_for_you"),class:"p-2.5"},null,8,["title-text"]),kt,y(gt,{voucherBalance:ee.value,isManage:d(h),goodsChecked:d(n).goodsChecked,isCheckAll:d(W),totalAmount:d(ue),loading:d(xe),onTotalCheck:me,onHandleCartBuy:we,onHandleDelMult:Ie},null,8,["voucherBalance","isManage","goodsChecked","isCheckAll","totalAmount","loading"])])}}const vt=q({...yt,setup:bt}),Pt=z(vt,[["__scopeId","data-v-6686f02e"]]);export{Pt as default};
