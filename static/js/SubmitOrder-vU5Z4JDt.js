import{_ as We}from"./MCOIN-BOqZVkND.js";import{_ as ze,y as Ae,a2 as je,l as He,w as Ye,x as _,r as W,be as Z,bf as _e,bq as Xe,B as de,D as Qe,bj as Ze,E as ce,K as k,G as p,N as J,F as me,X as A,O as S,P as o,H as d,Q as T,a1 as Je,I as eo,a7 as Ie,Z as oo,$ as to,T as ee}from"./vendor-BlU_hoYl.js";import{C as ro}from"./CommonVanProvider-CDfGVWR4.js";import{_ as so}from"./OfflineGoods-NsfElKHP.js";import{_ as ao}from"./OfflineStore-CFeVI8_T.js";import{_ as no}from"./OfflineTotalPriceDetail-xGxAmlzQ.js";import{_ as lo}from"./OfflineConsumer-IseIUH_a.js";import{e as uo,o as io,R as co,r as mo,S as po,q as R,_ as fo,T as yo,n as Ne,U as go,V as ho,W as bo,X as vo,Y as So}from"./index-UgIL2Smv.js";import{P as oe}from"./order-H59PKTFP.js";import{O as u,a as Oe}from"./offlineGoods-DvT2Go6q.js";import{P as ko}from"./PaymentMethodSelector-Dn-1pqSq.js";import{u as Po}from"./usePaymentBalance-BSJrmoFe.js";import{_ as pe}from"./SubmitApprove-DXvMhooF.js";import{P as wo}from"./PaySwitchPop-B-FiDltW.js";import{S as te}from"./shop-CeqcS6K2.js";import{T as Co,P as _o}from"./profileEnum-CXsMKuND.js";import"./BackIcon-8hcEjDKb.js";import"./ImgBoutiqueLable-BIio6fYG.js";import"./USDT-CNsbs3BR.js";import"./FMCP-yoa9RTPy.js";import"./avatarRing-DtI_kRg6.js";import"./point-arrow-BXwQ0Ukh.js";import"./usePointRelase-DAfmIzgK.js";import"./piggyBank-swFyWePk.js";const Io=z=>(oo("data-v-155c72b6"),z=z(),to(),z),No={class:"px-3 pb-3 overflow-y-auto relative safe-page-body"},Oo={class:"bg-white rounded-xl p-3"},Ao={class:"flex items-center justify-end gap-x-[1px]"},To={class:"input-wrapper"},Ro={key:3,class:"bg-[#FFF8EC] rounded-[10px] p-3 flex items-center justify-between mt-3"},qo=Io(()=>d("div",{class:"flex items-center min-w-fit"},[d("img",{src:We,class:"w-[22px] h-[22px] mr-1.5"}),d("span",{class:"text-b1"},"MCOIN")],-1)),xo={class:"bg-white rounded-xl px-3 py-4 mt-3"},Vo={class:"flex items-center justify-between"},$o={class:"text-b1 font-semibold"},Bo={class:"relative py-4"},Do={class:"font-Puhui"},Eo={class:"text-b1 font-semibold text-center"},Fo=Ae({name:"offlineSubmitOrder"});function Mo(z){const l=je(),re=He(),{t:se}=Ye(),h=_(()=>{var t;return Number((t=l.query)==null?void 0:t.orderType)}),q=_(()=>{var t;return(t=l.query)==null?void 0:t.key}),{accountStore:x,regionStore:Te,orderGoodsStore:b}=uo(),{loadingToggle:fe}=mo(),{submitOffline:Re}=io(),{getUserDhKey:qe,encryptKey:xe}=co(),j=W(null),[H,Y]=Z(!1),[Ve,ye]=Z(!1),[$e,ge]=Z(!1),e=_e({goodsNumber:1,inputAmount:null,remark:"",goods:{goodsPrice:0,goodsDiscountRatio:20,goodsType:te.SD,shopId:null},shop:{logo:"",storeName:"",discountRatio:20,merchant:"",type:te.SD,id:null},dhKey:null});let s=_e({region:Te.country,orderType:null,orderPaySource:null,shopId:void 0,goodsId:void 0,goodsNumber:void 0,price:0,discountRatio:20,orderCustomerAddress:x.account,orderPayAddress:x.account,merchantAddress:null,orderCashierAddress:void 0,orderRemarkEnsFlag:!1,storeId:null,storeName:null});const ae=W(null),V=W(!1),{balanceState:I,paymentOptions:Be,getPaymentBySource:De,fetchAllBalances:he,autoSelectPaymentMethod:Ee,checkSufficientBalance:Fe}=Po(V),f=W(oe.WITHDRAW_POINTS),ne=_(()=>De(f.value)),[be,ve]=Z(!1),Se=W(null);Xe(Se,()=>{ve(!!e.remark)});const Me=t=>{let r=t.replace(/[^\d.]/g,"");return r=r.replace(/(\..*)\./g,"$1"),r=r.replace(/^(\d*\.?\d{0,4}).*$/,"$1"),r},N=_(()=>{var t;return h.value===u.GOODS?de((t=e==null?void 0:e.goods)==null?void 0:t.goodsPrice).times(e.goodsNumber||0).toNumber():e.inputAmount}),ke=_(()=>new de(s.discountRatio).times(N.value||0).times(I.pointSelfRate).div(100).toString()),Pe=_(()=>Math.min(I.voucherBalance,new de(ke.value).div(I.pointSelfRate).times(.5).toNumber())),le=_(()=>f.value===oe.WITHDRAW_POINTS?Pe.value:0),ue=t=>{e.goodsNumber=t},ie=t=>{f.value=t},Ge=async()=>{var t,r,i,n,c,m;if(q.value){if((t=b.orderOfflineInfo)!=null&&t.goods&&((r=b.orderOfflineInfo)!=null&&r.goods.goodsId)&&((i=b.orderOfflineInfo)==null?void 0:i.goods.goodsId)===q.value)e.goods=(n=b.orderOfflineInfo)==null?void 0:n.goods;else{const{success:y,data:g}=await So({id:q.value.toString()});if(!y)return;e.goods=g}(c=e.goods)!=null&&c.shopId&&await we((m=e.goods)==null?void 0:m.shopId)}},we=async t=>{var r,i,n,c,m,y,g;if(t){if((r=b.orderOfflineInfo)!=null&&r.shop&&((n=(i=b.orderOfflineInfo)==null?void 0:i.shop)!=null&&n.id)&&+((m=(c=b.orderOfflineInfo)==null?void 0:c.shop)==null?void 0:m.id)==+t)e.shop=(y=b.orderOfflineInfo)==null?void 0:y.shop;else{const{success:P,data:w}=await vo(t);if(!P)return;e.shop=w}s.shopId=t,s.merchantAddress=(g=e.shop)==null?void 0:g.merchant}},X=[[],[4,30],[10,80],[20,80]],Ce=async()=>{var t,r,i,n,c,m,y,g,P,w,$,B,D,E,F,M,G,U,L;if(+((t=l.query)==null?void 0:t.amount)>0&&(e.inputAmount=Number(l.query.amount)),!h.value&&((r=l.query)!=null&&r.address)){let C,K;const{success:Q,data:v}=await yo((i=l.query)==null?void 0:i.address);if(!Q)return;const a=Ne(l.fullPath,"address"),O=Ne(l.fullPath,"caddr");v!=null&&v.id?(K=v==null?void 0:v.id,C=O&&Ie.toLower(O)!==Ie.toLower(a)?u.CPC.toString():u.MPC.toString()):C=u.PPC.toString(),re.replace({path:"/offlineSubmit",query:{...l.query,orderType:C,key:K}}),setTimeout(()=>{Ce()});return}switch(h.value){case u.GOODS:await Ge(),s.discountRatio=(n=e==null?void 0:e.goods)==null?void 0:n.goodsDiscountRatio,V.value=((c=e==null?void 0:e.goods)==null?void 0:c.goodsType)>te.SD;break;case u.PPC:s.discountRatio=Number(((m=l.query)==null?void 0:m.ratio)||.2)*100,s.merchantAddress=(((y=l.query)==null?void 0:y.address)||"").toString(),e.shop.merchant=(((g=l.query)==null?void 0:g.address)||"").toString(),V.value=!1;break;case u.MPC:case u.CPC:case u.STORE:await we(q.value),s.discountRatio=Number((P=l.query)==null?void 0:P.ratio)>0?Number(((w=l.query)==null?void 0:w.ratio)||.2)*100:($=e==null?void 0:e.shop)==null?void 0:$.discountRatio,((B=e==null?void 0:e.shop)==null?void 0:B.type)>te.SD&&((E=X[(D=e==null?void 0:e.shop)==null?void 0:D.type])!=null&&E.length)&&(console.log(X[(F=e==null?void 0:e.shop)==null?void 0:F.type],s.discountRatio),V.value=s.discountRatio>=X[(M=e==null?void 0:e.shop)==null?void 0:M.type][0]&&s.discountRatio<=X[(G=e==null?void 0:e.shop)==null?void 0:G.type][1]);break}h.value!==u.PPC&&((U=e.shop)!=null&&U.id)&&x.isLogin&&(e.dhKey=await qe((L=e.shop)==null?void 0:L.id))},Ue=async()=>{var t,r;switch(s.orderCustomerAddress=x.account,s.orderPayAddress=x.account,s.orderType=h.value,s.price=N.value,s.orderPaySource=f.value,s.orderRemark=e.remark,s.merchantEns=void 0,h.value){case u.GOODS:s.goodsId=q.value.toString(),s.goodsNumber=e.goodsNumber,s.orderRemark=e.remark||void 0;break;case u.PPC:break;case u.MPC:break;case u.CPC:s.orderCashierAddress=(((t=l.query)==null?void 0:t.caddr)||"").toString();break;case u.STORE:break}if(h.value!==u.PPC&&((r=e.shop)!=null&&r.id)&&e.remark&&e.dhKey){const{encrypt:i}=xe(e.remark,e.dhKey);s.orderRemark=i,s.orderRemarkEnsFlag=!0}},Le=async()=>{var t,r;if(N.value<=0)return ee.fail(se("offline.input_pay_amount"));if(!Fe((t=ne.value)==null?void 0:t.source,(r=j.value)==null?void 0:r.realTotalAmountShow))return ye(!0);Y(!0);try{await Ue();const{success:i,data:n}=await go(s);if(!i){Y(!1);return}const{success:c}=await Re(s.merchantAddress,n.orderTotalAmount,s.discountRatio,s.orderPaySource,n.isScanFlag,n.allId);if(!c){Y(!1);return}ee.loading({message:se("order.wait block chain"),forbidClick:!0,duration:0}),await ho({id:n==null?void 0:n.orderId,currentOrderStatus:Oe.PAYING}),ee.clear(),n.isScanFlag?ge(!0):(ee({message:se("common.pay success"),icon:bo("toast-success.svg"),duration:3e3,overlay:!0,overlayClass:"toastOverlay",className:"toastCard"}),setTimeout(()=>{re.replace({path:"/offlineConsumerorders",query:{status:Oe.PAYMENT_SUCCESS}})},3e3))}finally{Y(!1)}},Ke=()=>{re.replace({path:"profile",query:{path:_o.CONSUMER,tab:Co.OFFLINE}})};return Qe(async()=>{fe(!0);try{await Promise.all([Ce(),he()]);const t=Ee(N.value,Pe.value);ie(t)}catch(t){console.error("Failed to initialize payment method:",t)}finally{fe(!1)}if(l.query.storeId){s.storeId=l.query.storeId;const t=await po({id:l.query.storeId});if(!(t!=null&&t.success))return;ae.value=t.data}}),Ze(()=>{b.changeOfflineInfo(null)}),(t,r)=>{const i=ce("van-button"),n=ce("VanField"),c=ce("VanButton");return p(),k(ro,{title:t.$t("order.order"),class:"h-full font-Puhui font-normal relative",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent",fieldInputTextColor:"#585654"}},{default:J(()=>{var m,y,g,P,w,$,B,D,E,F,M,G,U,L,C,K,Q,v;return[(m=o(e).goods)!=null&&m.goodsPrice||(y=o(e).shop)!=null&&y.merchant?(p(),me(eo,{key:0},[d("div",No,[d("div",Oo,[o(h)===o(u).PPC?(p(),k(lo,{key:0,order:{orderCustomerAddress:(P=(g=o(e))==null?void 0:g.shop)==null?void 0:P.merchant},showStatus:!1},null,8,["order"])):(p(),k(ao,{key:1,shop:{images:($=(w=o(e))==null?void 0:w.shop)==null?void 0:$.logo,name:(D=(B=o(e))==null?void 0:B.shop)==null?void 0:D.storeName}},null,8,["shop"])),o(h)===o(u).GOODS?(p(),k(so,{key:2,class:"mt-3",goods:{...(E=o(e))==null?void 0:E.goods,storeName:((M=(F=o(e))==null?void 0:F.goods)==null?void 0:M.storeName)||((G=ae.value)==null?void 0:G.storeName),areaExtName2:(U=ae.value)==null?void 0:U.areaExtName2}},{"bottom-right":J(()=>[d("div",Ao,[S(i,{icon:"minus",size:"mini",type:"primary",class:"num-btn w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-l",disabled:+o(e).goodsNumber<=1,onClick:r[0]||(r[0]=a=>ue(+o(e).goodsNumber-1))},null,8,["disabled"]),d("div",To,[S(n,{class:"text-center rounded input-box",type:"digit",modelValue:o(e).goodsNumber,"onUpdate:modelValue":[r[1]||(r[1]=a=>o(e).goodsNumber=a),ue]},null,8,["modelValue"])]),S(i,{icon:"plus",size:"mini",type:"primary",class:"w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-r",onClick:r[2]||(r[2]=a=>ue(+o(e).goodsNumber+1))})])]),_:1},8,["goods"])):(p(),me("div",Ro,[qo,S(n,{"input-align":"right",placeholder:t.$t("offline.input_pay_amount"),class:"py-0 pr-0 bg-[transparent]",modelValue:o(e).inputAmount,"onUpdate:modelValue":r[3]||(r[3]=a=>o(e).inputAmount=a),type:"number",formatter:Me,readonly:+(((L=o(l).query)==null?void 0:L.amount)||0)>0},null,8,["placeholder","modelValue","readonly"])]))]),d("div",xo,[d("div",Vo,[d("span",$o,T(t.$t("order.buyerRemark")),1),o(be)?A("",!0):(p(),me("span",{key:0,class:"text-b3",onClick:r[4]||(r[4]=a=>o(ve)(!0))},T(t.$t("common.pleaseInput"))+T(t.$t("order.remark")),1))]),o(be)?(p(),k(n,{key:0,ref:(a,O)=>{O.remarkRef=a,Se.value=a},modelValue:o(e).remark,"onUpdate:modelValue":r[5]||(r[5]=a=>o(e).remark=a),type:"textarea",maxlength:"100",class:"!bg-b5 rounded-lg mt-2 p-2"},null,8,["modelValue"])):A("",!0)]),S(ko,{class:"mt-3",modelValue:f.value,"onUpdate:modelValue":r[6]||(r[6]=a=>f.value=a),"payment-options":o(Be),loading:o(I).loading,boutique:V.value,onChange:ie,onGetPointBalance:o(he)},null,8,["modelValue","payment-options","loading","boutique","onGetPointBalance"]),S(no,{ref:(a,O)=>{O.priceDetailRedf=a,j.value=a},totalAmount:o(N),"usdt-rate":o(I).usdtRate,"voucher-price":o(I).voucherBalance,integral:o(ke),voucherAmount:o(le),paySource:f.value,class:"mb-2.5"},null,8,["totalAmount","usdt-rate","voucher-price","integral","voucherAmount","paySource"])]),d("div",Bo,[[o(oe).WALLET].includes(f.value)?(p(),k(pe,{key:0,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(R).order,token:o(R).MCOIN,symbol:((C=o(ne))==null?void 0:C.symbol)||"MCOIN",loading:o(H),approveAmount:Number(((K=j.value)==null?void 0:K.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):A("",!0),[o(oe).USDT_WALLET].includes(f.value)?(p(),k(pe,{key:1,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(R).order,token:o(R).USDT,symbol:((Q=o(ne))==null?void 0:Q.symbol)||"USDT",loading:o(H),approveAmount:Number(((v=j.value)==null?void 0:v.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):A("",!0),o(le)>0?(p(),k(pe,{key:2,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(R).order,token:o(R).FMCP,symbol:t.$t("voucher.voucher"),loading:o(H),approveAmount:Number(o(le))},null,8,["contract","token","symbol","loading","approveAmount"])):A("",!0),S(c,{round:"",class:"pay-btn btn-yellow w-full h-[46px]",loading:o(H),disabled:!o(N),onClick:Le},{default:J(()=>[Je(T(t.$t("common.pay")),1)]),_:1},8,["loading","disabled"])])],64)):A("",!0),S(wo,{"pay-source":f.value,show:o(Ve),onClose:r[7]||(r[7]=a=>o(ye)(!1)),onChangePay:r[8]||(r[8]=a=>ie(a))},null,8,["pay-source","show"]),S(fo,{show:o($e),noClose:"",onClose:r[9]||(r[9]=a=>o(ge)(!1))},{default:J(()=>[d("div",Do,[d("div",Eo,T(t.$t("common.pay success")),1),d("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:Ke},T(t.$t("common.I_see")),1)])]),_:1},8,["show"])]}),_:1},8,["title"])}}const Go=Ae({...Fo,setup:Mo}),mt=ze(Go,[["__scopeId","data-v-155c72b6"]]);export{mt as default};
