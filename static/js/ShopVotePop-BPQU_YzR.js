import{_ as G,y as De,F as c,G as n,X as h,P as e,I as k,a1 as w,Q as l,Y as Ke,R as _,bl as qe,w as Je,x as m,r as $,bf as Xe,be as A,bJ as Ge,bj as He,D as Qe,E as M,K as F,N as Fe,H as o,O as E,J as Ce,a4 as We,a0 as Ye,B as Ze,Z as et,$ as tt,T as P}from"./vendor-BlU_hoYl.js";import{_ as st}from"./member-CkdtKF8y.js";import{S as ot}from"./SkewCard-QARQ7Sw2.js";import{S as at}from"./shop-CeqcS6K2.js";import{e as nt,g as Ee,b as it,W as J,r as lt,br as ut}from"./index-UgIL2Smv.js";import{b as ct}from"./beiExtRewardContract-BdxGmuaX.js";import{q as rt,c as dt}from"./beiRanking-CtqNruZi.js";import{b as ft}from"./beiConstContract-CfA3lvj1.js";import{u as vt}from"./useKeyboard-C7Jit2jF.js";const pt={key:0},mt=w("普通店铺"),ht=De({props:{type:null,width:{default:125}},setup(f){return(g,z)=>(n(),c("div",{class:_(["tag-box text-right text-white font-semibold pr-5 pt-1 h-[75px] min-w-[120px]",`bg-${f.type||0}`]),style:Ke({width:`${f.width}px`})},[f.type!==void 0?(n(),c("span",pt,[f.type===e(at).SD?(n(),c(k,{key:0},[mt],64)):(n(),c(k,{key:1},[w(l(g.$t(`common.shop_type_${f.type}`))+"店铺",1)],64))])):h("",!0)],6))}}),bt=G(ht,[["__scopeId","data-v-ea5a823e"]]),kt={},gt={class:"points_wrapper"},xt=qe('<i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i><i class="point" data-v-66db05bc></i>',10),_t=[xt];function wt(f,g){return n(),c("div",gt,_t)}const X=G(kt,[["render",wt],["__scopeId","data-v-66db05bc"]]),N=f=>(et("data-v-db5a9c72"),f=f(),tt(),f),yt=["id"],It={class:"relative z-0 p-3"},Tt={class:"flex items-center gap-x-2"},Ft={class:"relative"},Ct={class:"-mt-5 w-[40px] border-[1px] border-solid border-white flex-center bg-yellow rounded-3xl mx-auto relative z-10"},Et=N(()=>o("img",{src:st,class:"w-4 h-4"},null,-1)),Dt={class:"text-sm"},$t={class:"flex flex-col gap-1 flex-1"},Mt={class:"text-base font-semibold line-clamp-1 name-width"},Bt={class:"text-b3 flex items-center"},Lt=["src"],Vt=N(()=>o("span",{class:"mx-1"},"|",-1)),St={class:"flex-1"},At={class:"text-xs"},Pt={class:"text-xs"},Nt={class:"w-full h-[40px] bg-b5 rounded-full p-0.5 mt-4"},zt={class:"w-full h-full relative"},jt={class:"absolute w-full h-full flex items-center justify-center left-0 top-0"},Ot=["onClick"],Ut={class:"mt-4 flex items-center bg-b5 px-3 py-[9px] rounded-[10px]"},Rt={class:"flex items-center gap-x-3"},Kt=["onClick"],qt={key:0,class:"flex-center-bw text-b3 mt-1"},Jt={class:"flex items-center text-left"},Xt={key:1,class:"text-left text-b3 font-normal mt-1"},Gt={class:"flex items-center"},Ht=N(()=>o("span",{class:"text-success"},"充电：",-1)),Qt=w(" 当前电量已满无需充电 "),Wt=w(" 预计电量+"),Yt={key:1},Zt={class:"flex items-center"},es=N(()=>o("span",{class:"text-error"},"放电：",-1)),ts=w("预计电量-"),ss={key:1},os={class:"flex-center-bw mt-4 gap-x-3"},as=["src"],ns=["src"],is=["src"],ls=De({props:{show:{type:Boolean},shopId:null,teleport:null},emits:["close","voteSuccess","handleTo"],setup(f,{emit:g}){const{show:z,shopId:$e,teleport:us}=f,{t:H}=Je(),{contributesStore:j}=nt(),{voteByPoint:Me,voteByLp:Be,userVoteDetailView:Le,voteMonthTimestampView:Ve}=ct(),{userTotalLp:Se}=ft(),{loadingToggle:O}=lt(),{isKeyboardVisible:Ae}=vt(),B=m(()=>[{id:1,text:H("ranking.points_ticket")},{id:2,text:H("ranking.lp_ticket")}]),i=$(null),Pe=[.25,.5,.75],a=Xe({tab:1,votesInfo:{1:{total:0,sumUsed:0},2:{total:0,sumUsed:0}},estimateInfo:{coefficient:.1,coefficientLikeBudget:.1,coefficientNotLikeBudget:.1,score:0,scoreLikeBudget:0,scoreNotLikeBudget:0,likeDiffer:0,notlikeDiffer:0,tickets:0},totalTimes:5,rewardTimes:5}),L=m(()=>a==null?void 0:a.votesInfo[a.tab]),D=m(()=>{var s;return Math.max(((s=L.value)==null?void 0:s.total)-(L==null?void 0:L.value.sumUsed),0)}),u=$(null),Q=$(null),W=$(null),[y,U]=A(!0),[d,x]=A(!1),[Y,Z]=A(!0),[ee,te]=A(!1),V=m(()=>{var s;return Math.abs(Math.min(((s=i.value)==null?void 0:s.lpTicket)||0,0))}),se=m(()=>Math.min(V.value,D.value||0)),R=m(()=>{var s,t;return Math.max(+((s=i.value)==null?void 0:s.pointTicket)*10-Math.abs((t=i.value)==null?void 0:t.lpTicket),0)}),oe=m(()=>Math.min(R.value,D.value||0)),ae=m(()=>u.value&&u.value>se.value),ne=m(()=>u.value&&u.value>oe.value),Ne=m(()=>a.tab===1?"0":`LP投票上限:${oe.value}放电票/${se.value}充电票`),p=$(null),ie=s=>{y.value||d.value||(u.value=Math.floor(new Ze(D.value).times(s).toNumber()))},K=()=>{O(!1),g("close")},ze=s=>{+a.tab==+s||d.value||(u.value=null,a.estimateInfo.tickets=0,a.tab=s)},je=async()=>{const{result:s}=await Ve();W.value=+s.thisMonthTime},Oe=async()=>{O(!0);const{success:s,data:t}=await rt({shopId:$e,month:ut()});s&&(O(!1),i.value=t)},le=async()=>{var I,b,S,T;if(a.tab===1)return;if(u.value<=0){a.estimateInfo.tickets=0;return}te(!0);const s=+u.value>=V.value?+V.value:+u.value,t=i.value.pointTicket+Math.trunc((+((I=i.value)==null?void 0:I.lpTicket)+s)/10);a.estimateInfo.likeDiffer=Math.abs(t-((b=i.value)==null?void 0:b.score));const v=+u.value>=R.value?+R.value:+u.value,C=i.value.pointTicket+Math.trunc((+((S=i.value)==null?void 0:S.lpTicket)-v)/10);a.estimateInfo.tickets=+u.value,a.estimateInfo.notlikeDiffer=Math.abs(C-((T=i.value)==null?void 0:T.score))||0,te(!1)};Ge(()=>{le()});const ue=async()=>{var v;if(!Number(u.value)||+u.value<=0)return P({message:"请输入投票数",duration:2e3}),!1;if(+u.value>+D.value)return P({message:"超过可投数量",duration:2e3}),!1;const{success:s,data:t}=await dt((v=i.value)==null?void 0:v.shopId);return s||P({message:"网络异常～",duration:2e3}),s&&!t&&P({message:"当前店铺无法投票请联系店家确认",duration:2e3}),t},Ue=async()=>{var t;if(y.value||d.value)return;if(x(!0),!await ue()){x(!1);return}p.value=null,x(!0);const{success:s}=await Me((t=i.value)==null?void 0:t.shopId,u.value);x(!1),s&&(console.log(+a.rewardTimes,+a.totalTimes),g("close"),g("voteSuccess",{direct:200,differ:+u.value},+a.rewardTimes<+a.totalTimes))},ce=async s=>{var v,C,I,b;if(y.value||d.value||s===200&&ae.value||s===400&&ne.value)return;if(x(!0),!await ue()){x(!1);return}x(!0),p.value=s,((v=a.estimateInfo)==null?void 0:v.tickets)!==u.value&&await le();const{success:t}=await Be((C=i.value)==null?void 0:C.shopId,u.value,s);x(!1),t&&(g("close"),g("voteSuccess",{direct:s,differ:s===200?(I=a.estimateInfo)==null?void 0:I.likeDiffer:(b=a.estimateInfo)==null?void 0:b.notlikeDiffer},+a.rewardTimes<+a.totalTimes))},Re=async()=>{U(!0),await je();const{success:s,result:t}=await Le(W.value);a.rewardTimes=+(t==null?void 0:t.times),a.votesInfo[1]={total:Math.min(Math.floor(j.contributes/1e3),500),sumUsed:+(t==null?void 0:t.sumTickets)},console.log("rewardTimes :",+(t==null?void 0:t.times)),console.log("contributes :",j.contributes),console.log("sumTickets :",+(t==null?void 0:t.sumTickets)),console.log("votesInfo:",a.votesInfo[1]),s&&U(!1);const v=Math.floor(+await Se());U(!1),a.votesInfo[2]={total:+v,sumUsed:+(t==null?void 0:t.sumLp)}},re=s=>{(s.key==="Enter"||s.key==="Escape")&&Q.value.blur()};return He(()=>{window.removeEventListener("keydown",re)}),Qe(async()=>{window.addEventListener("keydown",re),Oe(),await j.fetchContributes(),Re()}),(s,t)=>{const v=M("van-icon"),C=M("VanImage"),I=M("VanField"),b=M("VanLoading"),S=M("VanPopup");return n(),F(S,{show:f.show,"onUpdate:show":t[7]||(t[7]=T=>Ye(z)?z.value=T:null),teleport:f.teleport,onClickOverlay:We(K,["stop"]),onClose:K,round:"",class:"bg-transparent",style:{"min-width":"280px","max-width":"350px",width:"85%",height:"100%"}},{default:Fe(()=>[o("div",{class:"relative m-auto text-sm font-normal font-Puhui ransition-all duration-300",id:e(Ae)?"position-center":"position-center-top"},[o("div",{class:"text-right text-b6 ml-auto text-lg font-bold h-6 flex items-start justify-end",onClick:K},[E(v,{name:"cross"})]),E(ot,{width:"210",right:"26"},{default:Fe(()=>{var T,de,fe,ve,pe,me,he,be,ke,ge,xe,_e,we,ye,Ie,Te;return[E(bt,{class:"absolute right-1.5 top-1.5 -z-20",type:(T=i.value)==null?void 0:T.type},null,8,["type"]),o("div",It,[o("div",Tt,[o("div",Ft,[E(C,{round:"",src:(((de=i.value)==null?void 0:de.logo)||"").split(",")[0],errorIcon:e(Ee)("images/ranking/noPosition.png"),fit:"cover",width:"46px",height:"46px"},null,8,["src","errorIcon"]),o("div",Ct,[Et,o("span",Dt,"V"+l((fe=i.value)==null?void 0:fe.memberLevel),1)])]),o("div",$t,[o("div",Mt,l((ve=i.value)==null?void 0:ve.storeName),1),o("div",Bt,[o("span",null,l(e(it)((pe=i.value)==null?void 0:pe.shopAddress,"**",0,4)),1),(me=i.value)!=null&&me.authorizeAddress?(n(),c("img",{key:0,src:e(Ee)("images/ranking/auth.svg"),class:"w-4 h-4"},null,8,Lt)):h("",!0),Vt,o("span",null,l(((he=i.value)==null?void 0:he.score)||0)+l(s.$t("ranking.battery")),1),o("div",{class:"text-newOrigin pl-1",onClick:t[0]||(t[0]=r=>e(Z)(!e(Y)))},l(s.$t("user.feedbackDetail")),1)])])]),o("div",{class:_(["bg-[#FF88121F] text-newOrigin rounded px-2 flex items-center justify-between overflow-hidden transition-all duration-300",e(Y)?"py-0.5 min-h-[44px] border border-newOrigin mt-1":"h-0 mt-0"]),onClick:t[1]||(t[1]=r=>e(Z)(!1))},[o("div",St,[o("div",At," LP 票总计："+l(+((be=i.value)==null?void 0:be.lpTicket)||0)+"票(对应"+l(Math.floor(Math.abs((+((ke=i.value)==null?void 0:ke.lpTicket)||0)/10)))+"放电量) ",1),o("div",Pt,l((ge=i.value)==null?void 0:ge.score)+l(s.$t("ranking.battery"))+" = "+l(+((xe=i.value)==null?void 0:xe.pointTicket)||0)+l(s.$t("ranking.points_ticket"))+" - "+l(Math.floor(Math.abs(((_e=i.value)==null?void 0:_e.lpTicket)||0)*.1))+"放电量 ",1)]),o("div",null,[E(v,{name:"cross"})])],2),o("div",Nt,[o("div",zt,[o("div",{class:_(["absolute w-[50%] h-full bg-b1 rounded-full left-0 transition-all duration-300",`w-[${100/e(B).length}%] left-${e(B).findIndex(r=>r.id===e(a).tab)||0}/${e(B).length}`])},null,2),o("div",jt,[(n(!0),c(k,null,Ce(e(B),r=>(n(),c("div",{class:"w-[50%] h-full flex items-center justify-center overflow-hidden",onClick:q=>ze(r.id),key:r.id},[o("span",{class:_(["text-sm text-center line-clamp-1 transition-all duration-300",[e(a).tab===r.id?"text-b6 font-semibold":"text-b3 font-normal"]])},l(r.text),3)],8,Ot))),128))])])]),o("div",Ut,[E(I,{type:"digit",modelValue:u.value,"onUpdate:modelValue":t[2]||(t[2]=r=>u.value=r),placeholder:e(Ne),ref:(r,q)=>{q.amountInputRef=r,Q.value=r},class:_(e(a).tab===2&&!u.value?"!text-sm !font-normal":"text-lg font-semibold")},null,8,["modelValue","placeholder","class"]),o("div",Rt,[e(a).tab===1?(n(),c(k,{key:0},[(n(),c(k,null,Ce(Pe,r=>o("div",{class:"shrink-0 w-fit text-newOrigin px-0.5",key:r,onClick:q=>ie(r)},l(r*100)+"% ",9,Kt)),64)),o("div",{class:"shrink-0 w-fit text-newOrigin",onClick:t[3]||(t[3]=r=>ie(1))}," MAX ")],64)):h("",!0)])]),e(a).tab===1||e(a).tab===2&&!((we=e(a).estimateInfo)!=null&&we.tickets)?(n(),c("div",qt,[o("div",Jt,[w(l(s.$t("ranking.remain_ticket")),1),e(y)?(n(),F(b,{key:0,size:"10"})):(n(),c(k,{key:1},[w(l(e(D)),1)],64)),w(l(e(a).tab===1?s.$t("ranking.points_ticket"):s.$t("ranking.lp_ticket")),1)])])):+e(a).tab==2&&((ye=e(a).estimateInfo)==null?void 0:ye.tickets)>0?(n(),c("div",Xt,[o("div",Gt,[Ht,+e(V)<=0?(n(),c(k,{key:0},[Qt],64)):(n(),c(k,{key:1},[Wt,e(ee)?(n(),F(b,{key:0,size:"12"})):(n(),c("span",Yt,l((Ie=e(a).estimateInfo)==null?void 0:Ie.likeDiffer),1))],64))]),o("div",Zt,[es,ts,e(ee)?(n(),F(b,{key:0,size:"12"})):(n(),c("span",ss,l((Te=e(a).estimateInfo)==null?void 0:Te.notlikeDiffer),1))])])):h("",!0),o("div",os,[e(a).tab===1?(n(),c("div",{key:0,class:_(["btn-power text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold flex items-center justify-center",{"opacity-60":e(y)}]),onClick:t[4]||(t[4]=r=>Ue())},[e(d)?h("",!0):(n(),c("img",{key:0,src:e(J)("charge.svg"),class:"w-[18px] h-[18px]"},null,8,as)),o("span",null,l(e(d)?"充电中":"充电"),1),e(d)?(n(),F(X,{key:1})):h("",!0)],2)):(n(),c(k,{key:1},[o("div",{class:_(["btn-discharge text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold flex items-center justify-center",{"opacity-60":e(ne)||e(y)||e(d)&&+p.value!=400}]),onClick:t[5]||(t[5]=r=>ce(400))},[e(d)&&+p.value==400?h("",!0):(n(),c("img",{key:0,src:e(J)("discharge.svg"),class:"w-[18px] h-[18px]"},null,8,ns)),o("span",null,l(e(d)&&+p.value==400?"放电中":"放电"),1),e(d)&&+p.value==400?(n(),F(X,{key:1})):h("",!0)],2),o("div",{class:_(["btn-power text-b6 w-full h-[46px] rounded-full border-none text-base font-semibold flex items-center justify-center",{"opacity-60":e(ae)||e(y)||e(d)&&+p.value!=200}]),onClick:t[6]||(t[6]=r=>ce(200))},[e(d)&&+p.value==200?h("",!0):(n(),c("img",{key:0,src:e(J)("charge.svg"),class:"w-[18px] h-[18px]"},null,8,is)),o("span",null,l(e(d)&&+p.value==200?"充电中":"充电"),1),e(d)&&+p.value==200?(n(),F(X,{key:1})):h("",!0)],2)],64))])])]}),_:1})],8,yt)]),_:1},8,["show","teleport","onClickOverlay"])}}}),ks=G(ls,[["__scopeId","data-v-db5a9c72"]]);export{ks as S,bt as a};
