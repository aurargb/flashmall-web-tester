import{_ as Ie}from"./avatarRing2-DK_wiJ33.js";import{_ as Be}from"./information-CvPHPIap.js";import{_ as ce}from"./MCOIN-BOqZVkND.js";import{_ as De,y as Pe,r as V,a2 as $e,be as S,w as Le,bf as te,x as qe,D as Ue,a9 as Ne,K as h,G as m,N as E,B as z,E as se,F as q,X as b,P as t,O as F,H as r,Q as g,I as W,J as ue,a1 as Oe,T as ne,Z as Ve,$ as We}from"./vendor-BlU_hoYl.js";import{C as Me}from"./CommonVanProvider-CDfGVWR4.js";import{_ as Re}from"./OfflineGoods-NsfElKHP.js";import{_ as Ge}from"./OfflineTotalPriceDetail-xGxAmlzQ.js";import{P as He}from"./PaySwitchPop-B-FiDltW.js";import{e as je,o as ze,al as _,r as Je,a4 as Ke,at as re,b as Qe,d as ae,q as I,_ as le,C as Xe,bA as Ze}from"./index-UgIL2Smv.js";import{D as Ye}from"./DividingLine-BGr5Dv2u.js";import{P as eo}from"./PaymentMethodSelector-Dn-1pqSq.js";import{u as oo}from"./usePaymentBalance-BSJrmoFe.js";import{_ as J}from"./SubmitApprove-DXvMhooF.js";import{S as to}from"./shop-CeqcS6K2.js";import{P as B}from"./order-H59PKTFP.js";import{P as so}from"./flashSale-DDyqLyYN.js";import{a as y,q as uo,b as no,c as ro,d as ao,e as lo}from"./payHelp-ChvRnkcp.js";import{u as co}from"./order-ClP3Ze4h.js";import"./BackIcon-8hcEjDKb.js";import"./offlineGoods-DvT2Go6q.js";import"./ImgBoutiqueLable-BIio6fYG.js";import"./USDT-CNsbs3BR.js";import"./FMCP-yoa9RTPy.js";import"./point-arrow-BXwQ0Ukh.js";import"./usePointRelase-DAfmIzgK.js";import"./piggyBank-swFyWePk.js";const D=U=>(Ve("data-v-d660bbec"),U=U(),We(),U),io={key:2},po={class:"page-body overflow-y-auto"},mo={class:"bg-b6 rounded-xl p-3"},fo={class:"flex items-center gap-x-1"},yo=D(()=>r("div",{class:"w-[30px] h-[30px] bg-b5 rounded-full"},[r("img",{src:Ie})],-1)),ho={class:"text-b2"},vo=D(()=>r("img",{src:Be,class:"w-4 h-4"},null,-1)),bo=[vo],go={class:"flex items-center justify-center gap-x-1 mt-2.5 h-10"},Ao=D(()=>r("img",{src:ce,class:"w-[17px] h-[17px]"},null,-1)),_o={class:"text-b1 text-[28px] font-bold"},wo={class:"bg-b6 rounded-xl p-3 mt-3"},To={class:"text-b3"},Eo={class:"flex items-center"},Fo=D(()=>r("img",{src:ce,class:"w-4 h-4 mr-1.5"},null,-1)),ko={class:"text-b1 font-normal"},xo={class:"flex-center-bw gap-x-3 py-4"},Co={class:"relative flex-1"},So={class:"flex items-center justify-center gap-x-0.5"},Io={class:"font-Puhui"},Bo={class:"text-b1 font-semibold text-center"},Do={class:"font-Puhui"},Po=D(()=>r("div",{class:"text-b1 text-base font-semibold text-center"}," 帮朋友代付说明 ",-1)),$o=D(()=>r("ul",{class:"text-b2 text-sm font-normal flex flex-col gap-y-2 mt-5"},[r("li",null," 1.使用代付功能付款时，将使用您的账户资产及抵用券支付订单款项； "),r("li",null," 2.若订单产生退款，已支付的款项与抵用券将按原路径退回至您的账户； "),r("li",null," 3.付款前请务必与亲友核实确认相关信息，提高警惕，谨防诈骗风险。 ")],-1)),Lo=Pe({setup(U){const{loadingToggle:K}=Je(),ie=$e(),P=V(ie.query.payId),[pe,Q]=S(!0),X=V(!1),{accountStore:i}=je(),{balanceState:k,getPaymentOptions:me,fetchAllBalances:de,autoSelectPaymentMethod:fe,checkSufficientBalance:Z}=oo(X),{submit:ye}=ze(),{t:he}=Le(),[$,x]=S(!1),[ve,M]=S(!1),R=V(null),[be,G]=S(!1),[ge,H]=S(!1),[Ae,j]=S(!1),N=V(0),f=te({0:null,1:null}),e=te({address:null,lockUser:null,status:null,type:null,postscripts:[],detailList:[],totalAmount:null,goods:[],groupGoods:[],createTime:null,countdownTime:null,otherLock:!1}),_e=()=>{const o={approveM:0,approveU:0,approveV:0};return Object.values(f).forEach(s=>{if(!s)return;const u=+(s==null?void 0:s.realTotalAmountShow),n=+(s==null?void 0:s.voucherAmount);switch(s.paySource){case B.WALLET:o.approveM+=u;break;case B.WITHDRAW_POINTS:o.approveV+=n;break;case B.USDT_WALLET:o.approveU+=u;break}}),o},w=qe(()=>_e()),we=(o,s)=>s===B.WITHDRAW_POINTS?Math.min(k.voucherBalance,o):0,Te=(o,s,u=!1)=>{const n=new z(s).times(o||0).times(k.pointSelfRate).div(100).toString(),l=u?new z(n).div(k.pointSelfRate).times(.5).toNumber():0;return{integral:n,voucherAmount:l}},Ee=o=>o.reduce((s,u)=>{const n=u.goodsType!==to.SD;n&&(X.value=!0);const l=s.findIndex(p=>p.boutique===n),c=Te(u==null?void 0:u.goodsTotalPrice,u==null?void 0:u.discountRatio,n);return u.integral=c.integral,u.voucherAmount=c.voucherAmount,l===-1?s.push({boutique:n,paySource:n?B.WITHDRAW_POINTS:B.WALLET,goods:[u],totalAmount:u.goodsTotalPrice,integral:+c.integral,voucherAmount:+c.voucherAmount}):(s[l].goods.push(u),s[l].totalAmount+=u.goodsTotalPrice,s[l].integral+=+c.integral,s[l].voucherAmount+=+c.voucherAmount),s},[]),Fe=o=>{var s,u,n;if(e.address=o==null?void 0:o.address,e.lockUser=(o==null?void 0:o.lockUser)||null,e.status=o==null?void 0:o.status,e.createTime=o==null?void 0:o.createTime,e.type=(s=o==null?void 0:o.submitInfo)==null?void 0:s.type,e.postscripts=(u=o==null?void 0:o.submitInfo)==null?void 0:u.postscripts,e.totalAmount=o==null?void 0:o.totalAmount,o==null||o.orderGoods.forEach(l=>{let c=l;e.goods.push({goodsIcons:c.icons,goodsTotalPrice:+new z(c.price).times(c.number),...l})}),e.groupGoods=Ee(e.goods).sort((l,c)=>Number(l.boutique)-Number(c.boutique)),((n=e.groupGoods)==null?void 0:n.length)===1){const l=fe(e.groupGoods[0].totalAmount,e.groupGoods[0].voucherAmount);e.groupGoods[0].paySource=l}},ke=()=>{var o,s,u,n,l,c;if(f[0]&&f[1]&&((o=f[0])==null?void 0:o.paySource)!==((s=f[1])==null?void 0:s.paySource))for(const p of Object.values(f)){if(!p)return;const v=p==null?void 0:p.paySource,C=+(p==null?void 0:p.realTotalAmountShow);if(!Z(v,C))return R.value=v,M(!0),!1}else{const p=((u=f[0])==null?void 0:u.paySource)||((n=f[1])==null?void 0:n.paySource),v=(((l=f[0])==null?void 0:l.realTotalAmountShow)||0)+(((c=f[1])==null?void 0:c.realTotalAmountShow)||0);if(!Z(p,v))return R.value=p,M(!0),!1}return!0},xe=()=>{var u;let o=[],s=(u=w.value)==null?void 0:u.approveV;e.groupGoods.forEach(n=>{n.goods.forEach(l=>{o.push({goodsId:l.goodsId,num:l.number,payType:so.MC,paySource:n.paySource})})});try{return{type:e==null?void 0:e.type,postscripts:e==null?void 0:e.postscripts,detailList:o,genOrder:!1,voucherAmount:s}}catch{return!1}},Ce=async()=>{x(!0);try{if(!ke())return;const o=xe();if(!o)return;const{success:s,data:u}=await ao(P.value.toString(),o);if(!s)return;const{allOrderId:n,merchants:l,discounts:c,amounts:p,sources:v,buyer:C}=u,T=await ye(n,l,c,p,v,C||e.address);if(!T.success||(ne.loading({message:he("order.wait block chain"),forbidClick:!0,duration:0}),await co({allOrderId:n,hash:T.result.hash}),ne.clear(),!T.result.hash))return;const O=T.result.hash;let A;const L=async()=>{if(N.value>=5){x(!1),N.value=0;return}if(A=await Ze(O),(A==null?void 0:A.status)===1){x(!1),N.value=0,console.log("支付成功：",A),Y();return}setTimeout(async()=>{N.value++,L()},5e3)};L()}finally{x(!1)}},Se=async()=>{x(!0);try{const{success:o}=await lo(P.value);o&&(e.status=y.CANCELLED)}finally{x(!1)}},Y=async()=>{K(!0),Q(!0);const o=P.value;if(o==null||o==="")return;const{success:s,data:u}=await no(o);if(K(!1),Q(!1),!!s&&(Fe(u),console.log(e.status),e.status===y.WAIT)){if((e==null?void 0:e.status)===y.WAIT&&!(e!=null&&e.lockUser)&&(i!=null&&i.account)&&_(e.address)!==_(i==null?void 0:i.account)){const{success:n}=await ro(P.value);if(!n)return;e.lockUser=i.account}if(e.otherLock=(i==null?void 0:i.account)&&(e==null?void 0:e.lockUser)&&_(e==null?void 0:e.lockUser)!==_(i==null?void 0:i.account),(e==null?void 0:e.status)===y.WAIT){const n=await Ke();e.countdownTime=+(e==null?void 0:e.createTime)+15*60*1e3-n*1e3,e.countdownTime<=0&&(e.status=y.TIMEOUT)}e.otherLock&&e.status===y.WAIT&&G(!0)}};return Ue(async()=>{de(),await Y()}),Ne(async()=>{e!=null&&e.lockUser&&(i!=null&&i.account)&&_(e==null?void 0:e.lockUser)===_(i.account)&&e.status===y.WAIT&&uo(P.value)}),(o,s)=>{const u=se("VanButton"),n=se("van-count-down");return m(),h(Me,{title:o.$t("payhelp.payHelp"),class:"bg-gray1 font-Puhui px-3",themeVars:{navBarBackgroundColor:"#F2F0EF","count-down-font-size":"16px"}},{default:E(()=>{var l,c,p,v,C,T,O,A,L,ee,oe;return[t(pe)?b("",!0):(m(),q(W,{key:0},[((l=t(e))==null?void 0:l.status)===t(y).TIMEOUT?(m(),h(re,{key:0,name:"订单超时"})):((c=t(e))==null?void 0:c.status)!==t(y).WAIT?(m(),h(re,{key:1,name:"订单已关闭"})):b("",!0),((p=t(e))==null?void 0:p.status)===t(y).WAIT?(m(),q("div",io,[r("div",po,[r("div",mo,[r("div",fo,[yo,r("div",ho,g(t(Qe)(t(e).address,"...",5,5))+" 喊你帮他代付啦～ ",1),r("div",{onClick:s[0]||(s[0]=a=>t(j)(!0))},bo)]),r("div",go,[Ao,r("span",_o,g(t(ae)((v=t(e))==null?void 0:v.totalAmount)),1)])]),(m(!0),q(W,null,ue(t(e).groupGoods,a=>(m(),q(W,{key:a.boutique},[t(e).type===2?(m(),h(Ye,{key:0,goodsBoutiqueFlag:a.boutique},null,8,["goodsBoutiqueFlag"])):b("",!0),r("div",wo,[(m(!0),q(W,null,ue(a.goods,d=>(m(),h(Re,{key:d.goodsId,goods:d,showGoodsType:"",class:"h-[80px] mb-3 last:mb-0"},{"bottom-left":E(()=>[r("div",To,"共"+g(d.number)+"件，合计:",1)]),"bottom-price":E(()=>[r("div",Eo,[Fo,r("div",ko,g(t(ae)((d==null?void 0:d.goodsTotalPrice)||0)),1)])]),_:2},1032,["goods"]))),128))]),F(eo,{paymentOptions:t(me)(0,a.boutique)||[],loading:t(k).loading,boutique:a.boutique,modelValue:a.paySource,"onUpdate:modelValue":d=>a.paySource=d,class:"mt-3"},null,8,["paymentOptions","loading","boutique","modelValue","onUpdate:modelValue"]),F(Ge,{ref:d=>t(f)[Number(a.boutique)]=d,totalAmount:a.totalAmount,"usdt-rate":t(k).usdtRate,"voucher-price":t(k).voucherBalance,integral:a.integral,voucherAmount:we(a.voucherAmount,a.paySource),paySource:a.paySource},null,8,["totalAmount","usdt-rate","voucher-price","integral","voucherAmount","paySource"])],64))),128))]),r("div",xo,[t(_)((C=t(e))==null?void 0:C.address)===t(_)((T=t(i))==null?void 0:T.account)?(m(),h(u,{key:0,round:"",class:"bg-b6 text-b1 text-base !border !border-solid !border-b4 flex-1 h-[46px]",loading:t($),disabled:(O=t(e))==null?void 0:O.otherLock,onClick:s[1]||(s[1]=a=>t(H)(!0))},{default:E(()=>[Oe(g(o.$t("order.cancelOrder")),1)]),_:1},8,["loading","disabled"])):b("",!0),r("div",Co,[t(w).approveM>0?(m(),h(J,{key:0,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:t(I).order,token:t(I).MCOIN,symbol:"MCOIN",loading:t($),approveAmount:Number(t(w).approveM)},null,8,["contract","token","loading","approveAmount"])):b("",!0),((A=t(w))==null?void 0:A.approveU)>0?(m(),h(J,{key:1,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:t(I).order,token:t(I).USDT,symbol:"USDT",loading:t($),approveAmount:Number(t(w).approveU)},null,8,["contract","token","loading","approveAmount"])):b("",!0),((L=t(w))==null?void 0:L.approveV)>0?(m(),h(J,{key:2,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:t(I).order,token:t(I).FMCP,symbol:o.$t("voucher.voucher"),loading:t($),approveAmount:Number((ee=t(w))==null?void 0:ee.approveV)},null,8,["contract","token","symbol","loading","approveAmount"])):b("",!0),F(u,{round:"",class:"pay-btn btn-yellow w-full h-[46px] text-base font-semibold",loading:t($),disabled:(oe=t(e))==null?void 0:oe.otherLock,onClick:Ce},{default:E(()=>{var a,d;return[r("div",So,[r("span",null,g(o.$t("common.pay")),1),((a=t(e))==null?void 0:a.countdownTime)>0?(m(),h(n,{key:0,time:(d=t(e))==null?void 0:d.countdownTime,format:"mm:ss",onFinish:s[2]||(s[2]=()=>{t(e).status=t(y).TIMEOUT})},null,8,["time"])):b("",!0)])]}),_:1},8,["loading","disabled"])])])])):b("",!0),F(He,{paySource:R.value,show:t(ve),onClose:s[3]||(s[3]=a=>t(M)(!1))},null,8,["paySource","show"]),F(le,{noClose:"",show:t(be),onClose:s[5]||(s[5]=a=>t(G)(!1))},{default:E(()=>[r("div",Io,[r("div",Bo,g(o.$t("payhelp.lockTips")),1),r("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:s[4]||(s[4]=a=>t(G)(!1))},g(o.$t("common.I_see")),1)])]),_:1},8,["show"]),F(le,{noClose:"",show:t(Ae),onClose:s[7]||(s[7]=a=>t(j)(!1))},{default:E(()=>[r("div",Do,[Po,$o,r("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:s[6]||(s[6]=a=>t(j)(!1))},g(o.$t("common.I_see")),1)])]),_:1},8,["show"]),F(Xe,{show:t(ge),title:o.$t("order.cancelOrder"),content:o.$t("order.cancelOrderTips"),showConfirm:!0,showReject:!0,confirmText:o.$t("common.confirm"),noClose:"",onClose:s[8]||(s[8]=a=>t(H)(!1)),onConfirm:s[9]||(s[9]=a=>Se()),onReject:s[10]||(s[10]=a=>t(H)(!1))},null,8,["show","title","content","confirmText"])],64))]}),_:1},8,["title"])}}}),lt=De(Lo,[["__scopeId","data-v-d660bbec"]]);export{lt as default};
