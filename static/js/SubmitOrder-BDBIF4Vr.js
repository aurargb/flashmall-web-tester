import{_ as ye}from"./MCOIN-Bodfn-v1.js";import{y as ge,x as w,B as L,F as k,G as d,H as r,Q as c,a2 as N,P as o,I as Re,_ as Ye,a1 as Qe,l as Xe,w as Ze,r as X,be as re,bf as xe,bq as Je,D as eo,bj as oo,E as fe,K as x,N as ae,O as C,a0 as to,a7 as Ne,Y as so,Z as ro,T as ne}from"./vendor-Ba70TIw4.js";import{C as ao}from"./CommonVanProvider-CqQk6UpZ.js";import{_ as no}from"./OfflineGoods-CAFrr8v4.js";import{_ as lo}from"./OfflineStore-CHdPP1fn.js";import{_ as qe}from"./USDT-Dlu99aCg.js";import{_ as uo}from"./FMCP-f3k58DsE.js";import{d as Z,e as io,o as co,R as mo,r as fo,S as po,q as E,_ as yo,T as go,n as Oe,U as ho,V as vo,W as bo,X as So,Y as _o}from"./index-Bsb9uxb4.js";import{P as T}from"./order-H59PKTFP.js";import{_ as wo}from"./OfflineConsumer-ZZ51-nZD.js";import{O as i,a as $e}from"./offlineGoods-DvT2Go6q.js";import{P as ko}from"./PaymentMethodSelector-BvEUECwM.js";import{u as Ao}from"./usePaymentBalance-D735mm3_.js";import{_ as pe}from"./SubmitApprove-CNBa2udP.js";import{P as Po}from"./PaySwitchPop-DKJ0tEYJ.js";import{S as le}from"./shop-CeqcS6K2.js";import{T as Co,P as To}from"./profileEnum-CXsMKuND.js";import"./BackIcon-DkqwcD_b.js";import"./ImgBoutiqueLable-BMjuak4g.js";import"./avatarRing-CLGxkH-F.js";import"./point-arrow-C6HCTn4p.js";import"./usePointRelase-C3UYc-Ka.js";import"./piggyBank-DHjFTeuA.js";const Io={class:"bg-white mt-3 p-3 rounded-xl"},xo={class:"text-base font-semibold"},No={class:"flex items-start justify-between mt-3"},Oo={class:"text-b3 min-w-fit"},$o={class:"text-right"},Ro={class:"flex items-center justify-end gap-1 font-semibold"},qo={key:0,src:qe,class:"w-4 h-4"},Do={key:1,src:ye,class:"w-4 h-4"},Bo={key:0,class:"text-b3 text-xs"},Vo=r("div",{class:"w-full h-[1px] bg-[#F6F6F5] my-3"},null,-1),Eo={class:"flex items-center justify-between"},Lo={class:"text-b3 min-w-fit"},Fo={class:"text-right"},Uo={class:"flex items-center justify-end gap-1 font-semibold"},Mo={key:0,src:qe,class:"w-4 h-4"},Wo={key:1,src:ye,class:"w-4 h-4"},Go=r("span",{class:"text-b3"},"+",-1),jo=r("img",{src:uo,class:"w-4 h-4"},null,-1),Ko={class:"text-b3 text-xs"},zo=ge({props:{totalAmount:null,usdtRate:null,integral:null,voucherAmount:null,paySource:null},setup(y,{expose:l}){const m=y,q=w(()=>m.totalAmount<=0?0:m.paySource===T.USDT_WALLET?L(m.totalAmount).dividedBy(m.usdtRate):m.totalAmount),p=w(()=>m.voucherAmount>0?L(m.totalAmount).minus(m.voucherAmount).toString():m.totalAmount),I=w(()=>p.value<=0?"":m.paySource===T.USDT_WALLET?L(p.value).dividedBy(m.usdtRate).toString():p.value);return l({realTotalAmount:p,realTotalAmountShow:I}),(g,he)=>(d(),k("div",Io,[r("div",xo,c(g.$t("order.totalPriceDetail")),1),r("div",No,[r("div",Oo,c(g.$t("offline.order_price")),1),r("div",$o,[r("div",Ro,[y.paySource===o(T).USDT_WALLET?(d(),k("img",qo)):(d(),k("img",Do)),r("span",null,c(o(Z)(o(q)||0)),1)]),y.paySource===o(T).USDT_WALLET?(d(),k("div",Bo,c(`(${o(Z)(o(q)||0)} USDT${g.$t("offline.auto_exchange")} ${y.totalAmount||0} MCOIN)`),1)):N("",!0)])]),Vo,r("div",Eo,[r("div",Lo,c(g.$t("common.actual_payment")),1),r("div",Fo,[r("div",Uo,[y.paySource===o(T).USDT_WALLET?(d(),k("img",Mo)):(d(),k("img",Wo)),r("span",null,c(o(Z)(o(I)||0)),1),y.voucherAmount>0?(d(),k(Re,{key:2},[Go,jo,r("span",null,c(o(Z)(y.voucherAmount||0)),1)],64)):N("",!0)]),r("div",Ko,c(g.$t("ecology.estimated get"))+c(o(Z)(y.integral||0))+c(g.$t("common.credit")),1)])])]))}}),Ho=y=>(so("data-v-d50bc37e"),y=y(),ro(),y),Yo={class:"px-3 pb-3 overflow-y-auto relative safe-page-body"},Qo={class:"bg-white rounded-xl p-3"},Xo={class:"flex items-center justify-end gap-x-[1px]"},Zo={class:"input-wrapper"},Jo={key:3,class:"bg-[#FFF8EC] rounded-[10px] p-3 flex items-center justify-between mt-3"},et=Ho(()=>r("div",{class:"flex items-center min-w-fit"},[r("img",{src:ye,class:"w-[22px] h-[22px] mr-1.5"}),r("span",{class:"text-b1"},"MCOIN")],-1)),ot={class:"bg-white rounded-xl px-3 py-4 mt-3"},tt={class:"flex items-center justify-between"},st={class:"text-b1 font-semibold"},rt={class:"relative py-4"},at={class:"font-Puhui"},nt={class:"text-b1 font-semibold text-center"},lt=ge({name:"offlineSubmitOrder"});function ut(y){const l=Qe(),m=Xe(),{t:q}=Ze(),p=w(()=>{var t;return Number((t=l.query)==null?void 0:t.orderType)}),I=w(()=>{var t;return(t=l.query)==null?void 0:t.key}),{accountStore:g,regionStore:he,orderGoodsStore:A}=io(),{loadingToggle:ve}=fo(),{submitOffline:De}=co(),{getUserDhKey:Be,encryptKey:Ve}=mo(),J=X(null),[ee,oe]=re(!1),[Ee,be]=re(!1),[Le,Se]=re(!1),e=xe({goodsNumber:1,inputAmount:null,remark:"",goods:{goodsPrice:0,goodsDiscountRatio:20,goodsType:le.SD,shopId:null},store:{logo:"",storeName:"",discountRatio:20,merchant:"",type:le.SD,id:null},dhKey:null});let a=xe({region:he.country,orderType:null,orderPaySource:null,shopId:void 0,goodsId:void 0,goodsNumber:void 0,price:0,discountRatio:20,orderCustomerAddress:g.account,orderPayAddress:g.account,merchantAddress:null,orderCashierAddress:void 0,orderRemarkEnsFlag:!1,storeId:null,storeName:null});const ue=X(null),F=X(!1),{balanceState:D,paymentOptions:Fe,getPaymentBySource:Ue,fetchAllBalances:_e,autoSelectPaymentMethod:Me,checkSufficientBalance:We}=Ao(F),b=X(T.WITHDRAW_POINTS),ie=w(()=>Ue(b.value)),[we,ke]=re(!1),Ae=X(null);Je(Ae,()=>{ke(!!e.remark)});const Ge=t=>{let s=t.replace(/[^\d.]/g,"");return s=s.replace(/(\..*)\./g,"$1"),s=s.replace(/^(\d*\.?\d{0,4}).*$/,"$1"),s},B=w(()=>{var t;return p.value===i.GOODS?L((t=e==null?void 0:e.goods)==null?void 0:t.goodsPrice).times(e.goodsNumber||0).toNumber():e.inputAmount}),Pe=w(()=>new L(a.discountRatio).times(B.value||0).times(D.pointSelfRate).div(100).toString()),Ce=w(()=>Math.min(D.voucherBalance,new L(Pe.value).div(D.pointSelfRate).times(.5).toNumber())),de=w(()=>b.value===T.WITHDRAW_POINTS?Ce.value:0),ce=t=>{e.goodsNumber=t},me=t=>{b.value=t},je=async()=>{var t,s,f,u,h,v;if(I.value){if((t=A.orderOfflineInfo)!=null&&t.goods&&((s=A.orderOfflineInfo)!=null&&s.goods.goodsId)&&((f=A.orderOfflineInfo)==null?void 0:f.goods.goodsId)===I.value)e.goods=(u=A.orderOfflineInfo)==null?void 0:u.goods;else{const{success:S,data:_}=await _o(I.value.toString());if(!S)return;e.goods=_}(h=e.goods)!=null&&h.shopId&&await Te((v=e.goods)==null?void 0:v.shopId)}},Te=async t=>{var s,f,u,h,v,S,_;if(t){if((s=A.orderOfflineInfo)!=null&&s.store&&((u=(f=A.orderOfflineInfo)==null?void 0:f.store)!=null&&u.id)&&+((v=(h=A.orderOfflineInfo)==null?void 0:h.store)==null?void 0:v.id)==+t)e.store=(S=A.orderOfflineInfo)==null?void 0:S.store;else{const{success:O,data:$}=await So(t);if(!O)return;e.store=$}a.shopId=t,a.merchantAddress=(_=e.store)==null?void 0:_.merchant}},te=[[],[4,30],[10,80],[20,80]],Ie=async()=>{var t,s,f,u,h,v,S,_,O,$,U,M,W,G,j,K,z,H,Y;if(+((t=l.query)==null?void 0:t.amount)>0&&(e.inputAmount=Number(l.query.amount)),!p.value&&((s=l.query)!=null&&s.address)){let R,Q;const{success:se,data:P}=await go((f=l.query)==null?void 0:f.address);if(!se)return;const n=Oe(l.fullPath,"address"),V=Oe(l.fullPath,"caddr");P!=null&&P.id?(Q=P==null?void 0:P.id,R=V&&Ne.toLower(V)!==Ne.toLower(n)?i.CPC.toString():i.MPC.toString()):R=i.PPC.toString(),m.replace({path:"/offlineSubmit",query:{...l.query,orderType:R,key:Q}}),setTimeout(()=>{Ie()});return}switch(p.value){case i.GOODS:await je(),a.discountRatio=(u=e==null?void 0:e.goods)==null?void 0:u.goodsDiscountRatio,F.value=((h=e==null?void 0:e.goods)==null?void 0:h.goodsType)>le.SD;break;case i.PPC:a.discountRatio=Number(((v=l.query)==null?void 0:v.ratio)||.2)*100,a.merchantAddress=(((S=l.query)==null?void 0:S.address)||"").toString(),e.store.merchant=(((_=l.query)==null?void 0:_.address)||"").toString(),F.value=!1;break;case i.MPC:case i.CPC:case i.STORE:await Te(I.value),a.discountRatio=Number((O=l.query)==null?void 0:O.ratio)>0?Number((($=l.query)==null?void 0:$.ratio)||.2)*100:(U=e==null?void 0:e.store)==null?void 0:U.discountRatio,((M=e==null?void 0:e.store)==null?void 0:M.type)>le.SD&&((G=te[(W=e==null?void 0:e.store)==null?void 0:W.type])!=null&&G.length)&&(console.log(te[(j=e==null?void 0:e.store)==null?void 0:j.type],a.discountRatio),F.value=a.discountRatio>=te[(K=e==null?void 0:e.store)==null?void 0:K.type][0]&&a.discountRatio<=te[(z=e==null?void 0:e.store)==null?void 0:z.type][1]);break}p.value!==i.PPC&&((H=e.store)!=null&&H.id)&&g.isLogin&&(e.dhKey=await Be((Y=e.store)==null?void 0:Y.id))},Ke=async()=>{var t,s;switch(a.orderCustomerAddress=g.account,a.orderPayAddress=g.account,a.orderType=p.value,a.price=B.value,a.orderPaySource=b.value,a.orderRemark=e.remark,a.merchantEns=void 0,p.value){case i.GOODS:a.goodsId=I.value.toString(),a.goodsNumber=e.goodsNumber,a.orderRemark=e.remark||void 0;break;case i.PPC:break;case i.MPC:break;case i.CPC:a.orderCashierAddress=(((t=l.query)==null?void 0:t.caddr)||"").toString();break;case i.STORE:break}if(p.value!==i.PPC&&((s=e.store)!=null&&s.id)&&e.remark&&e.dhKey){const{encrypt:f}=Ve(e.remark,e.dhKey);a.orderRemark=f,a.orderRemarkEnsFlag=!0}},ze=async()=>{var t,s;if(B.value<=0)return ne.fail(q("offline.input_pay_amount"));if(!We((t=ie.value)==null?void 0:t.source,(s=J.value)==null?void 0:s.realTotalAmountShow))return be(!0);oe(!0);try{await Ke();const{success:f,data:u}=await ho(a);if(!f){oe(!1);return}const{success:h}=await De(a.merchantAddress,u.orderTotalAmount,a.discountRatio,a.orderPaySource,u.isScanFlag,u.allId);if(!h){oe(!1);return}ne.loading({message:q("order.wait block chain"),forbidClick:!0,duration:0}),await vo({id:u==null?void 0:u.orderId,currentOrderStatus:$e.PAYING}),ne.clear(),u.isScanFlag?Se(!0):(ne({message:q("common.pay success"),icon:bo("toast-success.svg"),duration:3e3,overlay:!0,overlayClass:"toastOverlay",className:"toastCard"}),setTimeout(()=>{m.replace({path:"offlineConsumerorders",query:{status:$e.PAYMENT_SUCCESS}})},3e3))}finally{oe(!1)}},He=()=>{m.replace({path:"profile",query:{path:To.CONSUMER,tab:Co.OFFLINE}})};return eo(async()=>{ve(!0);try{await Promise.all([Ie(),_e()]);const t=Me(B.value,Ce.value);me(t)}catch(t){console.error("Failed to initialize payment method:",t)}finally{ve(!1)}if(l.query.storeId){a.storeId=l.query.storeId;const t=await po({id:l.query.storeId});if(!(t!=null&&t.success))return;ue.value=t.data}}),oo(()=>{A.changeOfflineInfo(null)}),(t,s)=>{const f=fe("van-button"),u=fe("VanField"),h=fe("VanButton");return d(),x(ao,{title:t.$t("order.order"),class:"h-full font-Puhui font-normal relative",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent",fieldInputTextColor:"#585654"}},{default:ae(()=>{var v,S,_,O,$,U,M,W,G,j,K,z,H,Y,R,Q,se,P;return[(v=o(e).goods)!=null&&v.goodsPrice||(S=o(e).store)!=null&&S.merchant?(d(),k(Re,{key:0},[r("div",Yo,[r("div",Qo,[o(p)===o(i).PPC?(d(),x(wo,{key:0,order:{orderCustomerAddress:(O=(_=o(e))==null?void 0:_.store)==null?void 0:O.merchant},showStatus:!1},null,8,["order"])):(d(),x(lo,{key:1,store:{images:(U=($=o(e))==null?void 0:$.store)==null?void 0:U.logo,name:(W=(M=o(e))==null?void 0:M.store)==null?void 0:W.storeName}},null,8,["store"])),o(p)===o(i).GOODS?(d(),x(no,{key:2,class:"mt-3",goods:{...(G=o(e))==null?void 0:G.goods,storeName:((K=(j=o(e))==null?void 0:j.goods)==null?void 0:K.storeName)||((z=ue.value)==null?void 0:z.storeName),areaExtName2:(H=ue.value)==null?void 0:H.areaExtName2}},{"bottom-right":ae(()=>[r("div",Xo,[C(f,{icon:"minus",size:"mini",type:"primary",class:"num-btn w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-l",disabled:+o(e).goodsNumber<=1,onClick:s[0]||(s[0]=n=>ce(+o(e).goodsNumber-1))},null,8,["disabled"]),r("div",Zo,[C(u,{class:"text-center rounded input-box",type:"digit",modelValue:o(e).goodsNumber,"onUpdate:modelValue":[s[1]||(s[1]=n=>o(e).goodsNumber=n),ce]},null,8,["modelValue"])]),C(f,{icon:"plus",size:"mini",type:"primary",class:"w-8 h-8 border-none aspect-square bg-b5 text-b1 rounded-r",onClick:s[2]||(s[2]=n=>ce(+o(e).goodsNumber+1))})])]),_:1},8,["goods"])):(d(),k("div",Jo,[et,C(u,{"input-align":"right",placeholder:t.$t("offline.input_pay_amount"),class:"py-0 pr-0 bg-[transparent]",modelValue:o(e).inputAmount,"onUpdate:modelValue":s[3]||(s[3]=n=>o(e).inputAmount=n),type:"number",formatter:Ge,readonly:+(((Y=o(l).query)==null?void 0:Y.amount)||0)>0},null,8,["placeholder","modelValue","readonly"])]))]),r("div",ot,[r("div",tt,[r("span",st,c(t.$t("order.buyerRemark")),1),o(we)?N("",!0):(d(),k("span",{key:0,class:"text-b3",onClick:s[4]||(s[4]=n=>o(ke)(!0))},c(t.$t("common.pleaseInput"))+c(t.$t("order.remark")),1))]),o(we)?(d(),x(u,{key:0,ref:(n,V)=>{V.remarkRef=n,Ae.value=n},modelValue:o(e).remark,"onUpdate:modelValue":s[5]||(s[5]=n=>o(e).remark=n),type:"textarea",maxlength:"100",class:"!bg-b5 rounded-lg mt-2 p-2"},null,8,["modelValue"])):N("",!0)]),C(ko,{class:"mt-3",modelValue:b.value,"onUpdate:modelValue":s[6]||(s[6]=n=>b.value=n),"payment-options":o(Fe),loading:o(D).loading,boutique:F.value,onChange:me,onGetPointBalance:o(_e)},null,8,["modelValue","payment-options","loading","boutique","onGetPointBalance"]),C(zo,{ref:(n,V)=>{V.priceDetailRedf=n,J.value=n},totalAmount:o(B),"usdt-rate":o(D).usdtRate,"voucher-price":o(D).voucherBalance,integral:o(Pe),voucherAmount:o(de),paySource:b.value,class:"mb-2.5"},null,8,["totalAmount","usdt-rate","voucher-price","integral","voucherAmount","paySource"])]),r("div",rt,[[o(T).WALLET].includes(b.value)?(d(),x(pe,{key:0,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(E).order,token:o(E).MCOIN,symbol:((R=o(ie))==null?void 0:R.symbol)||"MCOIN",loading:o(ee),approveAmount:Number(((Q=J.value)==null?void 0:Q.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):N("",!0),[o(T).USDT_WALLET].includes(b.value)?(d(),x(pe,{key:1,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(E).order,token:o(E).USDT,symbol:((se=o(ie))==null?void 0:se.symbol)||"USDT",loading:o(ee),approveAmount:Number(((P=J.value)==null?void 0:P.realTotalAmountShow)||0)},null,8,["contract","token","symbol","loading","approveAmount"])):N("",!0),o(de)>0?(d(),x(pe,{key:2,class:"btn-yellow w-full h-[46px] rounded-full z-10 absolute",contract:o(E).order,token:o(E).FMCP,symbol:t.$t("voucher.voucher"),loading:o(ee),approveAmount:Number(o(de))},null,8,["contract","token","symbol","loading","approveAmount"])):N("",!0),C(h,{round:"",class:"pay-btn btn-yellow w-full h-[46px]",loading:o(ee),disabled:!o(B),onClick:ze},{default:ae(()=>[to(c(t.$t("common.pay")),1)]),_:1},8,["loading","disabled"])])],64)):N("",!0),C(Po,{"pay-source":b.value,show:o(Ee),onClose:s[7]||(s[7]=n=>o(be)(!1)),onChangePay:s[8]||(s[8]=n=>me(n))},null,8,["pay-source","show"]),C(yo,{show:o(Le),noClose:"",onClose:s[9]||(s[9]=n=>o(Se)(!1))},{default:ae(()=>[r("div",at,[r("div",nt,c(t.$t("common.pay success")),1),r("div",{class:"mt-6 flex-1 h-[46px] leading-[46px] rounded-full text-center bg-yellow",onClick:He},c(t.$t("common.I_see")),1)])]),_:1},8,["show"])]}),_:1},8,["title"])}}const it=ge({...lt,setup:ut}),Rt=Ye(it,[["__scopeId","data-v-d50bc37e"]]);export{Rt as default};
