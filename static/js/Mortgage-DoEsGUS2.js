import{y as fe,w as Ue,E as B,F as p,G as c,H as t,K as S,Q as a,I as ee,J as te,a2 as oe,O as b,N as w,a0 as x,R as he,_ as Ee,r as g,bf as me,be as Oe,z as qe,x as pe,B as je,D as He,l as Ye,P as n,Y as Ze,Z as ze}from"./vendor-Ba70TIw4.js";import{E as Ke}from"./EcologyHeader-CcbDf0pe.js";import{_ as Qe}from"./BgBox-DZkbfzC7.js";import{d as $,s as D,q as E,B as J,aX as ve,aY as ge,aZ as W,c as Xe}from"./index-Bsb9uxb4.js";import{u as Ge}from"./lendingPoolContract-Bv-sHVtI.js";import{e as Je}from"./exchangeContract-BKEn3mjv.js";import"./UserLevel-Cr93-CmE.js";import"./avatarRing-CLGxkH-F.js";import"./UserAsset-93nriisn.js";import"./TokenBalance-Z2S1XeSE.js";import"./bg-dot-DBVQRM9t.js";const We=""+new URL("../images/list_icon-DDBlyCQZ.svg",import.meta.url).href,et=""+new URL("../images/help-qWKu9klx.png",import.meta.url).href,tt={class:"bg-[#FFFDF8] rounded-2xl shadow-inset-2 px-2 py-4 mt-[10px]"},ot={class:"text-base font-semibold flex-start"},at={key:1,class:"pt-6 pb-4 text-center"},st={key:2},nt={class:"flex justify-between items-center border-line pb-[10px]"},lt={class:"text-sm mb-[5px]"},it={class:"opacity-60"},ct={class:"flex-center-bw mb-[10px] mt-[10px]"},dt={class:"text-sm"},ut={class:"font-semibold"},rt={class:"flex-center-bw mb-[10px]"},mt={class:"text-sm"},pt={class:"font-semibold"},vt={class:"flex-center-bw mb-[10px]"},gt={class:"text-sm"},ft={class:"font-semibold"},ht={key:0,class:"flex-center-bw"},yt={class:"text-sm"},_t={class:"font-semibold"},bt={key:1,class:"gap-4 mt-5 font-semibold text-white flex-center"},wt=fe({props:{list:null,authMusdLoading:null,authMusd:null,musdAllowance:null,loading:null},emits:["approveMusd","rollover","repay"],setup(m,{emit:R}){const{t:A}=Ue(),O=async()=>{R("approveMusd")},q=(i,v)=>{R("rollover",i,v)},j=(i,v)=>{R("repay",i,v)},H=i=>{let v="";switch(+i.loanStatus){case 1:v=A("ecology.ongoing");break;case 2:v=A("ecology.overdue");break;case 3:v=A("ecology.Cleared");break}return v};return(i,v)=>{const Y=B("van-skeleton"),M=B("VanButton");return c(),p("div",tt,[t("div",ot,a(i.$t("ecology.my loan history")),1),m.list.length===0&&m.loading?(c(),S(Y,{key:0,row:3,class:"py-4"})):m.list.length===0?(c(),p("div",at,a(i.$t("common.No data yet")),1)):(c(),p("div",st,[(c(!0),p(ee,null,te(m.list,(l,F)=>(c(),p("div",{class:"bg-[#fff9f0] mt-3 rounded-lg p-4",key:l.loanId},[t("div",nt,[t("div",null,[t("div",lt,a(i.$t("ecology.flow id"))+" "+a(l.loanId),1),t("div",it,a(l.startTime),1)]),b(M,{class:he(["btn",{"opacity-30":l.loanStatus===3}])},{default:w(()=>[x(a(H(l)),1)]),_:2},1032,["class"])]),t("div",ct,[t("div",dt,a(i.$t("ecology.loanAmount")),1),t("div",ut,a(l.loanAmount)+" MUSD",1)]),t("div",rt,[t("div",mt,a(i.$t("ecology.initial stake amount")),1),t("div",pt,a(l.collateralAmount)+" MAI",1)]),t("div",vt,[t("div",gt,a(i.$t("ecology.morgage date")),1),t("div",ft,a(l.endTime),1)]),l.loanStatus!==3?(c(),p("div",ht,[t("div",yt,a(i.$t("ecology.Current amount due")),1),t("div",_t,a(l.overdueAmount)+" MUSD",1)])):oe("",!0),l.loanStatus!==3?(c(),p("div",bt,[b(M,{class:"btn-item h-[35px] min-w-[100px] px-4",loading:l.rolloverLoading,disabled:+l.pid==0,onClick:Z=>q(l.loanId,F)},{default:w(()=>[x(a(i.$t("ecology.relloverLoan")),1)]),_:2},1032,["loading","disabled","onClick"]),m.authMusd&&m.musdAllowance>=l.overdueAmount?(c(),S(M,{key:0,class:"btn-item h-[35px] min-w-[100px] px-4",disabled:!m.authMusd,onClick:Z=>j(l.loanId,F),loading:l.loanLoading},{default:w(()=>[x(a(i.$t("ecology.repayLoan")),1)]),_:2},1032,["disabled","onClick","loading"])):(c(),S(M,{key:1,class:"btn-item h-[35px] min-w-[100px] px-4",onClick:O,loading:m.authMusdLoading},{default:w(()=>[x(a(i.$t("assets.auth"))+" MUSD",1)]),_:1},8,["loading"]))])):oe("",!0)]))),128))]))])}}}),ye=m=>(Ze("data-v-e5142d92"),m=m(),ze(),m),xt={class:"relative h-full"},At={class:"bg-[#FFFDF8] rounded-2xl shadow-inset-2 px-2 py-4"},$t={class:"text-base font-semibold mb-[10px] flex justify-between"},Mt=ye(()=>t("img",{src:We,class:"w-3 h-auto mr-1.5"},null,-1)),kt={class:"text-[#3D1A00] text-sm font-semibold"},Lt={key:1,class:"grid grid-cols-3 gap-4"},Rt={key:2,class:"flex-start w-full rounded-[10px] bg-[#fff9f0] p-[10px] mt-[10px] mb-[18px]"},Ct=ye(()=>t("img",{class:"w-[18px] mr-[10px]",src:et},null,-1)),It={class:"opacity-60 default"},Dt={class:"flex-center-bw"},Bt={class:"text-base font-semibold flex-start"},St={class:"bg-[#fff9f0] mt-3 rounded-lg p-2"},Ft={class:"flex items-center justify-end gap-2 mt-2"},Pt=["onClick"],Nt={class:"mt-[20px]"},Tt={class:"text-base font-semibold"},Vt={class:"flex-center-bw mb-[10px] mt-[10px]"},Ut={class:"font-semibold"},Et={class:"font-medium"},Ot={class:"flex-center-bw mb-[10px] mt-[10px]"},qt={class:"font-semibold"},jt={class:"font-medium"},Ht={class:"flex-center-bw mb-[10px]"},Yt={class:"font-semibold"},Zt={class:"font-medium"},zt={class:"flex-center-bw mb-[10px]"},Kt={class:"font-semibold"},Qt={class:"font-medium"},Xt={class:"flex-center-bw"},Gt={class:"font-semibold"},Jt={class:"font-medium"},Wt={class:"mt-5 font-semibold text-white flex-center"},eo=fe({setup(m){const R=Ye(),{maiAddress:A,rollover:O,repay:q,loans:j,getLoanIds:H,borrow:i,musdAddress:v,poolInfo:Y,ONE_DAY:M,poolLength:l,tokenCollateralRates:F,overdueTimes:Z,getPenaltyAmount:_e}=Ge(),{lastPrice:be}=Je(),f=g(null),s=me({percents:[{name:"25%",value:.25},{name:"50%",value:.5},{name:"75%",value:.75},{name:"MAX",value:1}],token0:"USDT",token1:"MUSD",balance0:0,balance1:0,resouceAmount:null,allowanceAmount:0,toAmount:0,authLoading:!1,isAuth:!1,exchangeLoading:!1,maiBalance:null,isAuthMai:!1,isAuthMusd:!1,authMusdLoading:!1,tokenCollateralRates:2.572}),[to,ae]=Oe(!1),we=me({7:0,90:15,180:30,365:65});qe(()=>f.value,e=>{s.isAuthMai=+s.allowanceAmount>=+e&&s.allowanceAmount>0},{immediate:!0,deep:!0});const xe=e=>{R.push(e)},se=e=>Math.ceil(e*1e5)/1e5,Ae=e=>{f.value=$(e*re.value/s.tokenCollateralRates)},ne=g(0),le=async()=>{const e=await(await D(await v())).allowance(E.lendingPool);s.isAuthMusd=+e.result>0,ne.value=e.result||0},ie=async()=>{const e=await await D(await A()).allowance(E.lendingPool);s.isAuthMai=+e.result>0,s.allowanceAmount=e.result||0},$e=async()=>{s.authLoading=!0;const e=await D(await A()).approve(E.lendingPool);s.authLoading=!1,e.success&&ie()},Me=async()=>{s.authMusdLoading=!0;const{approve:e}=D(await v()),o=await e(E.lendingPool);s.authMusdLoading=!1,o.success&&le()},ce=async()=>{ae(!0),s.maiBalance=+await D(await A()).balanceOf(),re.value=s.maiBalance,ae(!1)},P=g(1),de=g(1),h=g([]),ke=async()=>{const e=await l();h.value=[];let o=[];for(let u=0;u<e.result;u++){const r=await Re(u);o.push(r)}h.value=o.sort((u,r)=>u.pid-r.pid),P.value=h.value[1].pid},C=pe(()=>h.value[de.value]),z=g(null),Le=async()=>{z.value=+await M()},Re=async e=>{const o=await Y(e);if(o.success)return{pid:e,duration:o.result.duration,interestRate:o.result.interestRate/1e3,penaltyRate:o.result.penaltyRate/1e3,rowInterestRate:o.result.interestRate,rowPenaltyRate:o.result.penaltyRate}},Ce=(e,o)=>{P.value=e.pid,de.value=o},ue=g(0),Ie=async()=>{ue.value=+await be()},re=g(0),K=g(!1),De=pe(()=>{const e=new je(s.maiBalance||0).div(s.tokenCollateralRates);return $(e)}),Be=async()=>{K.value=!0;const e=await i(P.value,f.value);K.value=!1,e.success&&(f.value=null,ce(),T())};let k=g([]);const Q=g([]),N=g(!0),T=async()=>{N.value=!0;const e=await H();if(Q.value=[],!e.success||!e.result.length){N.value=!1;return}for(let o=0;o<e.result.length;o++){const u=e.result[o],r=await Se(u);Q.value.push(r)}k.value=Q.value,N.value=!1},X=e=>{let o=Math.ceil(e*1e3)/1e3;return o=+o.toFixed(3),o},Se=async e=>{const o=await j(e);if(!o.success)return;const u=h.value.findIndex(_=>_.pid===+o.result.pid),r=+(o.result.dueTime||0),G=r-h.value[u].duration,d=h.value[u],L=await Z(+o.result.pid),I=new Date().getTime()/1e3;let V=null;+o.result.status==2?V=3:V=new Date().getTime()<r*1e3?1:2;let U=0;const y=Number(J(o.result.loanAmount));if(I<r-Number(L)){const _=2*(y*d.rowInterestRate)/1e5;U=+e<1595?y:+X(y+_)}else if(I>=r-Number(L)&&V===1){const _=Number(y*d.rowInterestRate)/1e5;U=+e<1595?y:+X(y+_)}else if(I>r){const{result:_}=await _e(o.result.loanAmount.toString(),o.result.dueTime.toString(),Math.ceil(I),d.rowPenaltyRate),Ve=y+Number(y*d.rowInterestRate/1e5)+Number(J(_));U=+e<1595?y+Number(J(_)):+X(Ve)}return{interestRate:d.interestRate,loanId:e,...o.result,loanAmount:$(ge(o.result.loanAmount)),collateralAmount:$(ge(o.result.collateralAmount)),startTime:ve(G),endTime:ve(r),loanStatus:V,loanLoading:!1,rolloverLoading:!1,overdueAmount:U}},Fe=async(e,o)=>{k.value[o].loanLoading=!0;const u=await q(e);k.value[o].loanLoading=!1,u.success&&T()},Pe=async(e,o)=>{k.value[o].rolloverLoading=!0;const u=await O(e);k.value[o].rolloverLoading=!1,u.success&&T()},Ne=async()=>{s.tokenCollateralRates=await F()},Te=async()=>{ce(),await Le(),ie(),le(),Ne(),await Ie(),await ke(),T()};return He(async()=>{Te()}),(e,o)=>{const u=B("van-skeleton"),r=B("VanButton"),G=B("VanField");return c(),p("div",xt,[b(Ke),b(Qe,{icon:"images/ecology/stake.png",text:e.$t("ecology.calculateCurrency")},{default:w(()=>[t("div",At,[t("div",$t,[x(a(e.$t("ecology.lendingDuration"))+" ",1),t("div",{onClick:o[0]||(o[0]=d=>xe("/ecology-liquidation")),class:"flex items-center py-1 pl-3 pr-1 bg-[#FED73A] rounded-l-xl -mr-2"},[Mt,t("span",kt,a(e.$t("ecology.Loans to be liquidated")),1)])]),h.value.length===0?(c(),S(u,{key:0,class:"mb-3",row:3})):(c(),p("div",Lt,[(c(!0),p(ee,null,te(h.value.slice(1),(d,L)=>(c(),S(r,{class:he(["text-sm font-medium h-[35px] px-4 rounded pool-btn",{"hover-bg":d.pid===P.value}]),key:L,onClick:I=>Ce(d,L+1)},{default:w(()=>[x(a((z.value?n(W)(d.duration/z.value,!0):n(W)(d.duration))+e.$t("ecology.day")),1)]),_:2},1032,["class","onClick"]))),128))])),n(C)?(c(),p("div",Rt,[Ct,t("div",It,[t("div",null,a(e.$t("ecology.borrowingCosts"))+"："+a(n($)(n(C).interestRate)||"-")+"% ",1),t("div",null,a(e.$t("ecology.Overdue penalty interest"))+"："+a(n(C).penaltyRate||"-")+"% ",1),t("div",null,a(e.$t("ecology.Additional",{day:n(we)[n(W)(n(C).duration)]||0}))+"："+a(n($)(n(C).interestRate)||"-")+"% ",1),t("div",null,a(e.$t("ecology.borrowingfeesreturn")),1)])])):oe("",!0),t("section",null,[t("div",Dt,[t("div",Bt,a(e.$t("ecology.loanAmount")),1)]),t("div",St,[b(G,{class:"text-[18px] bg-[#fff9f0] font-bold","input-align":"left",modelValue:f.value,"onUpdate:modelValue":o[1]||(o[1]=d=>f.value=d),type:"number",placeholder:e.$t("ecology.maxLoanAmount",{amount:n(De)||0})+"MUSD"},null,8,["modelValue","placeholder"]),t("div",Ft,[(c(!0),p(ee,null,te(n(s).percents,d=>(c(),p("div",{class:"text-xs text-oriange1 border border-solid border-oriange1 rounded-md px-1 py-[2px] hover:bg-[#ffcd89]",key:d.value,onClick:L=>Ae(d.value)},a(d.name),9,Pt))),128))])])]),t("div",Nt,[t("span",Tt,a(e.$t("ecology.loan preview")),1),t("div",Vt,[t("div",Ut,a(e.$t("ecology.collateralAssets")),1),t("div",Et,a(se(f.value*n(s).tokenCollateralRates||0))+" MAI ",1)]),t("div",Ot,[t("div",qt,a(e.$t("ecology.mortgageable assets")),1),t("div",jt,a(n(Xe)(n($)(n(s).maiBalance||0)))+" MAI ",1)]),t("div",Ht,[t("div",Yt,a(e.$t("ecology.collateralPrice")),1),t("div",Zt,a(se((f.value||0)*n(s).tokenCollateralRates*ue.value))+" MUSD ",1)]),t("div",zt,[t("div",Kt,a(e.$t("ecology.loanAmount")),1),t("div",Qt,a(f.value||0)+" MUSD",1)]),t("div",Xt,[t("div",Gt,a(e.$t("ecology.actualArrival")),1),t("div",Jt,a(f.value||0)+" MUSD",1)])]),t("div",Wt,[b(r,{class:"btn h-[35px] min-w-[100px] px-4 mr-4",disabled:n(s).isAuthMai,loading:n(s).authLoading,onClick:$e},{default:w(()=>[x(a(e.$t("assets.auth"))+" MAI",1)]),_:1},8,["disabled","loading"]),b(r,{class:"btn h-[35px] min-w-[100px] px-4",loading:K.value,disabled:!n(s).isAuthMai||n(s).authLoading,onClick:Be},{default:w(()=>[x(a(e.$t("ecology.submitApplication")),1)]),_:1},8,["loading","disabled"])])]),b(wt,{list:n(k),loading:N.value,authMusd:n(s).isAuthMusd,musdAllowance:ne.value,authMusdLoading:n(s).authMusdLoading,onApproveMusd:Me,onRepay:Fe,onRollover:Pe},null,8,["list","loading","authMusd","musdAllowance","authMusdLoading"])]),_:1},8,["text"])])}}}),go=Ee(eo,[["__scopeId","data-v-e5142d92"]]);export{go as default};
