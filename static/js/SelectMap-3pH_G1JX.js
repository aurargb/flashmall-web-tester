import{_ as N,y as H,l as ue,x as P,E as A,F as x,G as h,O as $,H as p,Q as ne,P as le,N as T,a0 as we,Y as ie,Z as de,r as v,I as ke,J as be,K as q,R as $e,a1 as pe,D as fe,a9 as De,a2 as Le,T as C}from"./vendor-Ba70TIw4.js";import{C as Me}from"./CommonVanProvider-CqQk6UpZ.js";import{u as Re}from"./useCityMap-VHv5LiO4.js";import{e as me}from"./index-Bsb9uxb4.js";import{P as z,L as re,S as ce}from"./iconAssets-DyRcdBzl.js";import{_ as Fe}from"./SearchBar-CoFSgoIo.js";import"./BackIcon-DkqwcD_b.js";import"./localMark-D3Prsc6Q.js";import"./search-C4fLtTfY.js";import"./delete-BlDblrKv.js";const Ee=u=>(ie("data-v-288c2402"),u=u(),de(),u),Be={class:"w-full h-[158px] bg-white rounded-xl p-4 shadow-[0_0.5px_16px_0_rgba(0,0,0,0.16)]"},Se={key:0,class:"w-full h-full flex justify-center items-center"},Ae={key:1,class:"h-full flex flex-col justify-between"},Te={class:"shop-name flex items-center justify-between"},Ue={class:"text-base text-b1 font-semibold line-clamp-1"},je={class:"shop-desc mt-1"},ze={class:"text-b3 text-sm line-clamp-2"},Pe=we(" 确认选择 "),Ve={key:2,class:"w-full h-full flex justify-center items-center"},Ne=Ee(()=>p("span",{class:"text-base text-b3 font-normal"},"暂无结果",-1)),He=[Ne],qe=H({props:{storeInfo:null,loading:{type:Boolean},emptyFlag:{type:Boolean}},emits:["handleConfirm"],setup(u,{emit:D}){const i=u;ue();const{getLeafletjsAddressTitle:d,getLeafletjsAddressDescription:o}=Re(),g=P(()=>i.storeInfo?d(i.storeInfo):""),_=P(()=>i.storeInfo?o(i.storeInfo):""),r=()=>{console.log("confirmSelect"),D("handleConfirm",{...i.storeInfo,title:g.value,description:_.value})};return(f,y)=>{const l=A("van-loading"),s=A("VanButton");return h(),x("div",Be,[u.loading?(h(),x("div",Se,[$(l,{class:"shrink-0",size:"40"})])):u.emptyFlag?(h(),x("div",Ve,He)):(h(),x("div",Ae,[p("div",null,[p("div",Te,[p("div",Ue,ne(le(g)),1)]),p("div",je,[p("p",ze,ne(le(_)),1)])]),$(s,{class:"shrink-0 w-full h-[46px] rounded-full border border-solid border-[#000] bg-btnOrBg text-b1 text-base font-semibold",onClick:r},{default:T(()=>[Pe]),_:1})]))])}}}),V=N(qe,[["__scopeId","data-v-288c2402"]]),Ke={class:"swiper-card-container"},Ze={class:"card-wrapper"},Oe={props:{cardData:{type:Array,default:()=>[]}},emits:["changeIndex","handleConfirm"],setup(u,{expose:D,emit:i}){const d=v(null),o=v(0),g=r=>{o.value=r,i("changeIndex",r)};return D({activeIndex:o,updateActiveIndex:r=>{o.value=r,d.value&&d.value.swipeTo(r)}}),(r,f)=>{const y=A("van-swipe-item"),l=A("van-swipe");return h(),x("div",Ke,[$(l,{ref:(s,n)=>{n.swiperRef=s,d.value=s},active:o.value,"onUpdate:active":f[1]||(f[1]=s=>o.value=s),loop:!1,"show-indicators":!1,touchable:!0,class:"custom-swiper",onChange:g},{default:T(()=>[(h(!0),x(ke,null,be(u.cardData,(s,n)=>(h(),q(y,{key:s.id,class:$e(["swipe-item",{right:o.value+1===n,left:o.value-1===n}])},{default:T(()=>[p("div",Ze,[$(V,{storeInfo:s,onHandleConfirm:f[0]||(f[0]=B=>i("handleConfirm",B))},null,8,["storeInfo"])])]),_:2},1032,["class"]))),128))]),_:1},8,["active"])])}}},Ge=N(Oe,[["__scopeId","data-v-def9542e"]]),Je=u=>(ie("data-v-6cc1cdb1"),u=u(),de(),u),Qe={class:"w-full h-full relative"},Ye=Je(()=>p("div",{id:"map",class:"w-full h-full relative z-0"},null,-1)),We={class:"absolute bottom-[12px] left-0 right-0 z-10"},Xe={key:1,class:"w-full flex justify-center items-center"},et={class:"shrink-0 w-[335px]"},tt={key:2,class:"w-full flex justify-center items-center"},at={class:"shrink-0 w-[335px]"},ot=H({emits:["handleConfirm"],setup(u,{expose:D,emit:i}){const d=pe(),{cityMapStore:o}=me(),g=v(null),_=v(0),r=v([]),f=v(null),y=v(!1),l=v(null),s=v("current");let n=null,B=16,R=null,F=[];const K=P(()=>{var e,a,t,c,m,w,M,E;return(e=d.query)!=null&&e.lng&&((a=d.query)!=null&&a.lat)?{lng:+((t=d.query)==null?void 0:t.lng),lat:+((c=d.query)==null?void 0:c.lat)}:(m=o.locationCoords)!=null&&m.lng&&((w=o.locationCoords)!=null&&w.lat)?{lng:o.locationCoords.lng,lat:o.locationCoords.lat}:{lng:((M=o.currentActiveCity)==null?void 0:M.areaLongitude)||"",lat:((E=o.currentActiveCity)==null?void 0:E.areaLatitude)||""}}),ve=e=>new Promise(a=>setTimeout(a,e)),U=(e,a=2,t=1e3)=>{const c=async m=>{try{return await(await fetch(e)).json()}catch{return m>0?(await ve(t),c(m-1)):(C.clear(),C.fail("街道信息查询失败"),null)}};return c(a)},he=()=>{C.loading({message:"地图初始化...",duration:0});try{const e=K.value;n=L.map("map",{center:[e.lat,e.lng],zoom:12,trackResize:!0,zoomControl:!1}),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"",subdomains:"abcd",maxZoom:17,minZoom:7}).addTo(n),n.on("click",function(a){console.log("mapClick",a),s.value="current";const t=a.latlng.lat,c=a.latlng.lng;S(),F.forEach((m,w)=>{m.setIcon(z)}),R=L.marker([t,c],{icon:re}).addTo(n),Z(t,c)}),setTimeout(()=>{_e()})}catch{C.fail("地图初始化失败")}finally{C.clear()}},_e=async()=>{let e="",a="";if(o.selectedMap)e=o.selectedMap.lat,a=o.selectedMap.lng;else{const t=K.value;e=t.lat,a=t.lng}e&&a&&(S(),R=L.marker([e,a],{icon:re}).addTo(n),n.flyTo([e,a],B,{duration:.8,easeLinearity:1}),Z(e,a))},ge=()=>{const e=r.value[_.value];e&&e.lat&&e.lng&&n.flyTo([e.lat,e.lng],B,{duration:.8,easeLinearity:1})},Z=async(e,a)=>{y.value=!0;try{const t=await U(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e}&lon=${a}&addressdetails=1&accept-language=zh-CN`);y.value=!1,O(e,a,t)}catch(t){console.error("获取地理信息失败:",t),y.value=!1,O(e,a,null)}},O=(e,a,t)=>{console.log("displayLocationInfo",t),t?(f.value={lat:+t.lat,lng:+t.lon,name:t.name,display_name:t.display_name,address:t.address},l.value={lat:+t.lat,lng:+t.lon,name:t.name,display_name:t.display_name,address:t.address}):(f.value=null,s.value="empty")},ye=()=>{Q(),r.value.forEach((e,a)=>{if(e.lat&&e.lng){const t=a===_.value?ce:z,c=L.marker([e.lat,e.lng],{icon:t}).addTo(n);c.on("click",()=>{s.value="list",S(),j(a,!0)}),F.push(c)}})},G=()=>{F.forEach((e,a)=>{const t=a===_.value?ce:z;e.setIcon(t)})},Ce=async(e="")=>{var w,M,E,Y,W,X,ee,te,ae,oe,se;s.value="list",C.loading();let a=(M=(w=l.value)==null?void 0:w.address)==null?void 0:M.country,t=(Y=(E=l.value)==null?void 0:E.address)==null?void 0:Y.country_code,c=((X=(W=l.value)==null?void 0:W.address)==null?void 0:X.state)||((te=(ee=l.value)==null?void 0:ee.address)==null?void 0:te.region),m=(se=(oe=(ae=l.value)==null?void 0:ae.address)==null?void 0:oe.postcode)==null?void 0:se.slice(0,4);m&&(m+="00");try{const I=await Promise.all([U(`https://nominatim.openstreetmap.org/search?format=jsonv2&amenity=${encodeURI(e)}&state=${encodeURI(c)}&postalcode=${encodeURI(m)}&country=${encodeURI(a)}&country_code=${encodeURI(t)}&addressdetails=1&accept-language=zh-CN&extratags=1`),U(`https://nominatim.openstreetmap.org/search?format=jsonv2&street=${encodeURI(e)}&state=${encodeURI(c)}&postalcode=${encodeURI(m)}&country=${encodeURI(a)}&country_code=${encodeURI(t)}&addressdetails=1&accept-language=zh-CN&extratags=1`)]);console.log("搜索结果",I),C.clear();let k=[];I[0]&&I.length&&(k=k.concat(I[0])),I[1]&&I[1].length&&(k=k.concat(I[1])),k=Array.from(new Map(k.map(b=>[b.osm_id,b])).values()),k.length?r.value=k.map(b=>({lat:+b.lat,lng:+b.lon,name:b.name,display_name:b.display_name,address:b.address})):(C.fail("暂无结果"),s.value="empty"),ye(),j(0)}catch(I){console.error("搜索失败:",I),C.clear()}},j=(e,a=!1)=>{_.value=e,a&&g.value&&g.value.updateActiveIndex(e),ge(),a?G():setTimeout(()=>{G()},600)},Ie=()=>{J(),r.value=[],_.value=0},J=()=>{F.forEach(e=>{n&&n.removeLayer(e)}),F=[]},S=()=>{R&&n&&(n.removeLayer(R),R=null)},Q=()=>{J(),S()},xe=()=>{Q(),n&&(n.remove(),n=null)};return fe(async()=>{he()}),De(()=>{xe()}),D({searchKeyword:Ce,clearArrData:Ie}),(e,a)=>(h(),x("div",Qe,[Ye,p("div",We,[s.value==="list"?(h(),q(Ge,{key:0,ref:(t,c)=>{c.mapSearchResultList=t,g.value=t},"card-data":r.value,onChangeIndex:j,onHandleConfirm:a[0]||(a[0]=t=>i("handleConfirm",t))},null,8,["card-data"])):s.value==="current"?(h(),x("div",Xe,[p("div",et,[$(V,{storeInfo:f.value,loading:y.value,onHandleConfirm:a[1]||(a[1]=t=>i("handleConfirm",t))},null,8,["storeInfo","loading"])])])):s.value==="empty"?(h(),x("div",tt,[p("div",at,[$(V,{"empty-flag":"",onHandleConfirm:a[2]||(a[2]=t=>i("handleConfirm",t))})])])):Le("",!0)])]))}}),st=N(ot,[["__scopeId","data-v-6cc1cdb1"]]),nt={class:"h-[calc(100vh-50px)] w-full overflow-hidden"},lt={class:"px-3 pb-3"},rt={class:"h-[calc(100vh-50px-48px)] bg-[#F2F0EF]"},gt=H({setup(u){pe();const D=ue(),{cityMapStore:i}=me();v(!1);const d=v(null),o=v({keyword:""}),g=()=>{if(!o.value.keyword)return C.fail("请输入街道名称");d.value.searchKeyword(o.value.keyword)},_=()=>{d.value.clearArrData()},r=f=>{i.setSelectedMap(f),D.back()};return fe(()=>{}),(f,y)=>(h(),q(Me,{title:"地图选点",class:"bg-white font-Puhui font-normal relative","theme-vars":{"field-placeholder-text-color":"#A6A6A6",navBarBackgroundColor:"#fff"},ref:(l,s)=>{s.searchRef=l}},{default:T(()=>[p("div",nt,[p("div",lt,[$(Fe,{modelValue:o.value.keyword,"onUpdate:modelValue":y[0]||(y[0]=l=>o.value.keyword=l),placeholder:"请输入街道名称","search-button-text":"搜索",onSearch:g,onClear:_},null,8,["modelValue"])]),p("section",rt,[$(st,{ref:(l,s)=>{s.mapRef=l,d.value=l},onHandleConfirm:r},null,512)])])]),_:1},512))}});export{gt as default};
