import{y as te,F as _,G as u,a4 as W,H as r,_ as Z,l as oe,x as se,P as D,a2 as V,Q as T,r as p,E as O,O as q,N as H,I as z,J as ee,K as N,R as de,z as ue,D as le,a9 as fe,T as ae,Y as ve,Z as pe,a0 as me,X as G,a1 as ie,bq as he,bc as ge,bd as ye}from"./vendor-Ba70TIw4.js";import{C as _e}from"./CommonVanProvider-CqQk6UpZ.js";import{u as ne}from"./useCityMap-Ct9b_yYY.js";import{e as Q,aq as xe,aL as Ie,aM as Ce,ao as Le,ap as be}from"./index-DiRx6UeW.js";import{S as re,P as ce,L as we}from"./iconAssets-DyRcdBzl.js";import{O as ke}from"./OfflineMerchantLabel-BUhxSfcn.js";import{_ as Ae}from"./SearchBar-CoFSgoIo.js";import"./BackIcon-DkqwcD_b.js";import"./localMark-D3Prsc6Q.js";import"./search-C4fLtTfY.js";import"./delete-BlDblrKv.js";const $e=""+new URL("../images/add-BGs4QptK.svg",import.meta.url).href,Fe=r("img",{src:$e,class:"w-4 h-4"},null,-1),Ee=r("p",{class:"text-xs font-normal text-b2"},"加店",-1),Se=[Fe,Ee],Me=te({emits:["handleTo"],setup(n,{emit:m}){return(x,a)=>(u(),_("div",{class:"w-[44px] h-[44px] bg-white rounded-lg flex flex-col items-center justify-center",onClick:a[0]||(a[0]=W(s=>m("handleTo","/city/merchantCreate"),["stop"]))},Se))}}),Te={class:"w-full flex gap-2"},Be={class:"shrink-0 w-[80px] h-[80px] rounded-lg overflow-hidden"},De=["src"],qe={class:"w-full flex flex-col justify-between"},Ne={class:"shrink-0"},ze={class:"text-base text-b1 font-semibold line-clamp-1"},Pe={class:"mt-1 text-b3 text-sm font-normal line-clamp-1"},Ve={key:0,class:"w-full text-right text-b3 text-sm font-normal line-clamp-1"},Oe={props:{storeInfo:{type:Object,default:()=>({})}},setup(n){const m=n,x=oe(),{distanceFormat:a}=ne(),{cityMapStore:s}=Q(),b=se(()=>{var o,h;return(o=m.storeInfo)!=null&&o.storeIcons?(h=m.storeInfo)==null?void 0:h.storeIcons.split(","):[]}),w=()=>{x.push(`/city/poi/storefront?storeId=${m.storeInfo.storeId}&child=1`)};return(o,h)=>{var c,I,v,C,g,y;return u(),_("div",{class:"w-full h-fit bg-white rounded-xl p-3 shadow-[0_0.5px_16px_0_rgba(0,0,0,0.16)]",onClick:w},[r("div",Te,[r("div",Be,[r("img",{src:D(b)[0],alt:"shop",class:"w-full h-full object-cover"},null,8,De)]),r("div",qe,[r("div",Ne,[r("div",ze,T(((c=n.storeInfo)==null?void 0:c.storeName)||""),1),r("div",Pe,T(((I=n.storeInfo)==null?void 0:I.storeAddress)||""),1)]),(v=n.storeInfo)!=null&&v.distance&&((C=D(s).locationCoords)!=null&&C.lat)&&((g=D(s).locationCoords)!=null&&g.lng)?(u(),_("div",Ve,T(D(a)((y=n.storeInfo)==null?void 0:y.distance)),1)):V("",!0)])])])}}},Re=Z(Oe,[["__scopeId","data-v-1d29f93e"]]),je={class:"swiper-card-container"},Ue={class:"card-wrapper"},Ke={props:{cardData:{type:Array,default:()=>[]}},emits:["changeIndex"],setup(n,{expose:m,emit:x}){const a=p(null),s=p(0),b=o=>{s.value=o,x("changeIndex",o)};return m({activeIndex:s,updateActiveIndex:o=>{s.value=o,a.value&&a.value.swipeTo(o)}}),(o,h)=>{const c=O("van-swipe-item"),I=O("van-swipe");return u(),_("div",je,[q(I,{ref:(v,C)=>{C.swiperRef=v,a.value=v},active:s.value,"onUpdate:active":h[0]||(h[0]=v=>s.value=v),loop:!1,"show-indicators":!1,touchable:!0,class:"custom-swiper",onChange:b},{default:H(()=>[(u(!0),_(z,null,ee(n.cardData,(v,C)=>(u(),N(c,{key:v.id,class:de(["swipe-item",{right:s.value+1===C,left:s.value-1===C}])},{default:H(()=>[r("div",Ue,[q(Re,{"store-info":v},null,8,["store-info"])])]),_:2},1032,["class"]))),128))]),_:1},8,["active"])])}}},Ge=Z(Ke,[["__scopeId","data-v-968bef2c"]]),He=n=>(ve("data-v-14464cf4"),n=n(),pe(),n),Ze={class:"w-full h-full relative"},Qe=He(()=>r("div",{id:"map",class:"w-full h-full relative z-0"},null,-1)),Je={class:"absolute bottom-[12px] left-0 right-0 z-10"},Xe={props:{storeList:{type:Array,default:()=>[]}},emits:["changeIndex","handleTo"],setup(n,{expose:m,emit:x}){const a=n,{cityMapStore:s}=Q(),b=p(0),w=p(null);let o=null,h=[],c=null;const I=se(()=>{var e,t;return s.locationCoords.lng&&s.locationCoords.lat?{lng:s.locationCoords.lng,lat:s.locationCoords.lat}:{lng:(e=s.currentActiveCity)==null?void 0:e.areaLongitude,lat:(t=s.currentActiveCity)==null?void 0:t.areaLatitude}});ue(()=>a.storeList,()=>{a.storeList.length>0&&setTimeout(()=>{o&&(g(),S(),C(),v())},300)},{immediate:!0,deep:!0});const v=()=>{ae.loading({message:"地图初始化...",duration:0});try{const e=I.value;o=L.map("map",{center:[e.lat,e.lng],zoom:12,trackResize:!0,zoomControl:!1}),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"",subdomains:"abcd",maxZoom:17,minZoom:7}).addTo(o)}catch{ae.fail("地图初始化失败")}finally{ae.clear()}},C=()=>{const e=a.storeList[b.value];e&&e.storeLatitude&&e.storeLongitude&&o.flyTo([e.storeLatitude,e.storeLongitude],15,{duration:.8,easeLinearity:1})},g=()=>{y(),a.storeList.forEach((e,t)=>{if(e.storeLatitude&&e.storeLongitude){const l=t===b.value?re:ce,d=L.marker([e.storeLatitude,e.storeLongitude],{icon:l}).addTo(o);d.on("click",()=>{B(t,!0)}),h.push(d)}})},y=()=>{h.forEach(e=>{o&&o.removeLayer(e)}),h=[]},S=()=>{c&&o&&o.removeLayer(c);const e=I.value;if(e&&e.length>0){const t=e[0];t.lng&&t.lat&&(c=L.marker([t.lat,t.lng],{icon:we}).addTo(o))}},F=()=>{h.forEach((e,t)=>{const l=t===b.value?re:ce;e.setIcon(l)})},B=(e,t=!1)=>{b.value=e,t&&w.value&&w.value.updateActiveIndex(e),x("changeIndex",e),C(),t?F():setTimeout(()=>{F()},600)},P=()=>{y(),c&&o&&(o.removeLayer(c),c=null),o&&(o.remove(),o=null)};return le(()=>{v()}),fe(()=>{P()}),m({initMap:v}),(e,t)=>(u(),_("div",Ze,[Qe,q(Me,{class:"absolute bottom-[128px] right-[20px] z-10 shadow-[0_0.5px_16px_0_rgba(0,0,0,0.16)]",onHandleTo:t[0]||(t[0]=l=>x("handleTo",l))}),r("div",Je,[q(Ge,{ref:(l,d)=>{d.draggableCardListRef=l,w.value=l},"card-data":n.storeList,onChangeIndex:B},null,8,["card-data"])])]))}},Ye=Z(Xe,[["__scopeId","data-v-14464cf4"]]),We={class:"shop-img w-[80px] h-[80px] rounded-lg overflow-hidden flex-shrink-0 relative"},et={class:"shop-content h-full ml-2 w-full"},tt={class:"w-full text-base text-b1 font-semibold flex items-center justify-between line-clamp-1"},at={class:"line-clamp-1"},ot={class:"text-sm text-b3 font-normal"},st={class:"h-[20px] text-sm text-b3 font-normal mt-[18px] flex items-center justify-between"},lt={class:"engagement"},nt={key:0,class:"distance"},rt=te({props:{storeInfo:{default:{}},backgroundColor:{default:"#fff"}},setup(n){const m=n,x=oe(),{cityMapStore:a}=Q(),{distanceFormat:s}=ne(),b=()=>{x.push(`/city/poi/storefront?storeId=${m.storeInfo.storeId}&child=1`)};return(w,o)=>{var c,I,v,C,g,y,S;const h=O("van-image");return u(),_("div",{class:"w-full h-[104px] rounded-xl p-3 mb-3 flex items-center justify-start",style:G({backgroundColor:n.backgroundColor}),onClick:b},[r("div",We,[q(h,{width:"80",height:"80",fit:"cover",src:n.storeInfo.storeIcons?n.storeInfo.storeIcons.split(",")[0]:""},null,8,["src"]),+n.storeInfo.storeGoodsCount>0?(u(),N(ke,{key:0})):V("",!0)]),r("div",et,[r("div",tt,[r("span",at,T(((c=n.storeInfo)==null?void 0:c.storeName)||""),1)]),r("div",ot,T(((I=n.storeInfo)==null?void 0:I.goodsCategoryName3)||"")+" "+T(((v=n.storeInfo)==null?void 0:v.areaExtName3)||""),1),r("div",st,[r("span",lt,[+((C=n.storeInfo)==null?void 0:C.wantCount)?(u(),_(z,{key:0},[me(T(n.storeInfo.wantCount)+"人想要 ",1)],64)):V("",!0)]),(g=D(a).locationCoords)!=null&&g.lng&&((y=D(a).locationCoords)!=null&&y.lat)?(u(),_("span",nt,T(D(s)((S=n.storeInfo)==null?void 0:S.distance)),1)):V("",!0)])])],4)}}}),ct={class:"w-full h-full bg-[#F2F0EF] px-3 pt-3 overflow-y-scroll"},ut={props:{storeList:{type:Array,default:()=>[]}},setup(n){return(m,x)=>{const a=O("van-list");return u(),_("div",ct,[q(a,{"finished-text":"没有更多了"},{default:H(()=>[(u(!0),_(z,null,ee(n.storeList,s=>(u(),N(rt,{key:s.id,"store-info":s,"background-color":"#fff"},null,8,["store-info"]))),128))]),_:1})])}}},it=["onClick"],dt={class:"mt-[-1px] pt-[1px] w-full h-fit max-h-[calc(100vh-50px-48px-32px)] overflow-y-scroll bg-white px-3"},ft=["onClick"],vt=te({props:{modelValue:null},emits:["update:modelValue","change"],setup(n,{expose:m,emit:x}){var R,j,U;const a=ie(),{cityMapStore:s}=Q(),b=se(()=>[{key:"goodsCategoryId1",label:c.value?w(h.value,c.value):"全部类型",isAct:o("goodsCategoryId1",c.value),loading:I.value},{key:"distance",label:y.value?w(g.value,y.value):"全部距离",isAct:o("distance",y.value)},{key:"areaIdLastLeaf",label:F.value?w(S.value,F.value):"全部区域",isAct:o("areaIdLastLeaf",F.value),loading:B.value}]),w=(f,k)=>{var M;return(M=f.find(i=>k==i.value))==null?void 0:M.label},o=(f,k)=>!!(t.value&&l.value===f)||k,h=p([]),c=p(((R=a.query)==null?void 0:R.categoryId)||null),I=p(!1),v=f=>{c.value=f},C=async()=>{var i,A;I.value=!0;const f={areaIdPreviousLastLeaf:((i=s.currentActiveCity)==null?void 0:i.areaId)||"3501",overseasFlag:((A=s.currentActiveCity)==null?void 0:A.overseasFlag)||!1},{success:k,data:M}=await xe(f);I.value=!1,k&&(h.value=M?M.map($=>({value:$.goodsCategoryId,label:$.goodsCategoryName,...$})):[],h.value.unshift({value:null,label:"全部类型"}))},g=p([{value:null,label:"全部距离"},{value:500,label:"<500m"},{value:1e3,label:"<1km"},{value:2e3,label:"<2km"},{value:5e3,label:"<5km"}]),y=p(((j=a.query)==null?void 0:j.distance)||null),S=p([]),F=p(((U=a.query)==null?void 0:U.area)||null),B=p(!1),P=async()=>{B.value=!0;const{success:f,data:k}=await Ie();if(B.value=!1,!f)return;let i=Ce(k,{idKey:"areaId",parentKey:"areaParentId",childrenKey:"children",rootId:"0"}).find($=>{var K;return((K=s.currentActiveCity)==null?void 0:K.areaParentId)==$.areaId}),A=i==null?void 0:i.children.find($=>{var K;return((K=s.currentActiveCity)==null?void 0:K.areaId)==$.areaId});S.value=A!=null&&A.children?A==null?void 0:A.children.map($=>({value:$.areaId,label:$.areaExtName,...$})):[],S.value.unshift({value:null,label:"全部区域"})},e=p(null),t=p(!1),l=p(""),d=p([]),E=f=>{if(l.value=="goodsCategoryId1")return c.value==f.value;if(l.value=="distance")return y.value==f.value;if(l.value=="areaIdLastLeaf")return F.value==f.value},J=f=>{if(l.value===f&&t.value){t.value=!1;return}l.value=f,t.value=!0,t.value&&(l.value=="goodsCategoryId1"?d.value=h.value:l.value=="distance"?d.value=g.value:l.value=="areaIdLastLeaf"&&(d.value=S.value))};he(e,()=>t.value=!1);const X=f=>{var k,M;if(l.value=="goodsCategoryId1")c.value=f.value;else if(l.value=="distance")if((k=s.locationCoords)!=null&&k.lat&&((M=s.locationCoords)!=null&&M.lng))y.value=f.value;else{s.clearNoAuthErrorFlag(),s.setNoAuthError(),t.value=!1;return}else l.value=="areaIdLastLeaf"&&(F.value=f.value);t.value=!1,Y(),x("change",l.value,f.value)},Y=()=>{const f={goodsCategoryId1:c.value,distance:y.value,areaIdLastLeaf:F.value};x("update:modelValue",f)};return le(()=>{C(),P()}),m({setCategory1Act:v}),(f,k)=>{const M=O("van-loading");return u(),_("div",{class:"relative flex items-center gap-[3px]",ref:(i,A)=>{A.selectBox=i,e.value=i}},[(u(!0),_(z,null,ee(D(b),(i,A)=>(u(),_("div",{class:"shrink-0 flex justify-center items-center",style:G(`width: calc(100% / ${D(b).length});`),onClick:W($=>i.loading?"":J(i.key),["stop"]),key:i.key},[i.loading?(u(),N(M,{key:0,size:"20px"})):(u(),_(z,{key:1},[r("div",{class:"text-sm text-[#585654] font-normal",style:G(i.isAct?"color: #ff8812":"")},T(i.label),5),r("div",{class:"trapezoid shrink-0 ml-1.5",style:G(i.isAct?"border-top: 4px solid #ff8812":"")},null,4)],64))],12,it))),128)),ge(r("div",{class:"absolute top-[32px] z-[49] w-full h-[calc(100vh-50px-48px-32px)] bg-[rgba(0,0,0,0.5)]",onClick:k[0]||(k[0]=W(i=>t.value=!1,["stop"]))},[r("div",dt,[(u(!0),_(z,null,ee(d.value,(i,A)=>(u(),_("div",{class:"mb-3 w-full text-sm text-[#585654]",style:G(E(i)?"color:#FF8812;font-weight:600":""),key:i.value,onClick:W($=>X(i),["stop"])},T(i.label),13,ft))),128))])],512),[[ye,t.value]])],512)}}}),pt=Z(vt,[["__scopeId","data-v-277f8648"]]),mt={class:"h-[calc(100vh-50px)] w-full overflow-hidden"},ht={class:"px-3 pb-3"},gt={class:"pb-3"},yt={class:"h-[calc(100%-48px-32px)] bg-[#F2F0EF]"},_t=te({setup(n){var F,B,P;const m=ie(),x=oe(),{cityMapStore:a}=Q(),{getUserLocation:s}=ne(),b=p(null),w=p(!1),o=p(m.query.mode||"map"),h=()=>{o.value=o.value==="map"?"list":"map",x.replace({query:{...m.query,mode:o.value}})},c=p({keyword:""}),I=()=>{y()},v=p({goodsCategoryId1:((F=m.query)==null?void 0:F.categoryId)||null,distance:((B=m.query)==null?void 0:B.distance)||null,areaIdLastLeaf:((P=m.query)==null?void 0:P.area)||null}),C=(e,t)=>{let l={...m.query};e==="goodsCategoryId1"&&(l.categoryId=t),e==="distance"&&(l.distance=t),e==="areaIdLastLeaf"&&(l.area=t),l=Object.fromEntries(Object.entries(l).filter(([d,E])=>E)),x.replace({query:l}),y()},g=p([]),y=()=>{var l,d,E,J,X,Y,R;w.value=!0;let e=[];(a.locationCoords.lat&&a.locationCoords.lng||(l=a.currentActiveCity)!=null&&l.areaLatitude&&((d=a.currentActiveCity)!=null&&d.areaLongitude))&&e.push("asc|distance");let t=e.length?e.join(","):null;be({size:9999,storeNameLike:((E=c.value)==null?void 0:E.keyword)||null,areaIdPreviousLastLeaf:((J=a.currentActiveCity)==null?void 0:J.areaId)||"3501",overseasFlag:((X=a.currentActiveCity)==null?void 0:X.overseasFlag)||!1,longitude:a.locationCoords.lng||((Y=a.currentActiveCity)==null?void 0:Y.areaLongitude)||null,latitude:a.locationCoords.lat||((R=a.currentActiveCity)==null?void 0:R.areaLatitude)||null,sortBy:t,...v.value}).then(j=>{g.value=[],setTimeout(()=>{var U;g.value=((U=j.data)==null?void 0:U.records)||[]},50)}).catch(j=>{g.value=[]}).finally(()=>{w.value=!1})},S=e=>{x.push(e)};return ue(()=>a.currentActiveCity,(e,t)=>{e!=null&&e.areaId&&y()},{immediate:!0,deep:!0}),le(async()=>{var e,t;a.currentActiveCity?(e=a.locationCoords)!=null&&e.lat&&((t=a.locationCoords)!=null&&t.lng)||a.setNoAuthError():await s()}),(e,t)=>{const l=O("router-view");return u(),N(_e,{title:"城市地图",class:"bg-white font-Puhui font-normal relative","theme-vars":{"field-placeholder-text-color":"#A6A6A6"},ref:(d,E)=>{E.searchRef=d}},{right:H(()=>[r("div",{class:"text-sm font-normal text-b2",onClick:h},T(o.value==="map"?"列表模式":"地图模式"),1)]),default:H(()=>[r("div",mt,[r("div",ht,[q(Ae,{modelValue:c.value.keyword,"onUpdate:modelValue":t[0]||(t[0]=d=>c.value.keyword=d),placeholder:"请输入店铺名称","search-button-text":"搜索",onSearch:I,onClear:I},null,8,["modelValue"])]),r("div",gt,[q(pt,{modelValue:v.value,"onUpdate:modelValue":t[1]||(t[1]=d=>v.value=d),onChange:C,ref:(d,E)=>{E.storeFilterRef=d,b.value=d}},null,8,["modelValue"])]),r("section",yt,[g.value&&g.value.length===0&&!w.value?(u(),N(Le,{key:0,class:"!bg-transparent",name:"暂无门店"})):V("",!0),o.value==="map"?(u(),_(z,{key:1},[g.value&&g.value.length>0?(u(),N(Ye,{key:0,storeList:g.value,ref:(d,E)=>{E.mapRef=d},onHandleTo:S},null,8,["storeList"])):V("",!0)],64)):(u(),N(ut,{key:2,storeList:g.value},null,8,["storeList"]))])]),q(l,{class:"child-view"})]),_:1},512)}}}),St=Z(_t,[["__scopeId","data-v-33acad84"]]);export{St as default};
