import{_ as N,y as H,l as ie,x as P,E as B,F as I,G as h,O as b,H as p,Q as ne,P as le,N as T,a1 as we,Z as ue,$ as de,r as v,I as ke,J as be,K as q,R as $e,a2 as pe,D as fe,a9 as Le,X as Me,T as M}from"./vendor-BlU_hoYl.js";import{C as Re}from"./CommonVanProvider-CDfGVWR4.js";import{u as De}from"./useCityMap-L2xSDWSa.js";import{e as me}from"./index-Clz0Qna-.js";import{P as z,L as re,S as ce}from"./iconAssets-DyRcdBzl.js";import{_ as Fe}from"./SearchBar-y7PfYxvJ.js";import"./BackIcon-8hcEjDKb.js";import"./localMark-D3Prsc6Q.js";import"./search-C4fLtTfY.js";import"./delete-BlDblrKv.js";const Se=i=>(ue("data-v-288c2402"),i=i(),de(),i),Ee={class:"w-full h-[158px] bg-white rounded-xl p-4 shadow-[0_0.5px_16px_0_rgba(0,0,0,0.16)]"},Ae={key:0,class:"w-full h-full flex justify-center items-center"},Be={key:1,class:"h-full flex flex-col justify-between"},Te={class:"shop-name flex items-center justify-between"},Ue={class:"text-base text-b1 font-semibold line-clamp-1"},je={class:"shop-desc mt-1"},ze={class:"text-b3 text-sm line-clamp-2"},Pe=we(" 确认选择 "),Ve={key:2,class:"w-full h-full flex justify-center items-center"},Ne=Se(()=>p("span",{class:"text-base text-b3 font-normal"},"暂无结果",-1)),He=[Ne],qe=H({props:{storeInfo:null,loading:{type:Boolean},emptyFlag:{type:Boolean}},emits:["handleConfirm"],setup(i,{emit:$}){const u=i;ie();const{getLeafletjsAddressTitle:d,getLeafletjsAddressDescription:a}=De(),y=P(()=>u.storeInfo?d(u.storeInfo):""),_=P(()=>u.storeInfo?a(u.storeInfo):""),r=()=>{console.log("confirmSelect"),$("handleConfirm",{...u.storeInfo,title:y.value,description:_.value})};return(f,g)=>{const l=B("van-loading"),s=B("VanButton");return h(),I("div",Ee,[i.loading?(h(),I("div",Ae,[b(l,{class:"shrink-0",size:"40"})])):i.emptyFlag?(h(),I("div",Ve,He)):(h(),I("div",Be,[p("div",null,[p("div",Te,[p("div",Ue,ne(le(y)),1)]),p("div",je,[p("p",ze,ne(le(_)),1)])]),b(s,{class:"shrink-0 w-full h-[46px] rounded-full border border-solid border-[#000] bg-btnOrBg text-b1 text-base font-semibold",onClick:r},{default:T(()=>[Pe]),_:1})]))])}}}),V=N(qe,[["__scopeId","data-v-288c2402"]]),Ke={class:"swiper-card-container"},Ze={class:"card-wrapper"},Oe={props:{cardData:{type:Array,default:()=>[]}},emits:["changeIndex","handleConfirm"],setup(i,{expose:$,emit:u}){const d=v(null),a=v(0),y=r=>{a.value=r,u("changeIndex",r)};return $({activeIndex:a,updateActiveIndex:r=>{a.value=r,d.value&&d.value.swipeTo(r)}}),(r,f)=>{const g=B("van-swipe-item"),l=B("van-swipe");return h(),I("div",Ke,[b(l,{ref:(s,n)=>{n.swiperRef=s,d.value=s},active:a.value,"onUpdate:active":f[1]||(f[1]=s=>a.value=s),loop:!1,"show-indicators":!1,touchable:!0,class:"custom-swiper",onChange:y},{default:T(()=>[(h(!0),I(ke,null,be(i.cardData,(s,n)=>(h(),q(g,{key:s.id,class:$e(["swipe-item",{right:a.value+1===n,left:a.value-1===n}])},{default:T(()=>[p("div",Ze,[b(V,{storeInfo:s,onHandleConfirm:f[0]||(f[0]=E=>u("handleConfirm",E))},null,8,["storeInfo"])])]),_:2},1032,["class"]))),128))]),_:1},8,["active"])])}}},Ge=N(Oe,[["__scopeId","data-v-def9542e"]]),Je=i=>(ue("data-v-5e7d8cb3"),i=i(),de(),i),Qe={class:"w-full h-full relative"},Xe=Je(()=>p("div",{id:"map",class:"w-full h-full relative z-0"},null,-1)),We={class:"absolute bottom-[12px] left-0 right-0 z-10"},Ye={key:1,class:"w-full flex justify-center items-center"},et={class:"shrink-0 w-[335px]"},tt={key:2,class:"w-full flex justify-center items-center"},ot={class:"shrink-0 w-[335px]"},at=H({emits:["handleConfirm"],setup(i,{expose:$,emit:u}){const d=pe(),{cityMapStore:a}=me(),y=v(null),_=v(0),r=v([]),f=v(null),g=v(!1),l=v(null),s=v("current");let n=null,E=16,D=null,F=[];const K=P(()=>{var e,o,t,c,m,x,R,S;return(e=d.query)!=null&&e.lng&&((o=d.query)!=null&&o.lat)?{lng:+((t=d.query)==null?void 0:t.lng),lat:+((c=d.query)==null?void 0:c.lat)}:(m=a.locationCoords)!=null&&m.lng&&((x=a.locationCoords)!=null&&x.lat)?{lng:a.locationCoords.lng,lat:a.locationCoords.lat}:{lng:((R=a.currentActiveCity)==null?void 0:R.areaLongitude)||"",lat:((S=a.currentActiveCity)==null?void 0:S.areaLatitude)||""}}),ve=e=>new Promise(o=>setTimeout(o,e)),U=(e,o=2,t=1e3)=>{const c=async m=>{try{return await(await fetch(e)).json()}catch{return m>0?(await ve(t),c(m-1)):(M.clear(),M.fail("街道信息查询失败"),null)}};return c(o)},he=()=>{try{const e=K.value;n=L.map("map",{center:[e.lat,e.lng],zoom:12,trackResize:!0,zoomControl:!1}),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"",subdomains:"abcd",maxZoom:17,minZoom:7}).addTo(n),n.on("click",function(o){console.log("mapClick",o),s.value="current";const t=o.latlng.lat,c=o.latlng.lng;A(),F.forEach((m,x)=>{m.setIcon(z)}),D=L.marker([t,c],{icon:re}).addTo(n),Z(t,c)}),setTimeout(()=>{_e()})}catch{}finally{}},_e=async()=>{let e="",o="";if(a.selectedMap)e=a.selectedMap.lat,o=a.selectedMap.lng;else{const t=K.value;e=t.lat,o=t.lng}e&&o&&(A(),D=L.marker([e,o],{icon:re}).addTo(n),n.flyTo([e,o],E,{duration:.8,easeLinearity:1}),Z(e,o))},ye=()=>{const e=r.value[_.value];e&&e.lat&&e.lng&&n.flyTo([e.lat,e.lng],E,{duration:.8,easeLinearity:1})},Z=async(e,o)=>{g.value=!0;try{const t=await U(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e}&lon=${o}&addressdetails=1&accept-language=zh-CN`);g.value=!1,O(e,o,t)}catch(t){console.error("获取地理信息失败:",t),g.value=!1,O(e,o,null)}},O=(e,o,t)=>{console.log("displayLocationInfo",t),t?(f.value={lat:+t.lat,lng:+t.lon,name:t.name,display_name:t.display_name,address:t.address},l.value={lat:+t.lat,lng:+t.lon,name:t.name,display_name:t.display_name,address:t.address}):(f.value=null,s.value="empty")},ge=()=>{Q(),r.value.forEach((e,o)=>{if(e.lat&&e.lng){const t=o===_.value?ce:z,c=L.marker([e.lat,e.lng],{icon:t}).addTo(n);c.on("click",()=>{s.value="list",A(),j(o,!0)}),F.push(c)}})},G=()=>{F.forEach((e,o)=>{const t=o===_.value?ce:z;e.setIcon(t)})},Ce=async(e="")=>{var x,R,S,X,W,Y,ee,te,oe,ae,se;s.value="list",M.loading();let o=(R=(x=l.value)==null?void 0:x.address)==null?void 0:R.country,t=(X=(S=l.value)==null?void 0:S.address)==null?void 0:X.country_code,c=((Y=(W=l.value)==null?void 0:W.address)==null?void 0:Y.state)||((te=(ee=l.value)==null?void 0:ee.address)==null?void 0:te.region),m=(se=(ae=(oe=l.value)==null?void 0:oe.address)==null?void 0:ae.postcode)==null?void 0:se.slice(0,4);m&&(m+="00");try{const C=await Promise.all([U(`https://nominatim.openstreetmap.org/search?format=jsonv2&amenity=${encodeURI(e)}&state=${encodeURI(c)}&postalcode=${encodeURI(m)}&country=${encodeURI(o)}&country_code=${encodeURI(t)}&addressdetails=1&accept-language=zh-CN&extratags=1`),U(`https://nominatim.openstreetmap.org/search?format=jsonv2&street=${encodeURI(e)}&state=${encodeURI(c)}&postalcode=${encodeURI(m)}&country=${encodeURI(o)}&country_code=${encodeURI(t)}&addressdetails=1&accept-language=zh-CN&extratags=1`)]);console.log("搜索结果",C),M.clear();let w=[];C[0]&&C.length&&(w=w.concat(C[0])),C[1]&&C[1].length&&(w=w.concat(C[1])),w=Array.from(new Map(w.map(k=>[k.osm_id,k])).values()),w.length?r.value=w.map(k=>({lat:+k.lat,lng:+k.lon,name:k.name,display_name:k.display_name,address:k.address})):(M.fail("暂无结果"),s.value="empty"),ge(),j(0)}catch(C){console.error("搜索失败:",C),M.clear()}},j=(e,o=!1)=>{_.value=e,o&&y.value&&y.value.updateActiveIndex(e),ye(),o?G():setTimeout(()=>{G()},600)},Ie=()=>{J(),r.value=[],_.value=0},J=()=>{F.forEach(e=>{n&&n.removeLayer(e)}),F=[]},A=()=>{D&&n&&(n.removeLayer(D),D=null)},Q=()=>{J(),A()},xe=()=>{Q(),n&&(n.remove(),n=null)};return fe(async()=>{he()}),Le(()=>{xe()}),$({searchKeyword:Ce,clearArrData:Ie}),(e,o)=>(h(),I("div",Qe,[Xe,p("div",We,[s.value==="list"?(h(),q(Ge,{key:0,ref:(t,c)=>{c.mapSearchResultList=t,y.value=t},"card-data":r.value,onChangeIndex:j,onHandleConfirm:o[0]||(o[0]=t=>u("handleConfirm",t))},null,8,["card-data"])):s.value==="current"?(h(),I("div",Ye,[p("div",et,[b(V,{storeInfo:f.value,loading:g.value,onHandleConfirm:o[1]||(o[1]=t=>u("handleConfirm",t))},null,8,["storeInfo","loading"])])])):s.value==="empty"?(h(),I("div",tt,[p("div",ot,[b(V,{"empty-flag":"",onHandleConfirm:o[2]||(o[2]=t=>u("handleConfirm",t))})])])):Me("",!0)])]))}}),st=N(at,[["__scopeId","data-v-5e7d8cb3"]]),nt={class:"h-[calc(100vh-50px)] w-full overflow-hidden"},lt={class:"px-3 pb-3"},rt={class:"h-[calc(100vh-50px-48px)] bg-[#F2F0EF]"},yt=H({setup(i){pe();const $=ie(),{cityMapStore:u}=me();v(!1);const d=v(null),a=v({keyword:""}),y=()=>{if(!a.value.keyword)return M.fail("请输入街道名称");d.value.searchKeyword(a.value.keyword)},_=()=>{d.value.clearArrData()},r=f=>{u.setSelectedMap(f),$.back()};return fe(()=>{}),(f,g)=>(h(),q(Re,{title:"地图选点",class:"bg-white font-Puhui font-normal relative","theme-vars":{"field-placeholder-text-color":"#A6A6A6",navBarBackgroundColor:"#fff"},ref:(l,s)=>{s.searchRef=l}},{default:T(()=>[p("div",nt,[p("div",lt,[b(Fe,{modelValue:a.value.keyword,"onUpdate:modelValue":g[0]||(g[0]=l=>a.value.keyword=l),placeholder:"请输入街道名称","search-button-text":"搜索",onSearch:y,onClear:_},null,8,["modelValue"])]),p("section",rt,[b(st,{ref:(l,s)=>{s.mapRef=l,d.value=l},onHandleConfirm:r},null,512)])])]),_:1},512))}});export{yt as default};
