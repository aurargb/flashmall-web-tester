import{_ as be}from"./MCOIN-BOqZVkND.js";import{_ as bt}from"./FMCP-yoa9RTPy.js";import{y as _e,_ as _t,x as X,B as p,r as N,be as lo,z as qe,D as wt,E as H,F as T,G as f,O as y,N as _,K as U,X as k,P as e,H as s,Q as l,a4 as ro,a1 as Z,Z as At,$ as kt,I as Te,w as uo,bw as me,l as io,a2 as co,bh as mo,J as ft,R as po,bN as fo,a0 as yt,T as le}from"./vendor-BlU_hoYl.js";import{_ as yo}from"./AddressInfo-Cb8-Y8xf.js";import{_ as ht}from"./EmptyTipsPop-DGM583dh.js";import{_ as ho}from"./OrderGoodsCartBox-CEbtKHix.js";import{P as vo}from"./PaySwitchPop-DfhI_Zsr.js";import{_ as go}from"./point-arrow-BXwQ0Ukh.js";import{_ as $t}from"./USDT-CNsbs3BR.js";import{e as bo,d as x,_ as _o,R as wo,o as Ao,i as ko,f as vt,q,r as $o,bE as xo,bA as Po,s as Ke,B as So,a2 as To}from"./index-Wb-6_0W_.js";import{P as ge}from"./flashSale-DDyqLyYN.js";import{u as Co}from"./usePointRelase-Bhif5Y_O.js";import{P as S}from"./order-H59PKTFP.js";import{C as Ro}from"./CommonVanProvider-CDfGVWR4.js";import{u as Bo,_ as No,P as Eo}from"./usePayHelp-ClOggRf8.js";import{_ as Lo}from"./PayHelpSelector-BYbir5-o.js";import{D as Oo}from"./DividingLine-BGr5Dv2u.js";import{_ as ze}from"./SubmitApprove-Ccyw2aJS.js";import{q as Do,c as Wo}from"./address-DTgVu07X.js";import{m as gt,t as Fo,u as Io,r as Vo}from"./order-pJoL_MtT.js";import{u as Go}from"./useSelectAddress-CgNt0r_o.js";import{G as re}from"./goods-BVwS8oFG.js";import{p as Uo}from"./piggyBank-DN4hNkWq.js";import{S as he}from"./shop-CeqcS6K2.js";import{u as Ho}from"./useKeyboard-C7Jit2jF.js";import{P as ve}from"./payHelp-DUMXKXfC.js";import"./mall-C69gPh5W.js";import"./OrderGoods-BQbKo4MD.js";import"./BoutiqueLable-negN2DKs.js";import"./ShopMaskTips-CxJi-SfW.js";import"./useShipTemplate-C35bKCd2.js";import"./enums-DlE-aiss.js";import"./BackIcon-8hcEjDKb.js";const Mo=_e({props:{num:{type:Number,default:0},amount:{type:Number,default:0},fee:{type:Number,default:0}},setup(d){return(E,G)=>null}}),jo="/static/images/pay_points-DuQgheHY.png",qo="/static/images/pay_wallet-CtEhTDcc.png",Ko="/static/images/pay_piggy-1jarwiJl.png",we=d=>(At("data-v-3da12dec"),d=d(),kt(),d),zo={class:"pay-switch rounded-xl overflow-hidden"},Jo=we(()=>s("img",{src:jo,class:"w-6 h-6 mx-3"},null,-1)),Yo={class:"custom-title flex items-center justify-start gap-2"},Qo=["onClick"],Xo=we(()=>s("img",{src:go,class:"w-4 h-4 mx-3"},null,-1)),Zo={class:"text-xs text-b3"},es=we(()=>s("img",{src:qo,class:"w-6 h-6 mx-3"},null,-1)),ts={class:"custom-title"},os={class:"text-xs text-b3"},ss=we(()=>s("img",{src:Ko,class:"w-6 h-6 mx-3"},null,-1)),as={class:"custom-title"},ns={class:"text-xs text-b3"},ls=we(()=>s("img",{src:$t,class:"w-6 h-6 mx-3"},null,-1)),rs={class:"custom-title"},us={class:"text-xs text-b3"},is={class:"text-sm text-b2 my-4 leading-5"},cs={class:"flex justify-center gap-x-2"},ds=_e({props:{checked:{default:"3"},clickable:{type:Boolean,default:!0},payType:{default:1},paySymbol:{default:"MCOIN"},walletBalance:null,pointBalance:null,piggyBalance:null,usdtBalance:null,boutique:{type:Boolean,default:!1},payAmount:{default:0},usdtRate:null,voucherAmount:null},emits:["onChange","getPointBalance"],setup(d,{expose:E,emit:G}){const $=d,{contributesStore:C}=bo(),pe=X(()=>+p($.pointBalance).times(.9)),Re=X(()=>[{source:S.WITHDRAW_POINTS,amount:pe.value},{source:S.WALLET,amount:$.walletBalance},{source:S.PIGGY_BANK,amount:$.piggyBalance},{source:S.USDT_WALLET,amount:$.usdtBalance*$.usdtRate}]),{handleNaturePointsToast:V}=Co(),ee=N($.checked),[te,K]=lo(!1),Ae=r=>{ee.value=r},ke=()=>{let r=[...Re.value];!$.boutique&&r[0].source===S.WITHDRAW_POINTS&&r.shift();const h=r.find(O=>O.source===S.WITHDRAW_POINTS?+O.amount>=+$.payAmount-(+$.voucherAmount||0):+O.amount>=+$.payAmount);h&&h.source!==+ee.value?G("onChange",h.source):!h&&+r[0].source&&G("onChange",r[0].source)},Be=()=>{var r,h,O,W;(r=C.releaseData)!=null&&r.remainTotal&&+((h=C.releaseData)==null?void 0:h.remainTotal)>0&&(!((O=C.releaseData)!=null&&O.nextSubmitDate)||new Date().getTime()>=+((W=C.releaseData)==null?void 0:W.nextSubmitDate))?V($e):K(!0)},$e=()=>{let r=0;const h=async()=>{G("getPointBalance"),C.fetchContributes(),await Promise.all([C.fetchUserRelase(),C.getNaturalReleaseTimes()]),r++,r<3&&setTimeout(h,3e3)};h()},Ne=()=>{K(!1),V($e)};return qe(()=>$.checked,r=>{ee.value=r},{immediate:!0,deep:!0}),qe(()=>$.boutique,r=>{r&&(C.fetchContributes(),C.fetchUserRelase(),C.getNaturalReleaseTimes())},{immediate:!0,deep:!0}),qe(()=>$.voucherAmount,r=>{r&&ke()},{immediate:!0,deep:!0}),wt(()=>{ke()}),E({setpayValue:Ae}),(r,h)=>{const O=H("van-radio"),W=H("van-cell"),Ee=H("van-cell-group"),xe=H("van-radio-group"),ue=H("VanButton");return f(),T("div",zo,[y(xe,{modelValue:ee.value,"onUpdate:modelValue":h[4]||(h[4]=oe=>ee.value=oe)},{default:_(()=>[y(Ee,null,{default:_(()=>[d.payType===e(ge).MC&&d.boutique?(f(),U(W,{key:0,center:"",title:r.$t("order.payPoints"),clickable:"",onClick:h[0]||(h[0]=()=>G("onChange",4))},{icon:_(()=>[Jo]),title:_(()=>[s("div",Yo,[s("span",null,l(r.$t("order.payPoints")),1),e(x)(e(C).freeRelease)>0?(f(),T("div",{key:0,class:"text-xs font-normal text-newOrigin flex-center",onClick:ro(Be,["stop"])},[Z(l(r.$t("integral.keshifang",{num:e(x)(e(C).freeRelease)})),1),Xo],8,Qo)):k("",!0)]),s("div",Zo,l(r.$t("huabei.nowCanUse"))+" "+l(e(x)(d.pointBalance))+"/"+l(r.$t("integral.order_can_use"))+l(e(x)(e(pe))),1)]),"right-icon":_(()=>[y(O,{name:"4","checked-color":"#FEA021"})]),_:1},8,["title"])):k("",!0),y(W,{center:"",title:r.$t("order.payWallet"),clickable:"",onClick:h[1]||(h[1]=()=>G("onChange",1))},{icon:_(()=>[es]),title:_(()=>[s("div",ts,l(r.$t("order.payWallet")),1),s("div",os,l(r.$t("huabei.nowCanUse"))+" "+l(e(x)(d.walletBalance)),1)]),"right-icon":_(()=>[y(O,{name:"1","checked-color":"#FEA021"})]),_:1},8,["title"]),y(W,{center:"",title:r.$t("order.payPiggy"),clickable:"",onClick:h[2]||(h[2]=()=>G("onChange",2))},{icon:_(()=>[ss]),title:_(()=>[s("div",as,l(r.$t("order.payPiggy")),1),s("div",ns,l(r.$t("huabei.nowCanUse"))+l(e(x)(d.piggyBalance)),1)]),"right-icon":_(()=>[y(O,{name:"2","checked-color":"#FEA021"})]),_:1},8,["title"]),d.payType!==e(ge).STORE_CARD?(f(),U(W,{key:1,center:"",title:r.$t("order.USDT payment"),clickable:"",onClick:h[3]||(h[3]=()=>G("onChange",5))},{icon:_(()=>[ls]),title:_(()=>[s("div",rs,l(r.$t("order.USDT payment")),1),s("div",us,l(r.$t("huabei.nowCanUse",{symbol:"(USDT)"}))+l(e(x)(d.usdtBalance)),1)]),"right-icon":_(()=>[y(O,{name:"5","checked-color":"#FEA021"})]),_:1},8,["title"])):k("",!0)]),_:1})]),_:1},8,["modelValue"]),y(_o,{show:e(te),name:r.$t("common.tip"),onClose:h[6]||(h[6]=oe=>e(K)(!1))},{default:_(()=>[s("div",is,l(r.$t("integral.relaseTip")),1),s("div",cs,[y(ue,{type:"primary",class:"flex-1 min-w-[130px] h-[46px] rounded-full border border-solid border-b4 bg-white text-b2 text-base font-semibold",onClick:h[5]||(h[5]=oe=>e(K)(!1))},{default:_(()=>[Z(l(r.$t("common.cancel")),1)]),_:1}),y(ue,{class:"bg-btnOrBg rounded-full w-full text-b1 font-semibold",onClick:Ne},{default:_(()=>[Z(l(r.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show","name"])])}}}),ms=_t(ds,[["__scopeId","data-v-3da12dec"]]),ps={class:"bg-white mt-3 p-3 rounded-xl"},fs={class:"text-base font-semibold"},ys={class:"flex items-start justify-between mt-3"},hs={class:"text-b3"},vs={class:"text-right"},gs={key:0,class:"flex items-center justify-end gap-1 font-semibold"},bs=s("img",{src:be,class:"w-4 h-4"},null,-1),_s={key:1,class:"flex items-center justify-end gap-1 font-semibold"},ws=s("img",{src:$t,class:"w-4 h-4"},null,-1),As={key:0,class:"actPrice flex items-baseline justify-between mt-3"},ks={class:"text-b3 max-w-[100px] line-clamp-1"},$s={class:"text-right flex items-center justify-end gap-1"},xs=s("img",{src:be,class:"w-4 h-4"},null,-1),Ps=s("div",{class:"w-full h-[1px] bg-[#F6F6F5] my-3"},null,-1),Ss={class:"flex items-center justify-between"},Ts={class:"text-b3"},Cs={class:"gap-1 text-right flex-center"},Rs=s("img",{src:be,class:"w-4 h-4"},null,-1),Bs=Z("+ "),Ns=s("img",{src:bt,class:"w-4 h-4"},null,-1),Es={key:1,class:"text-xs text-b3 text-right"},Ls=_e({props:{totalPrice:null,usdtPrice:null,originalUsdtPrice:null,showTotalPrice:null,voucherPrice:null,useVoucherAmount:null,symbol:null,activityReduceAmount:null,fmGeneralActivity:null},setup(d){const E=d,G=X(()=>{if(E.usdtPrice<=0)return"";const $=new p(E.usdtPrice),C=new p(E.showTotalPrice||0).minus(E.totalPrice).minus(E.activityReduceAmount||0).minus(E.useVoucherAmount||0).toNumber();return console.log("props.showTotalPrice",E.showTotalPrice,"props.totalPrice",E.totalPrice,"props.voucherPrice",E.voucherPrice,"props.activityReduceAmount",E.activityReduceAmount,"props.fmGeneralActivity",E.fmGeneralActivity),`(${x($)} USDT将自动闪兑为${x(C)} Mcoin)`});return($,C)=>(f(),T("div",ps,[s("div",fs,l($.$t("order.totalPriceDetail")),1),s("div",ys,[s("div",hs,l($.$t("order.goodsPrice")),1),s("div",vs,[d.totalPrice>0?(f(),T("div",gs,[bs,s("span",null,l(e(x)(d.totalPrice)),1)])):k("",!0),d.originalUsdtPrice>0?(f(),T("div",_s,[ws,s("span",null,l(e(x)(d.originalUsdtPrice)),1)])):k("",!0)])]),d.activityReduceAmount&&d.fmGeneralActivity?(f(),T("div",As,[s("div",ks,l(d.fmGeneralActivity.name),1),s("div",$s,[xs,s("span",null,"-"+l(e(x)(d.activityReduceAmount)),1)])])):k("",!0),Ps,s("div",Ss,[s("div",Ts,l($.$t("common.actual_payment")),1),s("div",Cs,[Rs,s("span",null,l(e(x)(d.showTotalPrice-d.voucherPrice-(d.activityReduceAmount||0))),1),d.voucherPrice?(f(),T(Te,{key:0},[Bs,Ns,Z(l(e(x)(d.voucherPrice)),1)],64)):k("",!0)])]),d.usdtPrice>0?(f(),T("div",Es,l(e(G)),1)):k("",!0)]))}}),Ce=d=>(At("data-v-2f124ce2"),d=d(),kt(),d),Os={key:0,class:"page-body mt-3 overflow-y-auto"},Ds={class:"mt-3 flex items-center justify-between gap-2 pb-3"},Ws={class:"flex-1 text-b3"},Fs=["onClick"],Is={key:0},Vs={class:"bg-white overflow-hidden py-3 border-b border-b5 border-solid"},Gs={class:"text-b3"},Us={class:"bg-white myinput overflow-hidden py-3"},Hs={class:"text-b3"},Ms={key:1,class:"pt-3 border-t border-b5 border-solid"},js={class:"flex items-baseline justify-between mt-1"},qs={class:"text-b3"},Ks={class:"text-right"},zs={class:"text-base font-semibold"},Js={key:0},Ys={class:"text-b3 mt-1"},Qs={class:"bg-white mt-2.5 rounded-xl p-2.5"},Xs={class:"text-sm font-bold"},Zs={class:"flex items-baseline justify-between mt-1"},ea={class:"break-keep"},ta={class:"text-right"};const oa={key:1,class:"flex flex-wrap items-center justify-end text-base font-semibold text-primary"},sa={key:0,class:"justify-end flex-center"},aa=Ce(()=>s("img",{src:be,class:"w-4 h-4 mr-1"},null,-1)),na={class:"opacity-60"},la=Ce(()=>s("div",{class:"h-10"},null,-1)),ra={class:"text-b3 text-base"},ua={class:"flex items-center justify-end gap-x-2"},ia={class:"flex flex-col"},ca={class:"flex items-center gap-x-1"},da={class:"text-sm text-b2"},ma=Ce(()=>s("img",{src:be,class:"w-4 h-4"},null,-1)),pa={class:"text-b1 text-lg font-BebasNeue"},fa={key:0,class:"flex items-center justify-end gap-x-1 text-sm text-b2"},ya=Ce(()=>s("img",{src:bt,class:"w-4 h-4"},null,-1)),ha={class:"relative"},va={class:"p-3 pb-10 remark"},ga={class:"relative text-center text-lg font-bold mb-3"},ba=_e({name:"SubmitOrderBoutiqueCart"});function _a(d){const{isKeyboardVisible:E}=Ho(),{getUserDhKey:G,encryptAddressKey:$,formatAddressData:C,generateKey:pe,decryptAddressKey:Re}=wo(),{t:V}=uo(),[ee,te]=me(!1),{loadingToggle:K}=$o(),{getAddress:Ae,setAddress:ke}=Go(),{submit:Be}=Ao(),$e=ko(1),{tradeContributeSelfRate:Ne,mcoinRate:r}=vt(),[h,O]=me(!1),W=io(),[Ee,xe]=me(!1),[ue,oe]=me(!1),[xt,Pt]=me(!0),[se,F]=me(!1),Le=N([]),L=N(),D=N([]),St=N(0),fe=N({remark:""}),Tt=X(()=>[{value:0,text:V("common.no")},{value:1,text:V("common.yes")}]),Je=async()=>{if(Ae()){L.value=Ae(),ke(null);return}const t=W.currentRoute.value.path,o=await Do();if(!o.success)return;Le.value=o.data;const a=Le.value.find(i=>i.isDefault===1)||Le.value[0],n=await pe("user",t);if(a!=null&&a.encryptFlag&&n){L.value=Re(a,n);return}L.value=a},Ct=async()=>{const t=await(await $e).allowance(q.order);St.value=t.result},z=co(),w=X(()=>Ve()),Ye=N([]),Oe=async()=>{var n,i;let t=[];D.value.forEach(P=>{P.ordersInfos.forEach(v=>{v.goods.forEach(g=>{t.push({goodsId:g.goodsId,num:g.number,payType:ge.MC,paySource:P.paySource})})})});const o={type:((n=z==null?void 0:z.query)==null?void 0:n.type)??2,addressId:(i=L.value)==null?void 0:i.id,detailList:t,genOrder:!1,voucherAmount:0},a=await gt(o);a.success&&(Ye.value=a.data.goodsList||[])},Qe=async()=>{var a;const t=await Vo({type:((a=z==null?void 0:z.query)==null?void 0:a.type)??2});if(!t.success){setTimeout(()=>{W.back()},1500);return}const o=D.value.map(n=>n.paySource);D.value=(t.data.ordersInfos||[]).map((n,i)=>{let P=ge.MC;return{...n,goods:n.orderGoods,totalAmount:0,integral:0,remark:"",payType:P,paySource:o[i]||S.WALLET}}),Rt()},Rt=()=>{const t=D.value.map(n=>n.paySource),o=D.value.reduce((n,i)=>(i.goods.forEach(P=>{n.push({...i,goods:P,storeId:i.stores.id,cardNo:"",isPortability:0})}),n),[]),a=Nt(o);D.value=a.map((n,i)=>{var R;const P=(R=n[0])==null?void 0:R.goods,v=(P==null?void 0:P.goodsType)!==he.SD,g=t[i]||(v?S.WITHDRAW_POINTS:S.WALLET),A=Bt(n);return{goodsBoutiqueFlag:v,paySource:g,ordersInfos:A}})},Bt=t=>t.reduce((o,a)=>{const n=o.findIndex(i=>i.storeId===a.storeId);return n!==-1?(o[n].goods.push(a.goods),+a.goods.goodsTypes===re.RECHARGE&&(o[n].goodTypes=re.RECHARGE)):o.push({...a,goods:[a.goods],goodTypes:+a.goods.goodsTypes===re.RECHARGE?re.RECHARGE:null}),o},[]),Nt=t=>{let o={};for(;t.length;){let a=t.shift();const n=a.goods.goodsType?"true":"false";o[n]=o[n]||[],o[n].push(a)}return Object.keys(o).map(a=>o[a])},Et=async(t,o)=>{t.number=o,K(!0),await xo({goodsId:t.goodsId,number:o}),await Oe(),await Qe(),K(!1),nt()},Lt=async t=>{fe.value=t,oe(!0),nt()},Ot=()=>{D.value.forEach(t=>{t.ordersInfos.forEach(o=>{var a,n;o.storeId===((a=fe.value)==null?void 0:a.storeId)&&(o.remark=(n=fe.value)==null?void 0:n.remark)})})},Dt=N(S.WITHDRAW_POINTS),Wt=(t,o)=>{se.value||(o.paySource=t,o.boutiqueIntegral=Ve([{ordersInfos:o.ordersInfos,paySource:o.paySource}]),Oe())};let J=N(!1);const Ft=async()=>{const t=D.value.reduce((o,a)=>{const n=o.findIndex(i=>i.storeId===a.paySource);return n!==-1?o[n].totalAmount+=a.totalAmount-a.voucherAmount:o.push({paySource:a.paySource,totalAmount:a.totalAmount-a.voucherAmount}),o},[]);for(let o=0;o<t.length;o++){const a=t[o],{totalAmount:n}=a,{paySource:i}=a;+i===S.WITHDRAW_POINTS?await Gt(n):+i===S.PIGGY_BANK?await Mt(n):+i===S.WALLET?await jt(n):+i===S.USDT_WALLET&&await It(n)}},It=async t=>{if(+Fe.value<+t*Ue.value)return J.value=!0,te(!0);J.value=!1},Aa=X(()=>x(+new p(Ve(D.value.filter(t=>t.goodsBoutiqueFlag)).totalAmount).div(.9))),Pe=N(0),{pointBalances:Vt}=vt(),De=async()=>{Pe.value=+await Vt(),console.log("pointBalance:",Pe.value)},Gt=async t=>{if(await De(),+ +p(Pe.value).times(.9)<+t)return J.value=!0,te(!0);J.value=!1},Se=N([]),{userMerchantCashs:Ut,userTotalAmount:Ht}=Uo(),Xe=async()=>{const{success:t,result:o}=await Ut();if(!t)return;let a=0;const n=+await Ht(),i=o.amounts.map(v=>So(v));o.cashIds.map(v=>+v).forEach((v,g)=>{Se.value[v]=i[g],v!==0&&(a=+p(a).plus(i[g]||0).toString())}),Se.value[0]=+p(n).minus(a)},Ze=X(()=>Se.value.length&&+Se.value[0]||0),Mt=async t=>{if(+Ze.value<+t)return J.value=!0,te(!0);J.value=!1},We=N(0),et=N(0),Fe=N(0),tt=async()=>{const{balanceOf:t}=Ke(q.MCOIN),o=await t();We.value=+o,et.value=+await Ke(q.FMCP).balanceOf(),Fe.value=+await Ke(q.USDT).balanceOf()},jt=async t=>{if(+We.value<+t)return J.value=!0,te(!0);J.value=!1},qt=N(null),ye=N(0),ot=()=>{var t,o;F(!0);try{if(!L.value)return le(V("order.setAddress")),!1;if((t=L.value)!=null&&t.encryptFlag&&!((o=L.value)!=null&&o.success))return le(V("order.reconfirm the information")),!1;if(!To(L.value.telNumber))return le(V("address.number was identified")),!1}finally{F(!1)}return!0},st=async()=>{var n,i,P;let t=[],o=[],a=!1;if(D.value.forEach(v=>{v.ordersInfos.forEach(g=>{g.goodTypes===re.RECHARGE&&(+g.cardNo||(a=!0)),g.goods.forEach(A=>{if(A.number>A.stock&&+A.goodsTypes!=2){let R=A.goodsName;A.goodsName.length>10&&(R=A.goodsName.slice(0,10)+"..."),o.push(R)}t.push({goodsId:A.goodsId,num:A.number,payType:ge.MC,paySource:v.paySource})})})}),a)return F(!1),le(V("order.Please fill in your phone number")),!1;if(o.length>0)return F(!1),le(o.join()+"  "+V("order.Insufficient stock")),!1;try{const v=W.currentRoute.value.path,g=await pe("user",v);let A;g&&!L.value.encryptFlag&&(A=$(L.value,g),await Wo({...A,isDefault:L.value.isDefault?1:0}));let R=[];for(let Y=0;Y<D.value.length;Y++){const Q=D.value[Y];for(let M=0;M<Q.ordersInfos.length;M++){const m=Q.ordersInfos[M];let b=m.remark;if(+m.goodTypes===re.RECHARGE&&(b=V("order.phoneNumber")+String(m.cardNo).concat(m.isPortability===1?` ${V("order.Number Portabilit")} `:"").concat("，").concat(m.remark)),R.findIndex(c=>c.storeId===m.storeId)===-1){let c={};if(m.encryption){const I=await G(m.stores.id,(n=m.encryption)==null?void 0:n.publicKey);I?(c=C(c,{...L.value,postscript:b},1),c=$(c,I),c.submitHash=c.hash):c=C(c,{...L.value,postscript:b},0)}else c=C(c,{...L.value,postscript:b},0);R.push({storeId:m.storeId,...c})}}}return{type:((i=z==null?void 0:z.query)==null?void 0:i.type)??2,addressId:L.value.id,postscripts:R,detailList:t,genOrder:!0,voucherAmount:((P=w.value)==null?void 0:P.voucherAmount)||0}}catch{return!1}},Kt=async()=>{if(await ot()){if(F(!0),await tt(),await Xe(),await Ft(),J.value){F(!1);return}if(ee.value){F(!1);return}F(!0);try{const t=await st();if(!t)return;const o=await gt(t);if(!o.success){F(!1);return}const{allOrderId:a,merchants:n,discounts:i,amounts:P,sources:v}=o.data,g=await Be(a,n,i,P,v);if(!g.success){Fo({allOrderId:a}),setTimeout(()=>{W.push({path:"/buyerOrderList",query:{active:0},replace:!0})},1e3);return}if(le.loading({message:V("order.wait block chain"),forbidClick:!0,duration:0}),await Io({allOrderId:a,hash:g.result.hash}),le.clear(),qt.value=g.result.hash,!g.result.hash)return;let A;const R=async()=>{if(ye.value>=5){F(!1),xe(!0),ye.value=0;return}if(A=await Po(g.result.hash),(A==null?void 0:A.status)===1){F(!1),O(!0),ye.value=0,Jt();return}setTimeout(async()=>{ye.value++,R()},5e3)};R()}catch{F(!1),ye.value=0}finally{D.value.forEach((t,o)=>{var a;at.value[`paySwitch${o}`].setpayValue((a=t.paySource)==null?void 0:a.toString())})}}},at=N({}),zt=(t,o)=>{t&&(at.value[`paySwitch${o}`]=t)},Jt=()=>{setTimeout(()=>{O(!1),W.replace({path:"buyerOrderList",query:{active:1}})},1500)},Ie=N(1),Yt=async()=>{Ie.value=await Ne()},Ve=t=>{let o=0,a=0,n=0,i=0,P=0,v=0,g=0,A=0,R=0,ae=0,Y=et.value,Q=0,M=null;return(t||D.value).forEach(m=>{m.totalAmount=0,m.integral=0,m.totalNum=0,m.voucherAmount=0,m.pointFee=0,m.ordersInfos.forEach(b=>{b.fmGeneralActivity&&!M&&(M=b.fmGeneralActivity),b.totalAmount=0,b.integral=0,b.totalNum=0,b.voucherAmount=0,b.pointFee=0,b.goods.forEach(c=>{g+=+c.number;const I=+new p(c.price).times(c.number),ne=+new p(new p(c.price).times(c.number).minus(c.goodsActivityReduceAmount||0).times(m.paySource===S.WITHDRAW_POINTS&&c.balanceDiscountRatio||c.discountRatio)).div(100);Q=new p(Q).plus(c.goodsActivityReduceAmount||0).toNumber();const j=m.paySource===S.WITHDRAW_POINTS?Math.min(Y,c.goodsType>0?+new p(ne).times(.5):0):0,ce=[he.SL,he.PR].indexOf(c.goodsType)!==-1&&Number(c.discountRatio)>(c.goodsType===he.SL?9:19)||c.goodsType===he.ST?p(I).times(.5):0;o=+new p(o).plus(I),m.paySource===S.USDT_WALLET?(n=+new p(n).plus(new p(I).times(Ue.value)),a=+new p(a).plus(new p(I).minus(j||0).minus(c.goodsActivityReduceAmount||0).times(Ue.value)),R=+new p(R).plus(j)):(m.paySource!==S.PIGGY_BANK&&m.paySource!==S.WITHDRAW_POINTS&&(P=+new p(i).plus(I)),i=+new p(i).plus(I)),b.totalAmount=+new p(b.totalAmount).plus(I),m.totalAmount=+new p(m.totalAmount).plus(I),v=+new p(v).plus(ne),b.integral=+new p(b.integral).plus(ne),m.integral=+new p(m.integral).plus(ne),Y-=j,A+=j,c.voucherAmount=j,b.voucherAmount=+new p(b.voucherAmount).plus(j),m.voucherAmount=+new p(m.voucherAmount).plus(j),ae=+new p(ae).plus(ce),b.pointFee=+new p(b.pointFee).plus(ce),m.pointFee=+new p(m.pointFee).plus(ce),b.totalNum+=c.number,m.totalNum+=c.number})})}),{totalAmount:o,usdtAmount:a,originalUsdtAmount:n,mcAmount:i,integral:v,totalNum:g,voucherAmount:A,useVoucherAmount:R,pointFee:ae,approveMcAmount:P,activityReduceAmount:Q,fmGeneralActivity:M}},Ge=N(null),Qt=async()=>{Ge.value=await r()},Ue=X(()=>1/Ge.value),Xt=X(()=>{const t=new p(w.value.totalAmount).minus(w.value.activityReduceAmount||0).minus(w.value.voucherAmount||0);return x(t)}),{payBy:ie,payLink:He,payHelpRef:Me,changeBy:Zt,generatePayLink:eo,showChangeTip:nt}=Bo(),to=fo(async()=>{var t;if(ot()){F(!0);try{if(He.value){(t=Me.value)==null||t.setShow(!0);return}const o=await st();if(!o)return;eo(o)}finally{F(!1)}}},500),oo=async()=>{K(!0),Qe(),tt(),Yt(),Xe(),De(),await Qt(),await Ct(),await Je(),await Oe(),K(!1),Pt(!1)};mo(()=>{Je()});const so=t=>{W.push(t)};return wt(()=>{oo()}),(t,o)=>{const a=H("van-icon"),n=H("van-field"),i=H("van-dropdown-item"),P=H("van-dropdown-menu"),v=H("VanButton"),g=H("van-popup");return f(),U(Ro,{title:t.$t("order.order"),class:"h-full font-Puhui font-normal relative px-3",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent"}},{default:_(()=>{var A,R,ae,Y,Q,M,m,b,c,I,ne,j,ce,lt,rt,ut,it,ct;return[y(No,{tab:e(ie),onChangeTab:e(Zt)},null,8,["tab","onChangeTab"]),e(xt)?k("",!0):(f(),T("div",Os,[y(yo,{class:"mt-3",defaultAddress:L.value,onClick:o[0]||(o[0]=u=>so("/userAddress"))},null,8,["defaultAddress"]),(f(!0),T(Te,null,ft(D.value,(u,je)=>{var dt,mt,pt;return f(),T("div",{key:u.goodsBoutiqueFlag},[y(Oo,{goodsBoutiqueFlag:u.goodsBoutiqueFlag},null,8,["goodsBoutiqueFlag"]),(f(!0),T(Te,null,ft(u.ordersInfos,(B,ao)=>(f(),T("div",{key:ao,class:"bg-white rounded-xl p-3 mt-3"},[y(ho,{orderInfo:B,expressGoodsList:Ye.value,payType:B.payType,onChangeNumber:o[1]||(o[1]=(de,no)=>Et(de,no))},null,8,["orderInfo","expressGoodsList","payType"]),s("div",Ds,[s("div",Ws,l(t.$t("order.remark")),1),s("div",{class:"flex-1 flex items-center justify-end",onClick:de=>Lt(B)},[s("div",null,l(B.remark?B.remark:t.$t("order.noRemark")),1),y(a,{name:"arrow"})],8,Fs)]),+(B==null?void 0:B.goodTypes)===e(re).RECHARGE?(f(),T("div",Is,[s("div",Vs,[y(n,{style:{padding:"0 !important"},"input-align":"right",type:"digit",autocomplete:"off",modelValue:B.cardNo,"onUpdate:modelValue":de=>B.cardNo=de,placeholder:t.$t("shop.pleaseInput")},{label:_(()=>[s("div",Gs,l(`${t.$t("order.Phone number")}`),1)]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])]),s("div",Us,[y(n,{style:{padding:"0 !important"},"input-align":"right",autocomplete:"off",label:`${t.$t("order.Whether to port your number")}`},{label:_(()=>[s("div",Hs,l(`${t.$t("order.Whether to port your number")}`),1)]),input:_(()=>[y(P,{"active-color":"#FEA021"},{default:_(()=>[y(i,{modelValue:B.isPortability,"onUpdate:modelValue":de=>B.isPortability=de,options:e(Tt)},null,8,["modelValue","onUpdate:modelValue","options"])]),_:2},1024)]),_:2},1032,["label"])])])):k("",!0),e(ie)===e(ve).OWNER?(f(),T("div",Ms,[s("div",js,[s("div",qs,l(t.$t("order.total")),1),s("div",Ks,[s("div",zs,[B.totalAmount>0?(f(),T("span",Js,l(e(x)(B.totalAmount||0))+"Mcoin",1)):k("",!0)]),s("div",Ys,l(t.$t("order.getContribution",{num:e(x)(+new e(p)(B.integral).times(Ie.value||0))})),1)])])])):k("",!0)]))),128)),e(ie)===e(ve).OWNER?(f(),T(Te,{key:0},[s("div",Qs,[s("div",Xs,l(t.$t("order.priceDetail")),1),s("div",Zs,[s("div",ea,l(t.$t("order.sumtotal")),1),s("div",ta,[(u.paySource,e(S).WITHDRAW_POINTS,f(),T("div",oa,[(u==null?void 0:u.totalAmount)>0?(f(),T("div",sa,[aa,Z(" "+l(e(x)((u==null?void 0:u.totalAmount)||0)),1)])):k("",!0)])),s("div",na,l(t.$t("order.getContribution",{num:e(x)(+new e(p)(u==null?void 0:u.integral).times(Ie.value||0))})),1)])]),u.paySource===e(S).WITHDRAW_POINTS&&((dt=e(w))==null?void 0:dt.pointFee)>0?(f(),U(Mo,{key:0,num:u==null?void 0:u.totalNum,amount:u==null?void 0:u.totalAmount,fee:(mt=e(w))==null?void 0:mt.pointFee},null,8,["num","amount","fee"])):k("",!0)]),y(ms,{ref:B=>zt(B,je),boutique:u.goodsBoutiqueFlag,class:"bg-white mt-2.5 rounded-xl",checked:(pt=u.paySource)==null?void 0:pt.toString(),clickable:!e(se),"point-balance":Pe.value,"wallet-balance":We.value,piggyBalance:e(Ze),usdtBalance:Fe.value,payAmount:u==null?void 0:u.totalAmount,usdtRate:Ge.value,onOnChange:B=>Wt(B,u),onGetPointBalance:De},null,8,["boutique","checked","clickable","point-balance","wallet-balance","piggyBalance","usdtBalance","payAmount","usdtRate","onOnChange"])],64)):k("",!0)])}),128)),e(ie)===e(ve).OWNER?(f(),U(Ls,{key:0,totalPrice:(A=e(w))==null?void 0:A.mcAmount,"usdt-price":(R=e(w))==null?void 0:R.usdtAmount,"original-usdt-price":(ae=e(w))==null?void 0:ae.originalUsdtAmount,showTotalPrice:(Y=e(w))==null?void 0:Y.totalAmount,"voucher-price":(Q=e(w))==null?void 0:Q.voucherAmount,"use-voucher-amount":(M=e(w))==null?void 0:M.useVoucherAmount,"activity-reduce-amount":(m=e(w))==null?void 0:m.activityReduceAmount,"fm-general-activity":(b=e(w))==null?void 0:b.fmGeneralActivity,symbol:"Mcoin"},null,8,["totalPrice","usdt-price","original-usdt-price","showTotalPrice","voucher-price","use-voucher-amount","activity-reduce-amount","fm-general-activity"])):k("",!0),la,e(ie)===e(ve).OWNER?(f(),T("div",{key:1,class:po(["fixed bottom-0 sm:left-1/2 sm:-translate-x-2/4 left-0 z-20 sm:w-[375px] w-full bg-b6 px-3 py-4 safe-btn-bottom-bottom flex-center-bw border-t border-solid border-b5",e(E)?"!hidden":"!fixed"])},[s("div",ra,l(t.$t("order.quantity",{number:(c=e(w))==null?void 0:c.totalNum})),1),s("div",ua,[s("div",ia,[s("div",ca,[s("span",da,l(t.$t("order.sumtotal"))+":",1),ma,s("span",pa,l(e(x)(e(Xt))),1)]),(I=e(w))!=null&&I.voucherAmount?(f(),T("div",fa,[s("span",null,l(t.$t("voucher.deduction"))+":",1),ya,s("span",null,l(e(x)((ne=e(w))==null?void 0:ne.voucherAmount)),1)])):k("",!0)]),s("div",ha,[(j=e(w))!=null&&j.usdtAmount?(f(),U(ze,{key:0,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:e(q).order,token:e(q).USDT,symbol:"USDT",loading:e(se),approveAmount:Number((ce=e(w))==null?void 0:ce.usdtAmount)},null,8,["contract","token","loading","approveAmount"])):k("",!0),(lt=e(w))!=null&&lt.approveMcAmount?(f(),U(ze,{key:1,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:e(q).order,token:e(q).MCOIN,symbol:"mcoin",loading:e(se),approveAmount:Number((rt=e(w))==null?void 0:rt.approveMcAmount)},null,8,["contract","token","loading","approveAmount"])):k("",!0),(ut=e(w))!=null&&ut.voucherAmount?(f(),U(ze,{key:2,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:e(q).order,token:e(q).FMCP,symbol:t.$t("voucher.voucher"),loading:e(se),approveAmount:Number((it=e(w))==null?void 0:it.voucherAmount)},null,8,["contract","token","symbol","loading","approveAmount"])):k("",!0),y(v,{class:"bg-yellow text-b1 font-semibold w-[120px] h-[46px] rounded-full",loading:e(se),onClick:Kt},{default:_(()=>[Z(l(t.$t("common.pay")),1)]),_:1},8,["loading"])])])],2)):e(ie)===e(ve).OTHER?(f(),U(Eo,{key:2,"pay-link":e(He),"btn-loading":e(se),onOnClick:e(to)},null,8,["pay-link","btn-loading","onOnClick"])):k("",!0),y(g,{onClose:Ot,show:e(ue),"onUpdate:show":o[5]||(o[5]=u=>yt(ue)?ue.value=u:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:_(()=>[s("div",va,[s("div",ga,[Z(l(t.$t("order.submitOrder"))+" ",1),s("div",{class:"absolute right-0 bottom-[-2px]",onClick:o[2]||(o[2]=u=>e(oe)(!1))},[y(a,{name:"cross"})])]),y(n,{modelValue:fe.value.remark,"onUpdate:modelValue":o[3]||(o[3]=u=>fe.value.remark=u),rows:"4",autosize:"",type:"textarea",maxlength:"200",placeholder:t.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"]),y(v,{class:"mt-4 bg-btnOrBg w-full h-[46px] text-b1 rounded-full text-base font-semibold",onClick:o[4]||(o[4]=u=>e(oe)(!1))},{default:_(()=>[Z(l(t.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show"]),e(h)?(f(),U(ht,{key:3,onClose:o[6]||(o[6]=u=>e(O)(!1)),text:t.$t("common.pay success")},null,8,["text"])):k("",!0),e(Ee)?(f(),U(ht,{key:4,isError:!0,onClose:o[7]||(o[7]=u=>e(xe)(!1)),text:t.$t("order.fail")},null,8,["text"])):k("",!0),y(vo,{paySource:Dt.value,show:e(ee),onClose:o[8]||(o[8]=u=>e(te)(!1))},null,8,["paySource","show"])])),y(Lo,{ref:(u,je)=>{je.payHelpRef=u,yt(Me)&&(Me.value=u)},amount:(ct=e(w))==null?void 0:ct.totalAmount,link:e(He)},null,8,["amount","link"])]}),_:1},8,["title"])}}const wa=_e({...ba,setup:_a}),on=_t(wa,[["__scopeId","data-v-2f124ce2"]]);export{on as default};
