import{y as J,l as ee,E as Q,F as g,G as n,H as l,O as K,K as D,X as S,Q as A,I as V,a1 as re,P as B,Y as R,N as W,J as Z,_ as te,a2 as se,x as ae,r as d,bq as ne,D as le,bc as ue,a4 as Y,bd as ce,z as ie}from"./vendor-BlU_hoYl.js";import{C as de}from"./CommonVanProvider-CDfGVWR4.js";import{M as ve}from"./Map-C8PTqERL.js";import{O as fe}from"./OfflineMerchantLabel-BcDolHRH.js";import{e as X,av as pe,aM as he,aN as me,at as ge,au as ye}from"./index-Clz0Qna-.js";import{u as oe}from"./useCityMap-L2xSDWSa.js";import{_ as xe}from"./SearchBar-y7PfYxvJ.js";import"./BackIcon-8hcEjDKb.js";import"./iconAssets-DyRcdBzl.js";import"./localMark-D3Prsc6Q.js";import"./search-C4fLtTfY.js";import"./delete-BlDblrKv.js";const Ie={class:"shop-img w-[80px] h-[80px] rounded-lg overflow-hidden flex-shrink-0 relative"},Ce={class:"shop-content h-full ml-2 w-full"},_e={class:"w-full text-base text-b1 font-semibold flex items-center justify-between line-clamp-1"},be={class:"line-clamp-1"},Le={class:"text-sm text-b3 font-normal"},ke={class:"h-[20px] text-sm text-b3 font-normal mt-[18px] flex items-center justify-between"},we={class:"engagement"},Ae={key:0,class:"distance"},Fe=J({props:{storeInfo:{default:{}},backgroundColor:{default:"#fff"}},setup(r){const h=r,L=ee(),{cityMapStore:a}=X(),{distanceFormat:c}=oe(),N=()=>{L.push(`/city/poi/storefront?storeId=${h.storeInfo.storeId}&child=1`)};return(F,m)=>{var v,_,k,$,i,f,E;const C=Q("van-image");return n(),g("div",{class:"w-full h-[104px] rounded-xl p-3 mb-3 flex items-center justify-start",style:R({backgroundColor:r.backgroundColor}),onClick:N},[l("div",Ie,[K(C,{width:"80",height:"80",fit:"cover",src:r.storeInfo.storeIcons?r.storeInfo.storeIcons.split(",")[0]:""},null,8,["src"]),+r.storeInfo.storeGoodsCount>0?(n(),D(fe,{key:0})):S("",!0)]),l("div",Ce,[l("div",_e,[l("span",be,A(((v=r.storeInfo)==null?void 0:v.storeName)||""),1)]),l("div",Le,A(((_=r.storeInfo)==null?void 0:_.goodsCategoryName3)||"")+" "+A(((k=r.storeInfo)==null?void 0:k.areaExtName3)||""),1),l("div",ke,[l("span",we,[+(($=r.storeInfo)==null?void 0:$.wantCount)?(n(),g(V,{key:0},[re(A(r.storeInfo.wantCount)+"人想要 ",1)],64)):S("",!0)]),(i=B(a).locationCoords)!=null&&i.lng&&((f=B(a).locationCoords)!=null&&f.lat)?(n(),g("span",Ae,A(B(c)((E=r.storeInfo)==null?void 0:E.distance)),1)):S("",!0)])])],4)}}}),$e={class:"w-full h-full bg-[#F2F0EF] px-3 pt-3 overflow-y-scroll"},Ee={props:{storeList:{type:Array,default:()=>[]}},setup(r){return(h,L)=>{const a=Q("van-list");return n(),g("div",$e,[K(a,{"finished-text":"没有更多了"},{default:W(()=>[(n(!0),g(V,null,Z(r.storeList,c=>(n(),D(Fe,{key:c.id,"store-info":c,"background-color":"#fff"},null,8,["store-info"]))),128))]),_:1})])}}},Be=["onClick"],Ne={class:"mt-[-1px] pt-[1px] w-full h-fit max-h-[calc(100vh-50px-48px-32px)] overflow-y-scroll bg-white px-3"},qe=["onClick"],De=J({props:{modelValue:null},emits:["update:modelValue","change"],setup(r,{expose:h,emit:L}){var P,j,T;const a=se(),{cityMapStore:c}=X(),N=ae(()=>[{key:"goodsCategoryId1",label:v.value?F(C.value,v.value):"全部类型",isAct:m("goodsCategoryId1",v.value),loading:_.value},{key:"distance",label:f.value?F(i.value,f.value):"全部距离",isAct:m("distance",f.value)},{key:"areaIdLastLeaf",label:q.value?F(E.value,q.value):"全部区域",isAct:m("areaIdLastLeaf",q.value),loading:M.value}]),F=(o,y)=>{var w;return(w=o.find(s=>y==s.value))==null?void 0:w.label},m=(o,y)=>!!(e.value&&t.value===o)||y,C=d([]),v=d(((P=a.query)==null?void 0:P.categoryId)||null),_=d(!1),k=o=>{v.value=o},$=async()=>{var s,x;_.value=!0;const o={areaIdPreviousLastLeaf:((s=c.currentActiveCity)==null?void 0:s.areaId)||"3501",overseasFlag:((x=c.currentActiveCity)==null?void 0:x.overseasFlag)||!1},{success:y,data:w}=await pe(o);_.value=!1,y&&(C.value=w?w.map(I=>({value:I.goodsCategoryId,label:I.goodsCategoryName,...I})):[],C.value.unshift({value:null,label:"全部类型"}))},i=d([{value:null,label:"全部距离"},{value:500,label:"<500m"},{value:1e3,label:"<1km"},{value:2e3,label:"<2km"},{value:5e3,label:"<5km"}]),f=d(((j=a.query)==null?void 0:j.distance)||null),E=d([]),q=d(((T=a.query)==null?void 0:T.area)||null),M=d(!1),G=async()=>{M.value=!0;const{success:o,data:y}=await he();if(M.value=!1,!o)return;let s=me(y,{idKey:"areaId",parentKey:"areaParentId",childrenKey:"children",rootId:"0"}).find(I=>{var z;return((z=c.currentActiveCity)==null?void 0:z.areaParentId)==I.areaId}),x=s==null?void 0:s.children.find(I=>{var z;return((z=c.currentActiveCity)==null?void 0:z.areaId)==I.areaId});E.value=x!=null&&x.children?x==null?void 0:x.children.map(I=>({value:I.areaId,label:I.areaExtName,...I})):[],E.value.unshift({value:null,label:"全部区域"})},O=d(null),e=d(!1),t=d(""),u=d([]),p=o=>{if(t.value=="goodsCategoryId1")return v.value==o.value;if(t.value=="distance")return f.value==o.value;if(t.value=="areaIdLastLeaf")return q.value==o.value},b=o=>{if(t.value===o&&e.value){e.value=!1;return}t.value=o,e.value=!0,e.value&&(t.value=="goodsCategoryId1"?u.value=C.value:t.value=="distance"?u.value=i.value:t.value=="areaIdLastLeaf"&&(u.value=E.value))};ne(O,()=>e.value=!1);const U=o=>{var y,w;if(t.value=="goodsCategoryId1")v.value=o.value;else if(t.value=="distance")if((y=c.locationCoords)!=null&&y.lat&&((w=c.locationCoords)!=null&&w.lng))f.value=o.value;else{c.clearNoAuthErrorFlag(),c.setNoAuthError(),e.value=!1;return}else t.value=="areaIdLastLeaf"&&(q.value=o.value);e.value=!1,H(),L("change",t.value,o.value)},H=()=>{const o={goodsCategoryId1:v.value,distance:f.value,areaIdLastLeaf:q.value};L("update:modelValue",o)};return le(()=>{$(),G()}),h({setCategory1Act:k}),(o,y)=>{const w=Q("van-loading");return n(),g("div",{class:"relative flex items-center gap-[3px]",ref:(s,x)=>{x.selectBox=s,O.value=s}},[(n(!0),g(V,null,Z(B(N),(s,x)=>(n(),g("div",{class:"shrink-0 flex justify-center items-center",style:R(`width: calc(100% / ${B(N).length});`),onClick:Y(I=>s.loading?"":b(s.key),["stop"]),key:s.key},[s.loading?(n(),D(w,{key:0,size:"20px"})):(n(),g(V,{key:1},[l("div",{class:"text-sm text-[#585654] font-normal",style:R(s.isAct?"color: #ff8812":"")},A(s.label),5),l("div",{class:"trapezoid shrink-0 ml-1.5",style:R(s.isAct?"border-top: 4px solid #ff8812":"")},null,4)],64))],12,Be))),128)),ue(l("div",{class:"absolute top-[32px] z-[49] w-full h-[calc(100vh-50px-48px-32px)] bg-[rgba(0,0,0,0.5)]",onClick:y[0]||(y[0]=Y(s=>e.value=!1,["stop"]))},[l("div",Ne,[(n(!0),g(V,null,Z(u.value,(s,x)=>(n(),g("div",{class:"mb-3 w-full text-sm text-[#585654]",style:R(p(s)?"color:#FF8812;font-weight:600":""),key:s.value,onClick:Y(I=>U(s),["stop"])},A(s.label),13,qe))),128))])],512),[[ce,e.value]])],512)}}}),Me=te(De,[["__scopeId","data-v-277f8648"]]),Se={class:"w-full flex gap-2"},Ve={class:"shrink-0 w-[80px] h-[80px] rounded-lg overflow-hidden"},Oe=["src"],Pe={class:"w-full flex flex-col justify-between"},je={class:"shrink-0"},Te={class:"text-base text-b1 font-semibold line-clamp-1"},ze={class:"mt-1 text-b3 text-sm font-normal line-clamp-1"},Re={key:0,class:"w-full text-right text-b3 text-sm font-normal line-clamp-1"},Ke=J({props:{storeInfo:null},setup(r){const h=r,L=ee(),{distanceFormat:a}=oe(),{cityMapStore:c}=X(),N=ae(()=>{var m,C;return(m=h.storeInfo)!=null&&m.storeIcons?(C=h.storeInfo)==null?void 0:C.storeIcons.split(","):[]}),F=()=>{L.push(`/city/poi/storefront?storeId=${h.storeInfo.storeId}&child=1`)};return(m,C)=>{var v,_,k,$,i,f;return n(),g("div",{class:"w-full h-fit bg-white rounded-xl p-3 shadow-[0_0.5px_16px_0_rgba(0,0,0,0.16)]",onClick:F},[l("div",Se,[l("div",Ve,[l("img",{src:B(N)[0],alt:"shop",class:"w-full h-full object-cover"},null,8,Oe)]),l("div",Pe,[l("div",je,[l("div",Te,A(((v=r.storeInfo)==null?void 0:v.storeName)||""),1),l("div",ze,A(((_=r.storeInfo)==null?void 0:_.storeAddress)||""),1)]),(k=r.storeInfo)!=null&&k.distance&&(($=B(c).locationCoords)!=null&&$.lat)&&((i=B(c).locationCoords)!=null&&i.lng)?(n(),g("div",Re,A(B(a)((f=r.storeInfo)==null?void 0:f.distance)),1)):S("",!0)])])])}}}),Ge=te(Ke,[["__scopeId","data-v-4179efd8"]]),Ue={class:"h-[calc(100vh-50px)] w-full overflow-hidden"},He={class:"px-3 pb-3"},Je={class:"pb-3"},Qe={class:"h-[calc(100%-48px-32px)] bg-[#F2F0EF]"},Xe=J({setup(r){var M,G,O;const h=se(),L=ee(),{cityMapStore:a}=X(),{getUserLocation:c}=oe(),N=d(null),F=d(!1),m=d(h.query.mode||"map"),C=()=>{m.value=m.value==="map"?"list":"map",L.replace({query:{...h.query,mode:m.value}})},v=d({keyword:""}),_=()=>{f()},k=d({goodsCategoryId1:((M=h.query)==null?void 0:M.categoryId)||null,distance:((G=h.query)==null?void 0:G.distance)||null,areaIdLastLeaf:((O=h.query)==null?void 0:O.area)||null}),$=(e,t)=>{let u={...h.query};e==="goodsCategoryId1"&&(u.categoryId=t),e==="distance"&&(u.distance=t),e==="areaIdLastLeaf"&&(u.area=t),u=Object.fromEntries(Object.entries(u).filter(([p,b])=>b)),L.replace({query:u}),f()},i=d([]),f=()=>{var u,p,b,U,H,P,j;F.value=!0;let e=[];(a.locationCoords.lat&&a.locationCoords.lng||(u=a.currentActiveCity)!=null&&u.areaLatitude&&((p=a.currentActiveCity)!=null&&p.areaLongitude))&&e.push("asc|distance");let t=e.length?e.join(","):null;ye({size:9999,storeNameLike:((b=v.value)==null?void 0:b.keyword)||null,areaIdPreviousLastLeaf:((U=a.currentActiveCity)==null?void 0:U.areaId)||"3501",overseasFlag:((H=a.currentActiveCity)==null?void 0:H.overseasFlag)||!1,longitude:a.locationCoords.lng||((P=a.currentActiveCity)==null?void 0:P.areaLongitude)||null,latitude:a.locationCoords.lat||((j=a.currentActiveCity)==null?void 0:j.areaLatitude)||null,sortBy:t,...k.value}).then(T=>{i.value=[],setTimeout(()=>{var o;i.value=((o=T.data)==null?void 0:o.records)||[]},50)}).catch(T=>{i.value=[]}).finally(()=>{F.value=!1})},E=e=>{L.push(e)},q=ae(()=>{var e,t,u;return{longitude:a.locationCoords.lng||((e=a.currentActiveCity)==null?void 0:e.areaLongitude)||null,latitude:a.locationCoords.lat||((t=a.currentActiveCity)==null?void 0:t.areaLatitude)||null,areaIdPreviousLastLeaf:((u=a.currentActiveCity)==null?void 0:u.areaId)||""}});return ie(()=>q.value,(e,t)=>{e!=null&&e.areaIdPreviousLastLeaf&&f()},{immediate:!0,deep:!0}),le(async()=>{var e,t;a.currentActiveCity?(e=a.locationCoords)!=null&&e.lat&&((t=a.locationCoords)!=null&&t.lng)||a.setNoAuthError():await c()}),(e,t)=>{const u=Q("router-view");return n(),D(de,{title:"城市地图",class:"bg-white font-Puhui font-normal relative","theme-vars":{"field-placeholder-text-color":"#A6A6A6"},ref:(p,b)=>{b.searchRef=p}},{right:W(()=>[l("div",{class:"text-sm font-normal text-b2",onClick:C},A(m.value==="map"?"列表模式":"地图模式"),1)]),default:W(()=>[l("div",Ue,[l("div",He,[K(xe,{modelValue:v.value.keyword,"onUpdate:modelValue":t[0]||(t[0]=p=>v.value.keyword=p),placeholder:"请输入店铺名称","search-button-text":"搜索",onSearch:_,onClear:_},null,8,["modelValue"])]),l("div",Je,[K(Me,{modelValue:k.value,"onUpdate:modelValue":t[1]||(t[1]=p=>k.value=p),onChange:$,ref:(p,b)=>{b.storeFilterRef=p,N.value=p}},null,8,["modelValue"])]),l("section",Qe,[i.value&&i.value.length===0&&!F.value?(n(),D(ge,{key:0,class:"!bg-transparent",name:"暂无门店"})):S("",!0),m.value==="map"?(n(),g(V,{key:1},[i.value&&i.value.length>0?(n(),D(ve,{key:0,storeList:i.value,storeComponent:Ge,ref:(p,b)=>{b.mapRef=p},onHandleTo:E},null,8,["storeList"])):S("",!0)],64)):(n(),D(Ee,{key:2,storeList:i.value},null,8,["storeList"]))])]),K(u,{class:"child-view"})]),_:1},512)}}}),ct=te(Xe,[["__scopeId","data-v-2b788b76"]]);export{ct as default};
