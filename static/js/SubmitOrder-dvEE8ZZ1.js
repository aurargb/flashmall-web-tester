import{_ as Z}from"./MCOIN-BOqZVkND.js";import{_ as We}from"./FMCP-yoa9RTPy.js";import{y as ve,F as b,G as u,H as s,X as p,Q as n,P as e,a1 as G,I as X,_ as gt,w as _t,a2 as wt,l as xt,bw as I,r as f,bM as At,x as A,B as W,z as Oe,bj as $t,D as kt,E as N,K as R,N as C,O as d,bN as Ve,R as St,a0 as Fe,T as k,Z as Pt,$ as Ct}from"./vendor-BlU_hoYl.js";import{_ as Tt}from"./AddressInfo-Cb8-Y8xf.js";import{_ as qe}from"./EmptyTipsPop-DGM583dh.js";import{_ as He}from"./USDT-CNsbs3BR.js";import{d as x,R as Rt,o as Lt,e as Bt,q as E,r as Dt,a2 as It,bA as Nt}from"./index-Wb-6_0W_.js";import{P as S,O as ce}from"./order-H59PKTFP.js";import{P as Et}from"./PaySwitchPop-DfhI_Zsr.js";import{C as Gt}from"./CommonVanProvider-CDfGVWR4.js";import{u as Ot,_ as Vt,P as Ft}from"./usePayHelp-ClOggRf8.js";import{_ as qt}from"./PayHelpSelector-BYbir5-o.js";import{O as Mt}from"./OrderGoodsBox-B4N-YG57.js";import{q as Ut,c as Wt}from"./address-DTgVu07X.js";import{q as Ht}from"./goods-WNmbNX2m.js";import{m as Me,p as jt,r as zt,t as Kt,u as Qt}from"./order-pJoL_MtT.js";import{a as Xt,u as Zt}from"./useSelectAddress-CgNt0r_o.js";import{G as me}from"./goods-BVwS8oFG.js";import{_ as fe}from"./SubmitApprove-Ccyw2aJS.js";import{S as Jt}from"./shop-CeqcS6K2.js";import{u as Yt}from"./useKeyboard-C7Jit2jF.js";import{P as Ue}from"./payHelp-DUMXKXfC.js";import{u as eo}from"./usePaymentBalance-CXnJQxd2.js";import{P as to}from"./PaymentMethodSelector-D1-7ZchS.js";import"./BackIcon-8hcEjDKb.js";import"./mall-C69gPh5W.js";import"./OrderGoods-BQbKo4MD.js";import"./BoutiqueLable-negN2DKs.js";import"./flashSale-DDyqLyYN.js";import"./ShopMaskTips-CxJi-SfW.js";import"./enums-DlE-aiss.js";import"./piggyBank-DN4hNkWq.js";import"./point-arrow-BXwQ0Ukh.js";import"./usePointRelase-Bhif5Y_O.js";const oo={class:"bg-white mt-3 p-3 rounded-xl"},so={class:"text-base font-semibold"},ao={class:"flex items-start justify-between mt-3"},no={class:"text-b3"},lo={class:"text-right"},ro={key:0,class:"flex items-center justify-end gap-1 font-semibold"},uo=s("img",{src:He,class:"w-4 h-4"},null,-1),io={key:1,class:"flex items-center justify-end gap-1 font-semibold"},co=s("img",{src:Z,class:"w-4 h-4"},null,-1),mo={key:0,class:"actPrice flex items-baseline justify-between mt-3"},fo={class:"text-b3 max-w-[100px] line-clamp-1"},vo={class:"text-right flex items-center justify-end gap-1"},po=G(" -"),yo=s("img",{src:Z,class:"w-4 h-4"},null,-1),ho=s("div",{class:"w-full h-[1px] bg-[#F6F6F5] my-3"},null,-1),bo={class:"flex items-center justify-between"},go={class:"text-b3"},_o={class:"gap-1 text-right flex-center text-b1 font-semibold"},wo=s("img",{src:He,class:"w-4 h-4"},null,-1),xo=s("span",{class:"text-b3"},"(",-1),Ao=s("img",{src:Z,class:"w-4 h-4"},null,-1),$o={key:1,class:"text-b3"},ko=G("+ "),So=s("img",{src:We,class:"w-4 h-4"},null,-1),Po={key:1,class:"text-xs text-b3 text-right"},Co=ve({props:{paySource:null,totalAmount:null,usdtAmount:null,voucherAmount:null,symbol:null,activityReduceAmount:null,fmGeneralActivity:null,actualAmount:null},setup(r){return(L,pe)=>{var O;return u(),b("div",oo,[s("div",so,n(L.$t("order.totalPriceDetail")),1),s("div",ao,[s("div",no,n(L.$t("order.goodsPrice")),1),s("div",lo,[r.paySource===e(S).USDT_WALLET?(u(),b("div",ro,[uo,s("span",null,n(e(x)(r.usdtAmount||0)),1)])):(u(),b("div",io,[co,s("span",null,n(e(x)(r.totalAmount||0)),1)]))])]),r.activityReduceAmount&&r.fmGeneralActivity?(u(),b("div",mo,[s("div",fo,n((O=r.fmGeneralActivity)==null?void 0:O.name),1),s("div",vo,[po,yo,s("span",null,n(e(x)(r.activityReduceAmount)),1)])])):p("",!0),ho,s("div",bo,[s("div",go,n(L.$t("common.actual_payment")),1),s("div",_o,[r.usdtAmount>0?(u(),b(X,{key:0},[wo,s("span",null,n(e(x)(r.usdtAmount||0)),1),xo],64)):p("",!0),Ao,s("span",null,n(e(x)(r.actualAmount)),1),r.usdtAmount>0?(u(),b("span",$o,")")):p("",!0),r.voucherAmount?(u(),b(X,{key:2},[ko,So,G(n(e(x)(r.voucherAmount)),1)],64)):p("",!0)])]),r.usdtAmount>0?(u(),b("div",Po,n(`(${e(x)(r.usdtAmount||0)} USDT${L.$t("offline.auto_exchange")} ${r.actualAmount||0} MCOIN)`),1)):p("",!0)])}}}),J=r=>(Pt("data-v-2dfea2c3"),r=r(),Ct(),r),To={key:0,class:"page-body mt-3 overflow-y-auto"},Ro={class:"bg-white rounded-xl p-3 mt-3"},Lo={class:"mt-3 flex items-center justify-between gap-2"},Bo={class:"flex-1 text-b3"},Do={class:"text-b1 text-right line-clamp-1"},Io={key:0},No={class:"bg-white overflow-hidden mt-3 py-3 border-y border-b5 border-solid"},Eo={class:"text-b3"},Go={class:"bg-white myinput overflow-hidden py-3"},Oo={class:"text-b3"},Vo={class:"bg-white my-3 rounded-xl p-3"},Fo={class:"text-base font-semibold"},qo={class:"flex items-baseline justify-between"},Mo={class:"text-b3 whitespace-nowrap"},Uo={class:"text-right"},Wo={class:"text-base font-semibold"},Ho={class:"text-b3 text-right mt-1"},jo=J(()=>s("div",{class:"h-5"},null,-1)),zo={class:"text-left text-sm text-b3"},Ko={class:"flex-center gap-3"},Qo={class:"flex-end gap-1 font-bold text-base"},Xo=J(()=>s("img",{src:Z,class:"w-4 h-4"},null,-1)),Zo=J(()=>s("span",null,"+",-1)),Jo=J(()=>s("img",{src:We,class:"w-4 h-4"},null,-1)),Yo={class:"relative"},es={class:"p-3 pb-10 remark"},ts={class:"relative text-center text-lg font-bold mb-3"},os=ve({name:"SubmitOrder"});function ss(r){const{isKeyboardVisible:L}=Yt(),{getUserDhKey:pe,encryptAddressKey:O,formatAddressData:ye,generateKey:he,decryptAddressKey:je}=Rt(),{t:g}=_t(),{loadingToggle:be}=Dt(),{getAddress:ge,setAddress:_e}=Zt(),{getRemark:we,setRemark:xe}=Xt(),{submit:ze}=Lt(),H=wt(),V=xt(),[Ke,Y]=I(!1),[ee,te]=I(!1),[Qe,Ae]=I(!0),[B,h]=I(!1),[Xe,$e]=I(!1),[Ze,ke]=I(!1),oe=f([]),v=f(),i=f(),Se=f(),j=f(""),se=f(0),P=f(""),_=At("number",1),Pe=f([]),z=A(()=>{var t,o;return Number((o=(t=i.value)==null?void 0:t.goods)==null?void 0:o.type)!==Jt.SD}),{balanceState:F,paymentOptions:Je,fetchAllBalances:Ce,autoSelectPaymentMethod:Ye,checkSufficientBalance:et}=eo(z),tt=A(()=>[{value:0,text:g("common.no")},{value:1,text:g("common.yes")}]),ae=A(()=>{const t=De.value,o=D.value,l=t==null?void 0:t.fullAmount;return t&&typeof l=="number"&&typeof o=="number"&&o>=l&&t.reduceAmouint||0}),K=A(()=>new W(D.value).minus(ae.value||0).minus(T.value||0).toNumber()),ot=t=>{xe(t)},st=()=>{if(we()){P.value=we(),_e(null);return}},c=f(S.WALLET),q=t=>{B.value||(c.value=t)},D=A(()=>{var t;return+new W(x((t=i.value)==null?void 0:t.goods.price)).times(_.value||1)}),ne=A(()=>D.value-ae.value),Te=A(()=>c.value===S.USDT_WALLET?W(ne.value).dividedBy(F.usdtRate).toString():0);Oe(z,()=>{z.value?q(S.WITHDRAW_POINTS):q(S.WALLET)},{immediate:!0});const Re=A(()=>new W(i.value.goods.discountRatio).times(ne.value||0).times(F.pointSelfRate).div(100).toString()),Le=A(()=>Math.min(F.voucherBalance,new W(Re.value).div(F.pointSelfRate).times(.5).toNumber())),T=A(()=>c.value===S.WITHDRAW_POINTS?Le.value:0),at=async()=>{if(ge()){v.value=ge(),_e(null);return}const t=V.currentRoute.value.path,o=await Ut();if(!o.success)return;oe.value=o.data;const l=oe.value.find(w=>w.isDefault===1)||oe.value[0],m=await he("user",t);if(l!=null&&l.encryptFlag&&m){v.value=je(l,m);return}v.value=l},Be=f(null),De=f(null),nt=async()=>{var o,l;const t=await Ht(+H.query.id);t.success&&(i.value=t.data,Se.value=t.data.fmStoredCard,Be.value=t.data.fmGeneralActivity||null,De.value=t.data.fmGeneralActivityRule||null,(l=(o=t.data)==null?void 0:o.fmGeneralActivityGoods)!=null&&l.activityPrice&&(i.value.goods.price=t.data.fmGeneralActivityGoods.activityPrice))},le=f(!1),lt=t=>{let o=i.value.fmGeneralActivityGoods;o&&t>+(o==null?void 0:o.activityStock)?(le.value||k("当前加购超出活动库存将恢复原价"),le.value=!0):le.value=!1,t<1?_.value=1:_.value=t,Ie()},Ie=async()=>{var m,w;let t=[];t.push({goodsId:i.value.goods.id,num:_.value,payType:ce.MC,paySource:c.value});const o={type:((m=H==null?void 0:H.query)==null?void 0:m.type)??2,addressId:(w=v.value)==null?void 0:w.id,detailList:t,genOrder:!1},l=await Me(o);l.success&&(Pe.value=l.data.goodsList||[])},Ne=()=>{var t,o;h(!0);try{if(!v.value)return k(g("order.setAddress")),!1;if(+i.value.goods.goodsTypes===me.RECHARGE&&!+j.value)return k(g("order.Please fill in your phone number")),!1;if(i.value.goods.stock<+_.value&&+i.value.goods.goodsTypes!=2)return k(g("order.Insufficient stock")),!1;if((t=v.value)!=null&&t.encryptFlag&&!((o=v.value)!=null&&o.success))return k(g("order.reconfirm the information")),!1;if(!It(v.value.telNumber))return k(g("address.number was identified")),!1}finally{h(!1)}return!0},rt=Ve(async()=>{if(await Ne()){if(h(!0),!et(c.value,K.value))return h(!1),$e(!0);dt()}},500),ut=f(null),M=f(0),it=f(null),Ee=async()=>{try{const t=V.currentRoute.value.path;await jt({goodsId:i.value.goods.id,number:_.value}),await zt({type:1});let o=P.value;+i.value.goods.goodsTypes===me.RECHARGE&&(o=g("order.phoneNumber")+String(j.value).concat(se.value===1?` ${g("order.Number Portabilit")} `:"").concat("，").concat(P.value));const l=await pe(i.value.stores.id),m=await he("user",t);let w;m&&!v.value.encryptFlag&&(w=O(v.value,m),await Wt({...w,isDefault:v.value.isDefault?1:0}));let y={};return l?(y=ye(y,{...v.value,postscript:o},1),y=O(y,l),y.submitHash=y.hash):y=ye(y,{...v.value,postscript:o},0),{type:1,postscripts:[{storeId:i.value.stores.id,...y}],detailList:[{goodsId:i.value.goods.id,num:_.value,payType:ce.MC,paySource:c.value}],voucherAmount:T.value||0}}catch{return!1}},dt=async()=>{var t;h(!0);try{const o=await Ee();if(!o)return;const l=await Me(o);if(!l.success){h(!1);return}const{allOrderId:m,merchants:w,discounts:y,amounts:U,sources:de}=l.data;try{const $=await ze(m,w,y,U,de);if(!$.success){Kt({allOrderId:m}),$.result.reason==="execution reverted: ERC20: transfer amount exceeds balance"&&k(g("errorMsg.transfer amount exceeds balance")),setTimeout(()=>{V.push({path:"/buyerOrderList",query:{active:0},replace:!0})},1e3);return}if(k.loading({message:g("order.wait block chain"),forbidClick:!0,duration:0}),await Qt({allOrderId:m,hash:$.result.hash}),k.clear(),ut.value=$.result.hash,!$.result.hash)return;let a;const Q=async()=>{if(M.value>=5){h(!1),ke(!0),M.value=0;return}if(a=await Nt($.result.hash),(a==null?void 0:a.status)===1){console.log("hash 查询 成功",a),Y(!0),M.value=0,ct(),h(!1);return}setTimeout(async()=>{M.value++,Q()},5e3)};Q()}catch{M.value=0,h(!1)}}catch{h(!1)}finally{(t=it.value)==null||t.setpayValue(c==null?void 0:c.value.toString())}},ct=()=>{setTimeout(()=>{Y(!1),V.replace({path:"buyerOrderList",query:{active:1,type:1}})},1500)},{payBy:re,payLink:ue,payHelpRef:ie,changeBy:mt,generatePayLink:ft,showChangeTip:vt}=Ot(),pt=Ve(async()=>{var t;if(Ne()){h(!0);try{if(ue.value){(t=ie.value)==null||t.setShow(!0);return}const o=await Ee();if(!o)return;ft(o)}finally{h(!1)}}},500);Oe([_,P],()=>{vt()});const{accountStore:yt}=Bt(),ht=async()=>{if(yt.isLogin){be(!0),Ae(!0);try{await Promise.all([at(),nt(),Ce(),st()]),Ie();const t=Ye(K.value,Le.value);q(t)}catch(t){console.error("Failed to initialize payment method:",t)}finally{be(!1),Ae(!1)}}},Ge=f(!0),bt=t=>{Ge.value=!1,V.push(t)};return $t(()=>{Ge.value&&xe("")}),kt(()=>{_.value=1,ht()}),(t,o)=>{const l=N("van-icon"),m=N("van-field"),w=N("van-dropdown-item"),y=N("van-dropdown-menu"),U=N("VanButton"),de=N("VanPopup");return u(),R(Gt,{title:t.$t("order.order"),class:"h-full font-Puhui font-normal relative px-3",style:{background:"linear-gradient(180deg, #fed73a 0%, #f2f0ef 50%)"},themeVars:{navBarBackgroundColor:"transparent"}},{default:C(()=>{var $;return[d(Vt,{tab:e(re),onChangeTab:e(mt)},null,8,["tab","onChangeTab"]),e(Qe)?p("",!0):(u(),b("div",To,[d(Tt,{defaultAddress:v.value,onClick:o[0]||(o[0]=a=>bt("/userAddress"))},null,8,["defaultAddress"]),s("div",Ro,[d(Mt,{orderInfo:i.value,number:e(_),payType:e(ce).MC,card:Se.value,expressGoodsList:Pe.value,onChangeNumber:lt},null,8,["orderInfo","number","payType","card","expressGoodsList"]),s("div",Lo,[s("div",Bo,n(t.$t("order.remark")),1),s("div",{class:"flex-1 flex items-center justify-end",onClick:o[1]||(o[1]=a=>e(te)(!0))},[s("div",Do,n(P.value?P.value:t.$t("order.noRemark")),1),d(l,{name:"arrow"})])]),+(($=i.value.goods)==null?void 0:$.goodsTypes)===e(me).RECHARGE?(u(),b("div",Io,[s("div",No,[d(m,{style:{padding:"0 !important"},"input-align":"right",type:"digit",autocomplete:"off",modelValue:j.value,"onUpdate:modelValue":o[2]||(o[2]=a=>j.value=a),placeholder:t.$t("shop.pleaseInput")},{label:C(()=>[s("div",Eo,n(`${t.$t("order.Phone number")}`),1)]),_:1},8,["modelValue","placeholder"])]),s("div",Go,[d(m,{style:{padding:"0 !important"},"input-align":"right",autocomplete:"off",label:`${t.$t("order.Whether to port your number")}`},{label:C(()=>[s("div",Oo,n(`${t.$t("order.Whether to port your number")}`),1)]),input:C(()=>[d(y,{"active-color":"#FEA021"},{default:C(()=>[d(w,{modelValue:se.value,"onUpdate:modelValue":o[3]||(o[3]=a=>se.value=a),options:e(tt)},null,8,["modelValue","options"])]),_:1})]),_:1},8,["label"])])])):p("",!0)]),e(re)===e(Ue).OWNER?(u(),b(X,{key:0},[s("div",Vo,[s("div",Fo,n(t.$t("order.priceDetail")),1),s("div",qo,[s("div",Mo,n(t.$t("order.total")),1),s("div",Uo,[s("div",Wo,n(e(x)(e(D)))+"MCOIN ",1)])]),s("div",Ho,n(t.$t("order.getContribution",{num:e(Re)})),1)]),d(to,{modelValue:c.value,"onUpdate:modelValue":o[4]||(o[4]=a=>c.value=a),"payment-options":e(Je),loading:e(F).loading,boutique:e(z),onChange:q,onGetPointBalance:e(Ce)},null,8,["modelValue","payment-options","loading","boutique","onGetPointBalance"]),d(Co,{"pay-source":c.value,"total-amount":e(D),"voucher-amount":e(T),"usdt-amount":e(Te),"actual-amount":e(K),symbol:c.value===e(S).USDT_WALLET?"USDT":"MCOIN","activity-reduce-amount":e(ae),"fm-general-activity":Be.value},null,8,["pay-source","total-amount","voucher-amount","usdt-amount","actual-amount","symbol","activity-reduce-amount","fm-general-activity"]),jo,s("div",{class:St(["fixed bottom-0 sm:left-1/2 sm:-translate-x-2/4 left-0 z-20 sm:w-[375px] w-full bg-b6 px-3 py-4 safe-btn-bottom-bottom flex-center-bw border-t border-solid border-b5",e(L)?"!hidden":"!fixed"])},[s("div",zo,[s("div",null,n(t.$t("order.quantity",{number:e(_)})),1),s("div",null,n(t.$t("order.sumtotal")),1)]),s("div",Ko,[s("div",Qo,[Xo,s("span",null,n(e(x)(e(K))),1),e(T)?(u(),b(X,{key:0},[Zo,Jo,s("span",null,n(e(x)(e(T))),1)],64)):p("",!0)]),s("div",Yo,[[e(S).WALLET].includes(c.value)?(u(),R(fe,{key:0,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:e(E).order,token:e(E).MCOIN,symbol:"MCOIN",loading:e(B),approveAmount:Number(e(ne))},null,8,["contract","token","loading","approveAmount"])):p("",!0),[e(S).USDT_WALLET].includes(c.value)?(u(),R(fe,{key:1,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:e(E).order,token:e(E).USDT,symbol:"USDT",loading:e(B),approveAmount:Number(e(Te))},null,8,["contract","token","loading","approveAmount"])):p("",!0),e(T)>0?(u(),R(fe,{key:2,class:"absolute bg-yellow text-b1 font-semibold w-[120px] h-[46px] z-10 rounded-full",contract:e(E).order,token:e(E).FMCP,symbol:t.$t("voucher.voucher"),loading:e(B),approveAmount:Number(e(T))},null,8,["contract","token","symbol","loading","approveAmount"])):p("",!0),d(U,{class:"bg-yellow text-b1 font-semibold w-[120px] h-[46px] rounded-full",loading:e(B),onClick:e(rt)},{default:C(()=>[G(n(t.$t("common.pay")),1)]),_:1},8,["loading","onClick"])])])],2)],64)):e(re)===e(Ue).OTHER?(u(),R(Ft,{key:1,"pay-link":e(ue),"btn-loading":e(B),onOnClick:e(pt)},null,8,["pay-link","btn-loading","onOnClick"])):p("",!0)])),d(de,{show:e(ee),"onUpdate:show":o[8]||(o[8]=a=>Fe(ee)?ee.value=a:null),position:"bottom",round:"",style:{"text-align":"center"}},{default:C(()=>[s("div",es,[s("div",ts,[G(n(t.$t("order.submitOrder"))+" ",1),s("div",{class:"absolute right-0 bottom-[-2px] text-lg",onClick:o[5]||(o[5]=a=>e(te)(!1))},[d(l,{name:"cross"})])]),d(m,{"onUpdate:modelValue":[ot,o[6]||(o[6]=a=>P.value=a)],modelValue:P.value,rows:"4",autosize:"",type:"textarea",maxlength:"200",placeholder:t.$t("order.remarkDes"),"show-word-limit":""},null,8,["modelValue","placeholder"]),d(U,{class:"mt-4 bg-btnOrBg w-full h-[46px] text-b1 rounded-full text-base font-semibold",onClick:o[7]||(o[7]=a=>e(te)(!1))},{default:C(()=>[G(n(t.$t("common.confirm")),1)]),_:1})])]),_:1},8,["show"]),e(Ke)?(u(),R(qe,{key:1,onClose:o[9]||(o[9]=a=>e(Y)(!1)),text:t.$t("common.pay success")},null,8,["text"])):p("",!0),e(Ze)?(u(),R(qe,{key:2,isError:!0,onClose:o[10]||(o[10]=a=>e(ke)(!1)),text:t.$t("order.fail")},null,8,["text"])):p("",!0),d(Et,{paySource:c.value,show:e(Xe),onClose:o[11]||(o[11]=a=>e($e)(!1)),onChangePay:o[12]||(o[12]=a=>q(a))},null,8,["paySource","show"]),d(qt,{ref:(a,Q)=>{Q.payHelpRef=a,Fe(ie)&&(ie.value=a)},amount:e(D),link:e(ue)},null,8,["amount","link"])]}),_:1},8,["title"])}}const as=ve({...os,setup:ss}),Vs=gt(as,[["__scopeId","data-v-2dfea2c3"]]);export{Vs as default};
